<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken ‚Äî Exec Sales Dashboard (with Date Range, PDF & Notes)</title>

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- flatpickr for date range picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Chart.js and plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- html2pdf (includes html2canvas & jsPDF) for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --brand-red: #d7263d;
      --brand-gold: #f2b705;
      --muted: #6b7280;
      --card-bg: #ffffff;
    }
    body { background: linear-gradient(180deg,#fbfbfc 0,#f1f5f9 100%); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#0b1220; }
    .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 6px 20px rgba(11,17,32,0.06); }
    .kpi { min-width: 12rem; }
    .small { font-size: 0.85rem; color:var(--muted); }
    .badge-up { color: #166534; background: rgba(16,185,129,0.08); padding:2px 8px; border-radius:999px; font-weight:600; }
    .badge-down { color: #7f1d1d; background: rgba(239,68,68,0.08); padding:2px 8px; border-radius:999px; font-weight:600; }

    .branch-card { transition: transform .18s ease, box-shadow .18s ease; cursor:pointer; }
    .branch-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(11,17,32,0.12); }
    .expandable .details { display:none; }
    .expandable.expanded .details { display:block; }

    .charts-grid { display:grid; grid-template-columns: repeat(1,1fr); gap:1rem; }
    @media (min-width: 900px) { .charts-grid { grid-template-columns: repeat(2,1fr); } }

    /* DataTable override */
    table.dataTable { width:100% !important; }

    /* Classes to hide UI controls from PDF export */
    .no-export { display: inline-block; }
    .pdf-export .no-export { display: none !important; }

    /* Slight adjustments for PDF */
    .pdf-export .card { box-shadow: none; border: 1px solid #e8e8e8; }
    .notes-area { width:100%; min-height:80px; border:1px solid #eee; border-radius:8px; padding:8px; resize:vertical; background:#fff; }
    .notes-save { font-size:0.85rem; padding: 6px 10px; border-radius:6px; background:var(--brand-red); color:white; border:none; cursor:pointer; }
  </style>
</head>
<body class="p-6">
  <!-- dashboard wrapper used by html2pdf -->
  <div id="dashboard" class="max-w-7xl mx-auto">

    <!-- HEADER -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <!-- Change this URL to your hosted logo if different -->
        <img src="https://crispychicken-uae.com/logo.png" alt="Crispy Chicken" style="height:64px;width:auto; border-radius:8px;" />
        <div>
          <h1 class="text-2xl font-bold" style="color:var(--brand-red)">Crispy Chicken ‚Äî Executive Sales Dashboard</h1>
          <div class="small">June ‚Äì September 2025 ¬∑ Board pack preview</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="card px-3 py-2 flex items-center gap-3 no-export">
          <label for="dateRange" class="small">Date range</label>
          <input id="dateRange" type="text" placeholder="Select date range" class="p-2 border rounded text-sm" style="min-width:200px;">
        </div>

        <button id="btnExportPDF" class="px-3 py-2 card text-sm font-semibold no-export" title="Export PDF">üìë Export PDF</button>
        <button id="btnExportCSV" class="px-3 py-2 card text-sm font-semibold no-export" title="Export CSV">‚¨áÔ∏è Export CSV</button>
        <button id="btnReset" class="px-3 py-2 card text-sm font-semibold no-export" title="Reset data">Reset</button>
      </div>
    </header>

    <!-- KPI CARDS -->
    <section class="kpi-row mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Total Sales</div>
            <div id="kpiSales" class="text-2xl font-bold" style="color:var(--brand-red)">‚Äî AED</div>
            <div class="small mt-1">Period total</div>
          </div>
          <div class="text-right">
            <div class="small">Growth</div>
            <div id="kpiSalesDelta" class="small badge-up">+0.0%</div>
          </div>
        </div>
      </div>

      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Total Orders</div>
            <div id="kpiOrders" class="text-2xl font-bold">‚Äî</div>
            <div class="small mt-1">Period total</div>
          </div>
          <div class="text-right">
            <div class="small">Avg Order Value</div>
            <div id="kpiAOV" class="small">‚Äî AED</div>
          </div>
        </div>
      </div>

      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Delivery % of Sales</div>
            <div id="kpiDeliveryShare" class="text-2xl font-bold">‚Äî %</div>
            <div class="small mt-1">Delivery contribution</div>
          </div>
          <div class="text-right">
            <div class="small">Delivery Orders</div>
            <div id="kpiDeliveryOrders" class="small">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Top Branch</div>
            <div id="kpiTopBranch" class="text-2xl font-bold" style="color:var(--brand-gold)">‚Äî</div>
            <div class="small mt-1">By sales</div>
          </div>
          <div class="text-right">
            <div class="small">Best Day</div>
            <div id="kpiPeakDay" class="small">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Branch Performance Cards -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3" style="color:var(--brand-red)">Branch Performance</h2>
      <div id="branches" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </section>

    <!-- Charts grid -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3" style="color:var(--brand-red)">Sales Analysis</h2>
      <div class="charts-grid">
        <div class="card p-4">
          <h3 class="font-semibold mb-2">Total Sales by Branch</h3>
          <canvas id="barChart" height="220"></canvas>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold mb-2">Daily Sales Trend</h3>
          <canvas id="lineChart" height="220"></canvas>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold mb-2">Sales Distribution</h3>
          <canvas id="pieChart" height="220"></canvas>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold mb-2">Delivery Sales Heatmap (by day)</h3>
          <canvas id="heatmapChart" height="220"></canvas>
        </div>
      </div>
    </section>

    <!-- Data Input and Table -->
    <section class="mb-6">
      <div class="flex flex-col lg:flex-row gap-4">
        <div class="card p-4 flex-1">
          <h3 class="font-semibold mb-2">Quick Data Input</h3>
          <textarea id="dataInput" class="w-full h-28 p-2 border rounded mb-2" placeholder="Paste CSV rows: Date,Outlet,Orders,Sales,DeliveryOrders,DeliverySales"></textarea>
          <div class="flex gap-2">
            <button id="btnUpdate" class="px-3 py-2 bg-red-600 text-white rounded no-export">Update Data</button>
            <button id="btnClearInput" class="px-3 py-2 border rounded no-export">Clear</button>
            <div class="small self-center ml-auto text-gray-500">Tip: Use YYYY-MM-DD dates</div>
          </div>
        </div>

        <div class="card p-4 flex-1">
          <h3 class="font-semibold mb-2">Raw Data (drill-down)</h3>
          <table id="dataTable" class="display w-full">
            <thead>
              <tr>
                <th>Date</th>
                <th>Outlet</th>
                <th>Orders</th>
                <th>Sales (AED)</th>
                <th>Delivery Orders</th>
                <th>Delivery Sales (AED)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="text-sm text-gray-500 mt-6">
      Last updated: <span id="lastUpdated">‚Äî</span> ¬∑ Prepared for Top Management ‚Äî Crispy Chicken
    </footer>
  </div>

  <!-- SCRIPT -->
  <script>
    // Register Chart plugins
    Chart.register(ChartDataLabels, window.ChartAnnotationPlugin || { id: 'annotation' });

    // Branch names (keeps your structure)
    const branches = ['Hamdan','Shabiya','Khalidiyah','Muroor','Barsha','Satwa'];

    // Provided totals for Sep 2025 (as before)
    const totals = {
      'Hamdan': { orders: 1955, sales: 87291.6, deliveryOrders: 983, deliverySales: 43645.9 },
      'Shabiya': { orders: 1124, sales: 52819.6, deliveryOrders: 567, deliverySales: 26410.0 },
      'Khalidiyah': { orders: 1004, sales: 48640.5, deliveryOrders: 508, deliverySales: 24320.5 },
      'Muroor': { orders: 921, sales: 45196.4, deliveryOrders: 466, deliverySales: 22598.4 },
      'Barsha': { orders: 763, sales: 37618.7, deliveryOrders: 387, deliverySales: 18809.4 },
      'Satwa': { orders: 426, sales: 20079.0, deliveryOrders: 219, deliverySales: 10039.5 }
    };

    // Build salesData: Sep 1-24 (accurate totals) + dummy Jun-Aug
    let salesData = [];
    (function createSepData(){
      // push daily approximations for Sep 1..24
      for (let day=1; day<=24; day++){
        const date = `2025-09-${String(day).padStart(2,'0')}`;
        branches.forEach(branch=>{
          const dailyOrders = Math.round(totals[branch].orders / 24);
          const dailySales = parseFloat((totals[branch].sales / 24).toFixed(1));
          const dailyDelOrders = Math.round(totals[branch].deliveryOrders / 24);
          const dailyDelSales = parseFloat((totals[branch].deliverySales / 24).toFixed(1));
          salesData.push({ date, outlet: branch, count: dailyOrders, total: dailySales, deliveryOrders: dailyDelOrders, deliverySales: dailyDelSales });
        });
      }
      // adjust last occurrence for each branch (so totals exactly match)
      branches.forEach(branch=>{
        // find last index for this branch in Sep
        let lastIdx = -1;
        for (let i = salesData.length - 1; i >= 0; i--) {
          if (salesData[i].outlet === branch && salesData[i].date.startsWith('2025-09-')) { lastIdx = i; break; }
        }
        if (lastIdx >= 0) {
          const branchRows = salesData.filter(r => r.outlet === branch && r.date.startsWith('2025-09-'));
          const sumOrders = branchRows.reduce((s,r)=>s+r.count,0);
          const sumSales  = branchRows.reduce((s,r)=>s+r.total,0);
          const sumDOrders = branchRows.reduce((s,r)=>s+r.deliveryOrders,0);
          const sumDSales = branchRows.reduce((s,r)=>s+r.deliverySales,0);
          salesData[lastIdx].count += totals[branch].orders - sumOrders;
          salesData[lastIdx].total = parseFloat((salesData[lastIdx].total + (totals[branch].sales - sumSales)).toFixed(1));
          salesData[lastIdx].deliveryOrders += totals[branch].deliveryOrders - sumDOrders;
          salesData[lastIdx].deliverySales = parseFloat((salesData[lastIdx].deliverySales + (totals[branch].deliverySales - sumDSales)).toFixed(1));
        }
      }
    })();

    // function to generate dummy month blocks (same approach as earlier)
    function generateDummyData(month, days){
      const monthlyTotals = {
        '2025-06': [ {orders:1400,sales:56000,deliveryOrders:700,deliverySales:28000}, {orders:850,sales:34000,deliveryOrders:425,deliverySales:17000}, {orders:750,sales:33000,deliveryOrders:375,deliverySales:16500}, {orders:700,sales:30000,deliveryOrders:350,deliverySales:15000}, {orders:550,sales:20000,deliveryOrders:275,deliverySales:10000}, {orders:130,sales:5000,deliveryOrders:65,deliverySales:2500} ],
        '2025-07': [ {orders:1450,sales:58000,deliveryOrders:725,deliverySales:29000}, {orders:880,sales:35200,deliveryOrders:440,deliverySales:17600}, {orders:780,sales:34320,deliveryOrders:390,deliverySales:17160}, {orders:720,sales:31680,deliveryOrders:360,deliverySales:15840}, {orders:570,sales:21660,deliveryOrders:285,deliverySales:10830}, {orders:140,sales:5600,deliveryOrders:70,deliverySales:2800} ],
        '2025-08': [ {orders:1500,sales:60000,deliveryOrders:750,deliverySales:30000}, {orders:900,sales:36000,deliveryOrders:450,deliverySales:18000}, {orders:800,sales:35200,deliveryOrders:400,deliverySales:17600}, {orders:740,sales:32560,deliveryOrders:370,deliverySales:16280}, {orders:590,sales:22420,deliveryOrders:295,deliverySales:11210}, {orders:145,sales:5800,deliveryOrders:73,deliverySales:2900} ]
      };
      const arr=[];
      for (let d=1; d<=days; d++){
        const date = `${month}-${String(d).padStart(2,'0')}`;
        branches.forEach((br,i)=>{
          arr.push({
            date, outlet: br,
            count: Math.round(monthlyTotals[month][i].orders / days),
            total: parseFloat((monthlyTotals[month][i].sales / days).toFixed(1)),
            deliveryOrders: Math.round(monthlyTotals[month][i].deliveryOrders / days),
            deliverySales: parseFloat((monthlyTotals[month][i].deliverySales / days).toFixed(1))
          });
        });
      }
      return arr;
    }

    // append dummy months
    salesData = salesData.concat(generateDummyData('2025-06',30));
    salesData = salesData.concat(generateDummyData('2025-07',31));
    salesData = salesData.concat(generateDummyData('2025-08',31));

    // restore from localStorage if user previously edited data
    const saved = localStorage.getItem('salesData');
    if (saved) {
      try { salesData = JSON.parse(saved); } catch(e) { /* ignore parse error */ }
    }

    // global date filter (YYYY-MM-DD strings)
    let dateFilterStart = null;
    let dateFilterEnd = null;

    // DataTable ref and Chart refs
    let dataTable;
    let barChart, lineChart, pieChart, heatmapChart;

    // UTILITIES
    function formatAED(v){ return Number(v || 0).toLocaleString('en-AE', { maximumFractionDigits:1, minimumFractionDigits: 1 }) + ' AED'; }
    function formatNumber(v){ return Number(v || 0).toLocaleString('en-AE'); }
    function lastUpdatedText(){ document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-GB'); }

    // KPIs
    function calculateKPIs(filtered){
      const totalSales = filtered.reduce((s,r)=>s+(r.total||0),0);
      const totalOrders = filtered.reduce((s,r)=>s+(r.count||0),0);
      const deliverySales = filtered.reduce((s,r)=>s+(r.deliverySales||0),0);
      const deliveryOrders = filtered.reduce((s,r)=>s+(r.deliveryOrders||0),0);
      const aov = totalOrders ? totalSales/totalOrders : 0;
      const byBranch = {};
      filtered.forEach(r => { byBranch[r.outlet] = (byBranch[r.outlet]||0) + (r.total||0); });
      const topBranch = Object.entries(byBranch).sort((a,b)=>b[1]-a[1])[0] || ['‚Äî',0];
      const byDate = {};
      filtered.forEach(r=>{ byDate[r.date] = (byDate[r.date]||0) + (r.total||0); });
      const peak = Object.entries(byDate).sort((a,b)=>b[1]-a[1])[0] || ['‚Äî',0];
      return {
        totalSales, totalOrders, deliverySales, deliveryOrders, aov,
        topBranch: topBranch[0], topBranchSales: topBranch[1],
        peakDate: peak[0], peakValue: peak[1]
      };
    }

    // Render branch cards (with notes)
    function renderBranchCards(){
      const container = document.getElementById('branches');
      const filtered = filterByDate(salesData);
      const metrics = branches.map(branch => {
        const rows = filtered.filter(d=>d.outlet===branch);
        const totalOrders = rows.reduce((s,r)=>s+(r.count||0),0);
        const totalSales = rows.reduce((s,r)=>s+(r.total||0),0);
        const delOrders = rows.reduce((s,r)=>s+(r.deliveryOrders||0),0);
        const delSales = rows.reduce((s,r)=>s+(r.deliverySales||0),0);
        const avg = totalOrders ? (totalSales/totalOrders).toFixed(1) : 0;
        return { branch, totalOrders, totalSales, delOrders, delSales, avg };
      });

      container.innerHTML = metrics.map(m=>`
        <div class="branch-card card p-4 expandable" data-branch="${m.branch}">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h4 class="font-semibold text-lg" style="color:var(--brand-red)">${m.branch}</h4>
              <div class="small text-gray-500">${formatNumber(m.totalOrders)} Orders ¬∑ ${formatAED(m.totalSales)}</div>
            </div>
            <div class="text-right">
              <div class="small">Delivery</div>
              <div class="font-semibold">${formatNumber(m.delOrders)} ¬∑ ${formatAED(m.delSales)}</div>
              <div class="small mt-1">Avg ${m.avg} AED</div>
            </div>
          </div>

          <div class="details mt-3 small text-gray-600">
            <div class="mb-2"><strong>Peak & notes:</strong></div>
            <div class="mb-2">
              <textarea class="notes-area" data-branch="${m.branch}" placeholder="Manager notes, actions, commentary for ${m.branch}..."></textarea>
              <div class="mt-2">
                <button class="notes-save no-export" data-branch="${m.branch}">Save note</button>
                <button class="notes-clear no-export ml-2" data-branch="${m.branch}">Clear</button>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      attachNotesHandlers();
    }

    // attach autosave & buttons for notes
    function attachNotesHandlers(){
      const textareas = document.querySelectorAll('.notes-area');
      textareas.forEach(area=>{
        const branch = area.getAttribute('data-branch');
        const key = `branchNote_${branch}`;
        area.value = localStorage.getItem(key) || '';
        // debounce auto-save
        let t;
        area.addEventListener('input', () => {
          clearTimeout(t);
          t = setTimeout(()=> {
            localStorage.setItem(key, area.value);
          }, 700);
        });
      });

      // Save/clear buttons
      document.querySelectorAll('.notes-save').forEach(btn=>{
        btn.onclick = (e) => {
          const branch = btn.getAttribute('data-branch');
          const area = document.querySelector(`.notes-area[data-branch="${branch}"]`);
          localStorage.setItem(`branchNote_${branch}`, area.value);
          btn.textContent = 'Saved ‚úì';
          setTimeout(()=> btn.textContent = 'Save note', 1200);
        };
      });
      document.querySelectorAll('.notes-clear').forEach(btn=>{
        btn.onclick = (e) => {
          const branch = btn.getAttribute('data-branch');
          if (!confirm('Clear note for ' + branch + '?')) return;
          localStorage.removeItem(`branchNote_${branch}`);
          const area = document.querySelector(`.notes-area[data-branch="${branch}"]`);
          if (area) area.value = '';
        };
      });
    }

    // Filter salesData by global dateFilterStart/End; returns array
    function filterByDate(arr){
      if (!dateFilterStart && !dateFilterEnd) return arr.slice();
      const start = dateFilterStart ? new Date(dateFilterStart + 'T00:00:00') : null;
      const end   = dateFilterEnd   ? new Date(dateFilterEnd + 'T23:59:59') : null;
      return arr.filter(r => {
        if (!r.date) return false;
        const d = new Date(r.date + 'T00:00:00');
        if (start && d < start) return false;
        if (end && d > end) return false;
        return true;
      });
    }

    // Update charts and KPIs based on current dateFilter
    function updateChartsAndKPIs(){
      const filtered = filterByDate(salesData);

      // totals per branch
      const branchTotals = branches.map(b => filtered.filter(r=>r.outlet===b).reduce((s,r)=>s+(r.total||0),0));

      // daily labels
      const dates = Array.from(new Set(filtered.map(r=>r.date))).sort();
      const dailyTotals = dates.map(dt => filtered.filter(r=>r.date===dt).reduce((s,r)=>s+(r.total||0),0));

      // BAR
      if (barChart) barChart.destroy();
      const barCtx = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels: branches, datasets: [{ label: 'Sales', data: branchTotals, backgroundColor: branches.map(()=> 'rgba(215,38,61,0.85)'), borderColor: branches.map(()=> 'rgba(215,38,61,1)'), borderWidth: 1 }] },
        options: { plugins: { legend: { display: false }, title: { display: true, text: 'Total Sales by Branch' } }, scales: { y: { beginAtZero:true, title: { display:true, text: 'Sales (AED)' } } } }
      });

      // LINE
      if (lineChart) lineChart.destroy();
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: { labels: dates, datasets: [{ label: 'Daily Sales', data: dailyTotals, borderColor: 'rgba(242,183,5,1)', backgroundColor: 'rgba(242,183,5,0.12)', fill: true, tension: 0.3, pointRadius: 2 }] },
        options: { plugins: { legend: { display: false }, title: { display: true, text: 'Daily Sales Trend' } }, scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 10 } }, y: { beginAtZero:true, title: { display:true, text: 'Sales (AED)' } } } }
      });

      // PIE
      if (pieChart) pieChart.destroy();
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels: branches, datasets: [{ data: branchTotals, backgroundColor: ['#d7263d','#f29a2e','#7c3a9b','#ef476f','#66a61e','#f2b705'], borderColor: '#fff', borderWidth: 1 }] },
        options: { plugins: { title: { display: true, text: 'Sales Distribution (by Branch)' }, datalabels: { formatter: (v,ctx)=> { const sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); return sum? ((v/sum)*100).toFixed(1)+'%':''; } } } }
      });

      // HEATMAP (stacked by branch across dates)
      if (heatmapChart) heatmapChart.destroy();
      const heatCtx = document.getElementById('heatmapChart').getContext('2d');
      heatmapChart = new Chart(heatCtx, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: branches.map((br,i)=>({
            label: br,
            data: dates.map(dt => filtered.find(r=>r.date===dt && r.outlet===br)?.deliverySales || 0),
            stack: 'stack1',
            backgroundColor: `rgba(${[(30+i*30)%255, (100+i*20)%255, (150+i*10)%255].join(',')},0.7)`
          }))
        },
        options: { plugins: { title: { display: true, text: 'Delivery Sales by Branch (stacked by day)' }, legend: { position:'top' } }, scales: { y: { beginAtZero:true, title: { display:true, text: 'Delivery Sales (AED)' } }, x: { stacked: true }, yAxes: { stacked: true } } }
      });

      // Update KPI cards
      const k = calculateKPIs(filtered);
      document.getElementById('kpiSales').textContent = formatAED(k.totalSales);
      document.getElementById('kpiOrders').textContent = formatNumber(k.totalOrders);
      document.getElementById('kpiAOV').textContent = formatAED(k.aov);
      const deliveryShare = k.totalSales ? ((k.deliverySales / k.totalSales) * 100).toFixed(1) : 0;
      document.getElementById('kpiDeliveryShare').textContent = deliveryShare + ' %';
      document.getElementById('kpiDeliveryOrders').textContent = formatNumber(k.deliveryOrders);
      document.getElementById('kpiTopBranch').textContent = k.topBranch;
      document.getElementById('kpiPeakDay').textContent = k.peakDate !== '‚Äî' ? new Date(k.peakDate).toLocaleDateString('en-GB') + ' ¬∑ ' + formatAED(k.peakValue) : '‚Äî';

      // simple growth delta vs previous month window (best-effort)
      let prevStart = null, prevEnd = null;
      if (dateFilterStart && dateFilterEnd) {
        const s = new Date(dateFilterStart + 'T00:00:00'), e = new Date(dateFilterEnd + 'T23:59:59');
        const diffMs = e - s;
        prevEnd = new Date(s.getTime() - 86400000); // day before start
        prevStart = new Date(prevEnd.getTime() - diffMs);
        // format
        const prevStartStr = prevStart.toISOString().slice(0,10), prevEndStr = prevEnd.toISOString().slice(0,10);
        const prevSum = salesData.filter(d=>d.date && d.date >= prevStartStr && d.date <= prevEndStr).reduce((s,r)=>s+(r.total||0),0);
        const pct = prevSum ? (((k.totalSales - prevSum) / prevSum) * 100).toFixed(1) : '0.0';
        const el = document.getElementById('kpiSalesDelta');
        el.textContent = (pct > 0 ? '+' : '') + pct + '%';
        el.className = pct >= 0 ? 'small badge-up' : 'small badge-down';
      } else {
        document.getElementById('kpiSalesDelta').textContent = '‚Äî';
      }
    }

    // Initialize DataTable once
    function initTable(){
      dataTable = $('#dataTable').DataTable({
        data: salesData,
        columns: [
          { data: 'date', render: d => d ? new Date(d).toLocaleDateString('en-GB') : '' },
          { data: 'outlet' },
          { data: 'count' },
          { data: 'total', render: d => d ? Number(d).toLocaleString('en-AE', { minimumFractionDigits:1 }) + ' AED' : '' },
          { data: 'deliveryOrders' },
          { data: 'deliverySales', render: d => d ? Number(d).toLocaleString('en-AE', { minimumFractionDigits:1 }) + ' AED' : '' },
          { data: null, orderable:false, render: (data, type, row, meta) => `<div class="flex gap-2"><button onclick="editRow(${meta.row})" class="px-2 py-1 bg-yellow-400 rounded text-sm">Edit</button><button onclick="deleteRow(${meta.row})" class="px-2 py-1 bg-red-500 rounded text-sm text-white">Delete</button></div>` }
        ],
        pageLength: 8,
        order: [[0,'desc']],
        responsive: true
      });

      // DataTables custom filter (range) uses global dateFilterStart & dateFilterEnd
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        if (!dateFilterStart && !dateFilterEnd) return true;
        const rowDateStr = salesData[dataIndex] && salesData[dataIndex].date;
        if (!rowDateStr) return false;
        const rowDate = new Date(rowDateStr + 'T00:00:00');
        if (dateFilterStart) {
          const start = new Date(dateFilterStart + 'T00:00:00');
          if (rowDate < start) return false;
        }
        if (dateFilterEnd) {
          const end = new Date(dateFilterEnd + 'T23:59:59');
          if (rowDate > end) return false;
        }
        return true;
      });
    }

    // Edit & Delete row handlers
    function editRow(idx){
      const row = salesData[idx];
      const input = prompt('Edit row (Date,Outlet,Orders,Sales,DeliveryOrders,DeliverySales):', `${row.date},${row.outlet},${row.count},${row.total},${row.deliveryOrders},${row.deliverySales}`);
      if (!input) return;
      const parts = input.split(',');
      if (parts.length < 6) { alert('Incorrect format'); return; }
      salesData[idx] = {
        date: parts[0].trim(), outlet: parts[1].trim(),
        count: parseInt(parts[2]), total: parseFloat(parts[3]),
        deliveryOrders: parseInt(parts[4]), deliverySales: parseFloat(parts[5])
      };
      persistAndRefresh();
      alert('Row updated');
    }
    function deleteRow(idx){
      if (!confirm('Delete this row?')) return;
      salesData.splice(idx,1);
      persistAndRefresh();
      alert('Deleted');
    }

    // Persist & refresh UI
    function persistAndRefresh(){
      localStorage.setItem('salesData', JSON.stringify(salesData));
      dataTable.clear().rows.add(salesData).draw();
      renderBranchCards();
      updateChartsAndKPIs();
      lastUpdatedText();
    }

    // Quick input update
    document.getElementById('btnUpdate').addEventListener('click', ()=>{
      const raw = document.getElementById('dataInput').value.trim();
      if (!raw) { alert('Add rows first'); return; }
      try {
        const rows = raw.split('\n').map(r=>r.trim()).filter(Boolean).map(r=>{
          const p = r.split(',');
          return { date: p[0].trim(), outlet: p[1].trim(), count: parseInt(p[2]), total: parseFloat(p[3]), deliveryOrders: parseInt(p[4]), deliverySales: parseFloat(p[5]) };
        });
        salesData = salesData.concat(rows);
        document.getElementById('dataInput').value = '';
        persistAndRefresh();
        alert('Data added');
      } catch(e){ alert('Invalid format. Use Date,Outlet,Orders,Sales,DeliveryOrders,DeliverySales'); }
    });
    document.getElementById('btnClearInput').addEventListener('click', ()=> document.getElementById('dataInput').value = '');

    // Export CSV (keeps existing behavior)
    document.getElementById('btnExportCSV').addEventListener('click', ()=>{
      const header = ['Date,Outlet,Orders,Sales,DeliveryOrders,DeliverySales'];
      const rows = salesData.map(r => `${r.date},${r.outlet},${r.count},${r.total},${r.deliveryOrders},${r.deliverySales}`);
      const csv = header.concat(rows).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'crispy_sales_export.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // Reset
    document.getElementById('btnReset').addEventListener('click', ()=>{
      if (!confirm('Reset data to sample dataset? This will clear local edits.')) return;
      localStorage.removeItem('salesData');
      // remove branch notes too
      branches.forEach(b => localStorage.removeItem(`branchNote_${b}`));
      location.reload();
    });

    // Export PDF (board pack)
    document.getElementById('btnExportPDF').addEventListener('click', async ()=>{
      // Expand all branch details so notes appear in PDF
      document.querySelectorAll('.branch-card').forEach(c => c.classList.add('expanded'));
      // hide controls with .no-export
      document.body.classList.add('pdf-export');

      // Allow layout to settle
      await new Promise(r => setTimeout(r, 600));

      const element = document.getElementById('dashboard');
      const opt = {
        margin: 0.4,
        filename: 'CrispyChicken_BoardPack.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
      };

      // produce PDF
      html2pdf().set(opt).from(element).save()
        .then(() => {
          // revert UI
          document.body.classList.remove('pdf-export');
        })
        .catch(() => {
          document.body.classList.remove('pdf-export');
        });
    });

    // DateRange (flatpickr) initialization and handler
    function initDateRangePicker(){
      const allDates = salesData.map(r=>r.date).filter(Boolean).sort();
      const defaultStart = allDates.length ? allDates[0] : '2025-09-01';
      const defaultEnd   = allDates.length ? allDates[allDates.length-1] : '2025-09-24';

      // set global defaults
      dateFilterStart = defaultStart;
      dateFilterEnd = defaultEnd;

      flatpickr("#dateRange", {
        mode: "range",
        dateFormat: "Y-m-d",
        defaultDate: [defaultStart, defaultEnd],
        onClose: function(selectedDates){
          if (selectedDates.length === 0) {
            dateFilterStart = null; dateFilterEnd = null;
          } else if (selectedDates.length === 1) {
            dateFilterStart = selectedDates[0].toISOString().slice(0,10);
            dateFilterEnd = dateFilterStart;
          } else {
            dateFilterStart = selectedDates[0].toISOString().slice(0,10);
            dateFilterEnd = selectedDates[1].toISOString().slice(0,10);
          }
          // redraw table & charts/cards
          dataTable.draw();
          renderBranchCards();
          updateChartsAndKPIs();
        }
      });
    }

    // On load: initialize table, charts, and UI
    document.addEventListener('DOMContentLoaded', ()=>{
      initTable();
      initDateRangePicker();
      renderBranchCards();
      updateChartsAndKPIs();
      lastUpdatedText();

      // Expose functions used in DataTable buttons
      window.editRow = editRow;
      window.deleteRow = deleteRow;
    });
  </script>
</body>
</html>
