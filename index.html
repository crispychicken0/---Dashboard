<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken — Enhanced Delivery Sales Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js and plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- Export libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Shepherd.js for guided tours -->
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@11.1.1/dist/js/shepherd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@11.1.1/dist/css/shepherd.css">
  <style>
    :root {
      --brand-red: #d7263d;
      --brand-gold: #f2b705;
      --brand-green: #10b981;
      --brand-blue: #3b82f6;
      --muted: #6b7280;
      --card-bg: #ffffff;
    }
    body { 
      background: linear-gradient(180deg,#fbfbfc 0,#f1f5f9 100%); 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
      color:#0b1220; 
    }
    .dark { 
      background: linear-gradient(180deg,#1a202c 0,#2d3748 100%); 
      color: #e2e8f0; 
    }
    .dark .card { background: #2d3748; }
    .card { 
      background: var(--card-bg); 
      border-radius: 12px; 
      box-shadow: 0 6px 20px rgba(11,17,32,0.06); 
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(11,17,32,0.12);
    }
    .kpi { 
      min-width: 12rem; 
      position: relative;
      overflow: hidden;
    }
    .kpi::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--brand-red);
    }
    .small { font-size: 0.85rem; color: var(--muted); }
    .badge-up { 
      color: #166534; 
      background: rgba(16,185,129,0.08); 
      padding: 2px 8px; 
      border-radius: 999px; 
      font-weight: 600; 
    }
    .badge-down { 
      color: #7f1d1d; 
      background: rgba(239,68,68,0.08); 
      padding: 2px 8px; 
      border-radius: 999px; 
      font-weight: 600; 
    }
    .badge-warning {
      color: #854d0e;
      background: rgba(245, 158, 11, 0.08);
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 600;
    }
    .branch-card { 
      transition: transform .18s ease, box-shadow .18s ease; 
      cursor: pointer; 
      position: relative;
      overflow: hidden;
    }
    .branch-card::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 40px;
      height: 40px;
      background: var(--brand-red);
      opacity: 0.1;
      border-radius: 0 0 0 100%;
    }
    .expandable .details { 
      display: none; 
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .expandable.expanded .details { 
      display: block;
      max-height: 500px;
    }
    .charts-grid { 
      display: grid; 
      grid-template-columns: repeat(1,1fr); 
      gap: 1rem; 
    }
    @media (min-width: 900px) { .charts-grid { grid-template-columns: repeat(3,1fr); } }
    @media (min-width: 900px) { .kpi-row { display: flex; gap: 1rem; } }
    table.dataTable { width: 100% !important; }
    .top-controls { 
      gap: 0.75rem; 
      display: flex; 
      align-items: center; 
      flex-wrap: wrap; 
    }
    .spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--brand-red);
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .notification {
      position: fixed; 
      top: 20px; 
      right: 20px; 
      padding: 12px 20px; 
      border-radius: 8px;
      color: white; 
      font-weight: 500; 
      z-index: 1000; 
      animation: slideIn 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .notification.success { background: #10b981; }
    .notification.error { background: #ef4444; }
    .notification.info { background: #3b82f6; }
    .notification.warning { background: #f59e0b; }
    .tooltip {
      position: relative;
    }
    .tooltip .tooltiptext {
      visibility: hidden; 
      width: 200px; 
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff; 
      text-align: center; 
      border-radius: 6px; 
      padding: 5px;
      position: absolute; 
      z-index: 1; 
      bottom: 125%; 
      left: 50%; 
      margin-left: -100px;
      opacity: 0; 
      transition: opacity 0.3s; 
      font-size: 12px;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible; opacity: 1;
    }
    .drill-path {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: rgba(215, 38, 61, 0.05);
      border-radius: 8px;
    }
    .drill-path-item {
      padding: 0.25rem 0.75rem;
      background: var(--brand-red);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .drill-path-item:hover {
      background: #b71c1c;
    }
    .drill-path-item.active {
      background: var(--brand-gold);
      color: #000;
    }
    .goal-progress {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .goal-progress-bar {
      height: 100%;
      background: var(--brand-red);
      transition: width 0.5s ease;
    }
    .anomaly-marker {
      position: absolute;
      top: 0;
      right: 0;
      width: 10px;
      height: 10px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    .data-quality-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .data-quality-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .data-quality-good { background: #10b981; }
    .data-quality-warning { background: #f59e0b; }
    .data-quality-bad { background: #ef4444; }
    .present-mode .controls,
    .present-mode .footer {
      display: none;
    }
    .present-mode .kpi,
    .present-mode .chart {
      box-shadow: none;
      border: none;
      background: white;
    }
    
    /* Enhanced Insights Section */
    .insight-box {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #d7263d;
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 25px rgba(215, 38, 61, 0.15);
      position: relative;
      overflow: hidden;
    }
    
    .insight-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #d7263d, #f2b705, #10b981);
    }
    
    .insight-item {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-left: 4px solid;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .insight-item::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 40px;
      height: 40px;
      opacity: 0.1;
      border-radius: 0 0 0 100%;
    }
    
    .insight-item.critical {
      border-left-color: #ef4444;
    }
    
    .insight-item.critical::after {
      background: #ef4444;
    }
    
    .insight-item.warning {
      border-left-color: #f59e0b;
    }
    
    .insight-item.warning::after {
      background: #f59e0b;
    }
    
    .insight-item.success {
      border-left-color: #10b981;
    }
    
    .insight-item.success::after {
      background: #10b981;
    }
    
    .insight-item.info {
      border-left-color: #3b82f6;
    }
    
    .insight-item.info::after {
      background: #3b82f6;
    }
    
    .insight-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    
    .insight-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    
    .insight-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .insight-icon.critical {
      background: #fee2e2;
      color: #ef4444;
    }
    
    .insight-icon.warning {
      background: #fef3c7;
      color: #f59e0b;
    }
    
    .insight-icon.success {
      background: #d1fae5;
      color: #10b981;
    }
    
    .insight-icon.info {
      background: #dbeafe;
      color: #3b82f6;
    }
    
    .insight-title {
      font-weight: 600;
      font-size: 1.1rem;
      line-height: 1.3;
    }
    
    .insight-context {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
    .insight-recommendation {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 0.75rem;
      margin-top: 0.75rem;
      border-left: 3px solid #d7263d;
    }
    
    .insight-recommendation strong {
      color: #d7263d;
    }
    
    .insight-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    
    .insight-action {
      font-size: 0.85rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .insight-action.primary {
      background: #d7263d;
      color: white;
    }
    
    .insight-action.secondary {
      background: #e5e7eb;
      color: #374151;
    }
    
    .insight-action:hover {
      transform: scale(1.05);
    }
    
    .insight-empty {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
      font-style: italic;
    }
    
    .insight-empty::before {
      content: "✅";
      display: block;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    /* Three Month Report Styles */
    .report-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--brand-red);
      transition: all 0.3s ease;
    }
    
    .report-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .report-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--brand-red);
    }
    
    .report-period {
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    .report-table th {
      background: rgba(215, 38, 61, 0.1);
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--brand-red);
    }
    
    .report-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .report-table tr:hover {
      background: rgba(215, 38, 61, 0.03);
    }
    
    .growth-positive {
      color: var(--brand-green);
      font-weight: 600;
    }
    
    .growth-negative {
      color: #ef4444;
      font-weight: 600;
    }
    
    .growth-neutral {
      color: var(--muted);
      font-weight: 600;
    }
    
    .branch-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
    }
    
    .branch-performance {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .performance-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .performance-up {
      background: var(--brand-green);
    }
    
    .performance-down {
      background: #ef4444;
    }
    
    .performance-stable {
      background: var(--brand-gold);
    }
    
    .report-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .report-action {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .report-action.primary {
      background: var(--brand-red);
      color: white;
    }
    
    .report-action.secondary {
      background: #e5e7eb;
      color: #374151;
    }
    
    .report-action:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body class="p-6">
  <div class="max-w-7xl mx-auto">
    <!-- HEADER -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <img src="https://crispychicken-uae.com/logo.png" alt="Crispy Chicken" style="height:64px;width:auto; border-radius:8px;" />
        <div>
          <h1 class="text-2xl font-bold" style="color:var(--brand-red)">Crispy Chicken — Enhanced Delivery Sales Dashboard</h1>
          <div class="small">January – September 2025 &middot; Real-time preview · For top management</div>
          <span class="role-badge" id="userRole">Manager</span>
        </div>
      </div>
      <div class="top-controls">
        <div class="card px-3 py-2 flex items-center gap-3">
          <label for="monthFilterTop" class="small">Date range</label>
          <select id="monthFilterTop" class="p-2 border rounded text-sm" aria-label="Select month">
            <option value="2025-01">January 2025</option>
            <option value="2025-02">February 2025</option>
            <option value="2025-03">March 2025</option>
            <option value="2025-04">April 2025</option>
            <option value="2025-05">May 2025</option>
            <option value="2025-06">June 2025</option>
            <option value="2025-07">July 2025</option>
            <option value="2025-08">August 2025</option>
            <option value="2025-09" selected>September 2025</option>
            <option value="all">Jan–Sep 2025 (All)</option>
          </select>
        </div>
        <div class="card px-3 py-2 flex items-center gap-3">
          <label for="comparePeriod" class="small">Compare to</label>
          <select id="comparePeriod" class="p-2 border rounded text-sm">
            <option value="prev-month">Previous Month</option>
            <option value="prev-year">Previous Year</option>
            <option value="same-day-last-week">Same Day Last Week</option>
          </select>
        </div>
        <button id="btnExportCSV" class="px-3 py-2 card text-sm font-semibold" title="Export CSV">Export CSV</button>
        <button id="btnExportPDF" class="px-3 py-2 card text-sm font-semibold" title="Export PDF">Export PDF</button>
        <button id="btnExportExcel" class="px-3 py-2 card text-sm font-semibold" title="Export Excel">Export Excel</button>
        <button id="btnScheduleExport" class="px-3 py-2 card text-sm font-semibold" title="Schedule Export">Schedule Export</button>
        <button id="btnPresentMode" class="px-3 py-2 card text-sm font-semibold" title="Present Mode">Present Mode</button>
        <button id="btnReset" class="px-3 py-2 card text-sm font-semibold" title="Reset data">Reset</button>
        <button id="btnClearAll" class="px-3 py-2 card text-sm font-semibold" title="Clear all data">Clear All</button>
        <button id="darkModeToggle" class="px-3 py-2 card text-sm font-semibold" title="Toggle dark mode">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
          </svg>
        </button>
        <button id="btnTour" class="px-3 py-2 card text-sm font-semibold" title="Take Tour">Take Tour</button>
      </div>
    </header>

    <!-- Enhanced INSIGHTS SECTION -->
    <section class="mb-6">
      <div class="insight-box">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-xl flex items-center gap-2">
            <span class="text-2xl">🔍</span>
            Key Insights
            <span class="text-sm font-normal text-gray-500 ml-2" id="insightCount">0 insights</span>
          </h3>
          <button onclick="refreshInsights()" class="text-sm bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition-colors">
            Refresh
          </button>
        </div>
        <div id="insightsContainer" class="space-y-3">
          <!-- Insights will be dynamically loaded here -->
        </div>
      </div>
    </section>

    <!-- DRILL-DOWN PATH -->
    <div id="drillPath" class="drill-path mb-6" style="display: none;">
      <span class="small">Drill-down path:</span>
      <div class="drill-path-item active" data-level="0">Dashboard</div>
    </div>

    <!-- KPI CARDS -->
    <section class="kpi-row mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card kpi p-4 drillable" data-metric="sales" data-drill-type="sales">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Total Delivery Sales</div>
            <div id="kpiSales" class="text-2xl font-bold" style="color:var(--brand-red)">— AED</div>
            <div class="small mt-1">Period total</div>
            <div class="data-quality-indicator mt-1">
              <span class="data-quality-dot data-quality-good"></span>
              <span class="small">Data quality: Good</span>
            </div>
          </div>
          <div class="text-right">
            <div class="small">Growth</div>
            <div id="kpiSalesDelta" class="small badge-up">+0.0%</div>
            <div class="small mt-1">vs previous period</div>
          </div>
        </div>
      </div>
      <div class="card kpi p-4 drillable" data-metric="orders" data-drill-type="orders">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Total Delivery Orders</div>
            <div id="kpiOrders" class="text-2xl font-bold">—</div>
            <div class="small mt-1">Period total</div>
          </div>
          <div class="text-right">
            <div class="small">Avg Delivery Order Value</div>
            <div id="kpiAOV" class="small">— AED</div>
          </div>
        </div>
      </div>
      <div class="card kpi p-4 drillable" data-metric="growth" data-drill-type="growth">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Delivery Orders Growth</div>
            <div id="kpiOrdersGrowth" class="text-2xl font-bold">— %</div>
            <div class="small mt-1">vs previous period</div>
          </div>
          <div class="text-right">
            <div class="small">Peak Day Orders</div>
            <div id="kpiPeakOrders" class="small">—</div>
          </div>
        </div>
      </div>
      <div class="card kpi p-4 drillable" data-metric="top" data-drill-type="top">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Top Branch</div>
            <div id="kpiTopBranch" class="text-2xl font-bold" style="color:var(--brand-gold)">—</div>
            <div class="small mt-1">By delivery sales</div>
          </div>
          <div class="text-right">
            <div class="small">Best Day</div>
            <div id="kpiPeakDay" class="small">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- GOALS & BENCHMARKS -->
    <section class="mb-6">
      <div class="card p-4">
        <h3 class="font-semibold mb-3">Goals & Benchmarks</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <div class="small mb-1">Monthly Sales Target</div>
            <div class="flex justify-between mb-1">
              <span id="monthlyTarget" class="font-semibold">— AED</span>
              <span id="monthlyProgress" class="small">0%</span>
            </div>
            <div class="goal-progress">
              <div id="monthlyProgressBar" class="goal-progress-bar" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <div class="small mb-1">Branch Ranking</div>
            <div id="branchRanking" class="text-sm">
              <div class="flex justify-between py-1">
                <span>1. Hamdan</span>
                <span class="font-semibold">983 orders</span>
              </div>
              <div class="flex justify-between py-1">
                <span>2. Shabiya</span>
                <span class="font-semibold">567 orders</span>
              </div>
              <div class="flex justify-between py-1">
                <span>3. Khalidiyah</span>
                <span class="font-semibold">508 orders</span>
              </div>
            </div>
          </div>
          <div>
            <div class="small mb-1">Performance Alerts</div>
            <div id="performanceAlerts" class="text-sm">
              <div class="flex items-center gap-2 py-1">
                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                <span>All branches on track</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Branch Performance Cards -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3" style="color:var(--brand-red)">Branch Delivery Performance</h2>
      <div id="branchRow1" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"></div>
      <div id="branchRow2" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </section>

    <!-- Three Month Delivery Sales Report -->
    <section class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold" style="color:var(--brand-red)">Three-Month Delivery Sales Analysis</h2>
        <button id="refreshReport" class="px-3 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition-colors">
          Refresh Report
        </button>
      </div>
      <div id="threeMonthReportContainer">
        <!-- Report will be dynamically generated here -->
      </div>
    </section>

    <!-- Chart Filters -->
    <section class="mb-6">
      <div class="card p-4">
        <h3 class="font-semibold mb-3">Chart Filters</h3>
        <div class="flex flex-wrap gap-4">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium mb-1">Branches</label>
            <select id="branchFilter" multiple class="w-full p-2 border rounded" size="3">
              <option value="all" selected>All branches</option>
              <option value="Barsha">Barsha</option>
              <option value="Hamdan">Hamdan</option>
              <option value="Khalidiyah">Khalidiyah</option>
              <option value="Muroor">Muroor</option>
              <option value="Satwa">Satwa</option>
              <option value="Shabiya">Shabiya</option>
            </select>
          </div>
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium mb-1">Date Range</label>
            <div class="flex gap-2">
              <input type="date" id="startDate" class="flex-1 p-2 border rounded" placeholder="Start date">
              <input type="date" id="endDate" class="flex-1 p-2 border rounded" placeholder="End date">
            </div>
          </div>
          <div class="flex items-end">
            <button id="applyFilters" class="px-4 py-2 bg-red-600 text-white rounded font-medium">Apply Filters</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Charts grid (removed heatmap and forecast) -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3" style="color:var(--brand-red)">Delivery Sales Analysis</h2>
      <div class="charts-grid">
        <div class="card p-4">
          <h3 class="font-semibold mb-2">Delivery Sales by Branch</h3>
          <canvas id="barChart" height="220"></canvas>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold mb-2">Daily Delivery Sales Trend</h3>
          <canvas id="lineChart" height="220"></canvas>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold mb-2">Delivery Sales Distribution</h3>
          <canvas id="pieChart" height="220"></canvas>
        </div>
      </div>
    </section>

    <!-- Data Input and Table -->
    <section class="mb-6">
      <div class="flex flex-col lg:flex-row gap-4">
        <div class="card p-4 flex-1">
          <h3 class="font-semibold mb-2">Quick Data Input</h3>
          <textarea id="dataInput" class="w-full h-28 p-2 border rounded mb-2" placeholder="Paste CSV rows: Date,Outlet,DeliveryOrders,DeliverySales"></textarea>
          <div class="flex gap-2">
            <button id="btnUpdate" class="px-3 py-2 bg-red-600 text-white rounded">Update Data</button>
            <button id="btnClearInput" class="px-3 py-2 border rounded">Clear Input</button>
            <button id="btnSetGoals" class="px-3 py-2 border rounded">Set Goals</button>
            <div class="small self-center ml-auto text-gray-500">Tip: Use YYYY-MM-DD dates</div>
          </div>
        </div>
        <div class="card p-4 flex-1">
          <h3 class="font-semibold mb-2">Raw Delivery Data (drill-down)</h3>
          <table id="dataTable" class="display w-full">
            <thead>
              <tr>
                <th>Date</th>
                <th>Outlet</th>
                <th>Delivery Orders</th>
                <th>Delivery Sales (AED)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Data Quality Section -->
    <section class="mb-6">
      <div class="card p-4">
        <h3 class="font-semibold mb-2">Data Quality & Audit Trail</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h4 class="font-medium mb-2">Data Quality Metrics</h4>
            <div id="dataQuality" class="text-sm">
              <div class="flex justify-between py-1">
                <span>Completeness</span>
                <span class="font-semibold">98%</span>
              </div>
              <div class="flex justify-between py-1">
                <span>Accuracy</span>
                <span class="font-semibold">96%</span>
              </div>
              <div class="flex justify-between py-1">
                <span>Consistency</span>
                <span class="font-semibold">99%</span>
              </div>
            </div>
          </div>
          <div>
            <h4 class="font-medium mb-2">Recent Audit Log</h4>
            <div id="auditLog" class="text-sm max-h-32 overflow-y-auto">
              <div class="py-1 border-b">
                <span class="font-medium">09/24/2025 14:30</span> - Data updated by admin
              </div>
              <div class="py-1 border-b">
                <span class="font-medium">09/23/2025 10:15</span> - Exported report to PDF
              </div>
              <div class="py-1 border-b">
                <span class="font-medium">09/22/2025 16:45</span> - Set monthly sales target
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-sm text-gray-500 mt-6">
      Last updated: <span id="lastUpdated">—</span> &middot; 
      Data version: <span id="dataVersion">v1.0</span> &middot; 
      Prepared for Top Management — Crispy Chicken
    </footer>
  </div>

  <!-- Notification container -->
  <div id="notificationContainer"></div>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-4 rounded-lg flex items-center">
      <div class="spinner mr-3"></div>
      <span>Processing...</span>
    </div>
  </div>

  <!-- Drill-down modal -->
  <div id="drillModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 id="drillModalTitle" class="text-xl font-bold">Drill-down View</h3>
        <button id="closeDrillModal" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2 d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="drillModalContent"></div>
    </div>
  </div>

  <!-- Goal setting modal -->
  <div id="goalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Set Goals & Targets</h3>
        <button id="closeGoalModal" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2 d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="goalModalContent"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="cancelGoals" class="px-4 py-2 border rounded">Cancel</button>
        <button id="saveGoals" class="px-4 py-2 bg-red-600 text-white rounded">Save Goals</button>
      </div>
    </div>
  </div>

  <!-- Schedule export modal -->
  <div id="scheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Schedule Export</h3>
        <button id="closeScheduleModal" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2 d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Export Format</label>
        <select id="exportFormat" class="w-full p-2 border rounded">
          <option value="pdf">PDF Report</option>
          <option value="excel">Excel Workbook</option>
          <option value="csv">CSV Data</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Frequency</label>
        <select id="exportFrequency" class="w-full p-2 border rounded">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Time</label>
        <input type="time" id="exportTime" class="w-full p-2 border rounded" value="09:00">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Recipients</label>
        <input type="email" id="exportRecipients" class="w-full p-2 border rounded" placeholder="Enter email addresses, comma separated">
      </div>
      <div class="flex justify-end gap-2">
        <button id="cancelSchedule" class="px-4 py-2 border rounded">Cancel</button>
        <button id="saveSchedule" class="px-4 py-2 bg-red-600 text-white rounded">Save Schedule</button>
      </div>
    </div>
  </div>

  <script>
    // Register Chart plugins
    Chart.register(ChartDataLabels, window.ChartAnnotationPlugin || { id: 'annotation' });

    // Initialize Shepherd tour
    const tour = new Shepherd.Tour({
      useModalOverlay: true,
      defaultStepOptions: {
        classes: 'shepherd-theme-arrows',
        scrollTo: true,
        cancelIcon: {
          enabled: true
        }
      }
    });

    // Branch mapping
    const branchMapping = {
      'Barsha Shop': 'Barsha',
      'Hamdan Shop': 'Hamdan',
      'Khalydiha Shop': 'Khalidiyah',
      'Mouroor Shop': 'Muroor',
      'Satwa Shop': 'Satwa',
      'Shabiha Shop': 'Shabiya'
    };

    // User roles and permissions
    const userRoles = {
      admin: { name: 'Administrator', permissions: ['read_all', 'write_all', 'manage_users', 'export_data', 'set_goals'] },
      manager: { name: 'Manager', permissions: ['read_all', 'write_branch', 'export_branch', 'set_goals'] },
      branch_manager: { name: 'Branch Manager', permissions: ['read_branch', 'write_branch'] },
      analyst: { name: 'Analyst', permissions: ['read_all', 'export_anonymized'] }
    };

    // Current user (simulated)
    const currentUser = {
      id: 'user123',
      name: 'John Manager',
      role: 'manager',
      branch: 'all' // In real app, this would be specific branches
    };

    // Set user role in UI
    document.getElementById('userRole').textContent = userRoles[currentUser.role].name;

    // Provided delivery sales data (Jan–April 2025)
    const providedDeliverySales = [
      { Date: '2025-01-01', 'Barsha Shop': 1644.42, 'Hamdan Shop': 3826.34, 'Khalydiha Shop': 2507.46, 'Mouroor Shop': 1491.36, 'Satwa Shop': 546.85, 'Shabiya Shop': 1336.69 },
      { Date: '2025-01-02', 'Barsha Shop': 1874.26, 'Hamdan Shop': 2516.93, 'Khalydiha Shop': 1839.71, 'Mouroor Shop': 1228.67, 'Satwa Shop': 907.6, 'Shabiya Shop': 1511.48 },
      { Date: '2025-01-03', 'Barsha Shop': 1674.3, 'Hamdan Shop': 3338.91, 'Khalydiha Shop': 1858.38, 'Mouroor Shop': 1392.6, 'Satwa Shop': 562.73, 'Shabiya Shop': 1587.6 },
      { Date: '2025-01-04', 'Barsha Shop': 1677.43, 'Hamdan Shop': 4383.58, 'Khalydiha Shop': 1498.64, 'Mouroor Shop': 1485.55, 'Satwa Shop': 837.73, 'Shabiya Shop': 1192.66 },
      { Date: '2025-01-05', 'Barsha Shop': 1320.35, 'Hamdan Shop': 3410.83, 'Khalydiha Shop': 1722.67, 'Mouroor Shop': 1709.27, 'Satwa Shop': 568.79, 'Shabiya Shop': 954.68 },
      { Date: '2025-01-06', 'Barsha Shop': 1099.65, 'Hamdan Shop': 4599.34, 'Khalydiha Shop': 1720.27, 'Mouroor Shop': 2175.13, 'Satwa Shop': 807.68, 'Shabiya Shop': 1707.5 },
      { Date: '2025-01-07', 'Barsha Shop': 2218.85, 'Hamdan Shop': 4515.34, 'Khalydiha Shop': 2463.98, 'Mouroor Shop': 1876.96, 'Satwa Shop': 770.63, 'Shabiya Shop': 1951.52 },
      { Date: '2025-01-08', 'Barsha Shop': 1685.47, 'Hamdan Shop': 2940.91, 'Khalydiha Shop': 1631.49, 'Mouroor Shop': 1689.31, 'Satwa Shop': 557.79, 'Shabiya Shop': 1592.64 },
      { Date: '2025-01-09', 'Barsha Shop': 2274.9, 'Hamdan Shop': 2800.3, 'Khalydiha Shop': 1643.33, 'Mouroor Shop': 2044.27, 'Satwa Shop': 997.61, 'Shabiya Shop': 1567.41 },
      { Date: '2025-01-10', 'Barsha Shop': 2280.41, 'Hamdan Shop': 4231.62, 'Khalydiha Shop': 2365.57, 'Mouroor Shop': 2538.04, 'Satwa Shop': 1160.43, 'Shabiya Shop': 1920.52 },
      { Date: '2025-01-11', 'Barsha Shop': 1949.26, 'Hamdan Shop': 4181.46, 'Khalydiha Shop': 2163.39, 'Mouroor Shop': 1892.35, 'Satwa Shop': 1054.76, 'Shabiya Shop': 1713.34 },
      { Date: '2025-01-12', 'Barsha Shop': 1620.47, 'Hamdan Shop': 4012.76, 'Khalydiha Shop': 1819.4, 'Mouroor Shop': 2215.43, 'Satwa Shop': 1069.57, 'Shabiya Shop': 1558.49 },
      { Date: '2025-01-13', 'Barsha Shop': 1789.59, 'Hamdan Shop': 5220.35, 'Khalydiha Shop': 2488.75, 'Mouroor Shop': 2776.5, 'Satwa Shop': 1559.74, 'Shabiya Shop': 2249.67 },
      { Date: '2025-01-14', 'Barsha Shop': 2188.36, 'Hamdan Shop': 4965.58, 'Khalydiha Shop': 2541.56, 'Mouroor Shop': 2836.61, 'Satwa Shop': 1332.76, 'Shabiya Shop': 2228.78 },
      { Date: '2025-01-15', 'Barsha Shop': 1249.4, 'Hamdan Shop': 3886.86, 'Khalydiha Shop': 1383.48, 'Mouroor Shop': 1944.43, 'Satwa Shop': 437.82, 'Shabiya Shop': 1683.31 },
      { Date: '2025-01-16', 'Barsha Shop': 1471.46, 'Hamdan Shop': 3212.9, 'Khalydiha Shop': 1488.65, 'Mouroor Shop': 1959.35, 'Satwa Shop': 673.71, 'Shabiya Shop': 1270.68 },
      { Date: '2025-01-17', 'Barsha Shop': 1577.39, 'Hamdan Shop': 3295.87, 'Khalydiha Shop': 2695.2, 'Mouroor Shop': 1963.06, 'Satwa Shop': 717.69, 'Shabiya Shop': 2117.55 },
      { Date: '2025-01-18', 'Barsha Shop': 1290.27, 'Hamdan Shop': 3477.94, 'Khalydiha Shop': 1915.32, 'Mouroor Shop': 1464.79, 'Satwa Shop': 758.72, 'Shabiya Shop': 1434.49 },
      { Date: '2025-01-19', 'Barsha Shop': 988, 'Hamdan Shop': 2446.9, 'Khalydiha Shop': 1441.9, 'Mouroor Shop': 1148, 'Satwa Shop': 512, 'Shabiya Shop': 1702 },
      { Date: '2025-01-20', 'Barsha Shop': 3317, 'Hamdan Shop': 5909, 'Khalydiha Shop': 2198.9, 'Mouroor Shop': 2607, 'Satwa Shop': 1216.9, 'Shabiya Shop': 2304 },
      { Date: '2025-01-21', 'Barsha Shop': 2333, 'Hamdan Shop': 5323.9, 'Khalydiha Shop': 2684, 'Mouroor Shop': 2338, 'Satwa Shop': 912, 'Shabiya Shop': 2570 },
      { Date: '2025-01-22', 'Barsha Shop': 1510.9, 'Hamdan Shop': 3472.9, 'Khalydiha Shop': 1367, 'Mouroor Shop': 1194.8, 'Satwa Shop': 869, 'Shabiya Shop': 904.9 },
      { Date: '2025-01-23', 'Barsha Shop': 1705.9, 'Hamdan Shop': 2808.9, 'Khalydiha Shop': 1661.9, 'Mouroor Shop': 1650, 'Satwa Shop': 557, 'Shabiya Shop': 1528 },
      { Date: '2025-01-24', 'Barsha Shop': 2127, 'Hamdan Shop': 4341.8, 'Khalydiha Shop': 2298.8, 'Mouroor Shop': 1355, 'Satwa Shop': 413, 'Shabiya Shop': 2854 },
      { Date: '2025-01-25', 'Barsha Shop': 1611, 'Hamdan Shop': 3025, 'Khalydiha Shop': 1887, 'Mouroor Shop': 1712, 'Satwa Shop': 980, 'Shabiya Shop': 2053.8 },
      { Date: '2025-01-26', 'Barsha Shop': 1515, 'Hamdan Shop': 2092, 'Khalydiha Shop': 1108, 'Mouroor Shop': 1583.9, 'Satwa Shop': 1085, 'Shabiya Shop': 548 },
      { Date: '2025-01-27', 'Barsha Shop': 1716, 'Hamdan Shop': 5718.9, 'Khalydiha Shop': 2047, 'Mouroor Shop': 1928, 'Satwa Shop': 911, 'Shabiya Shop': 2206 },
      { Date: '2025-01-28', 'Barsha Shop': 2818, 'Hamdan Shop': 5546, 'Khalydiha Shop': 2624, 'Mouroor Shop': 2897, 'Satwa Shop': 1442, 'Shabiya Shop': 2395 },
      { Date: '2025-01-29', 'Barsha Shop': 1795, 'Hamdan Shop': 2606, 'Khalydiha Shop': 1851, 'Mouroor Shop': 1898, 'Satwa Shop': 758, 'Shabiya Shop': 1210 },
      { Date: '2025-01-30', 'Barsha Shop': 1667, 'Hamdan Shop': 2825.7, 'Khalydiha Shop': 1599, 'Mouroor Shop': 2025.4, 'Satwa Shop': 721, 'Shabiya Shop': 1020 },
      { Date: '2025-01-31', 'Barsha Shop': 1762, 'Hamdan Shop': 4365.6, 'Khalydiha Shop': 1844.6, 'Mouroor Shop': 2727.9, 'Satwa Shop': 1149, 'Shabiya Shop': 1903 },
      { Date: '2025-02-01', 'Barsha Shop': 2433, 'Hamdan Shop': 3825.9, 'Khalydiha Shop': 2693, 'Mouroor Shop': 1783, 'Satwa Shop': 888, 'Shabiya Shop': 1839 },
      { Date: '2025-02-02', 'Barsha Shop': 1730, 'Hamdan Shop': 2734, 'Khalydiha Shop': 1351, 'Mouroor Shop': 2175, 'Satwa Shop': 844, 'Shabiya Shop': 1223 },
      { Date: '2025-02-03', 'Barsha Shop': 1895, 'Hamdan Shop': 5713.9, 'Khalydiha Shop': 1973, 'Mouroor Shop': 2187, 'Satwa Shop': 922, 'Shabiya Shop': 2763 },
      { Date: '2025-02-04', 'Barsha Shop': 2172, 'Hamdan Shop': 5149, 'Khalydiha Shop': 2312, 'Mouroor Shop': 3296, 'Satwa Shop': 973.9, 'Shabiya Shop': 2511 },
      { Date: '2025-02-05', 'Barsha Shop': 1381, 'Hamdan Shop': 2080, 'Khalydiha Shop': 1600.8, 'Mouroor Shop': 1418, 'Satwa Shop': 485, 'Shabiya Shop': 1178 },
      { Date: '2025-02-06', 'Barsha Shop': 1729, 'Hamdan Shop': 2963, 'Khalydiha Shop': 1595.9, 'Mouroor Shop': 1682, 'Satwa Shop': 905, 'Shabiya Shop': 1929.9 },
      { Date: '2025-02-07', 'Barsha Shop': 2481.9, 'Hamdan Shop': 3513.9, 'Khalydiha Shop': 2204.9, 'Mouroor Shop': 1782, 'Satwa Shop': 751, 'Shabiya Shop': 1991 },
      { Date: '2025-02-08', 'Barsha Shop': 1763, 'Hamdan Shop': 4977.8, 'Khalydiha Shop': 2920, 'Mouroor Shop': 1446, 'Satwa Shop': 483.9, 'Shabiya Shop': 2271.9 },
      { Date: '2025-02-09', 'Barsha Shop': 1345, 'Hamdan Shop': 3256.9, 'Khalydiha Shop': 977, 'Mouroor Shop': 1397.9, 'Satwa Shop': 600, 'Shabiya Shop': 1500 },
      { Date: '2025-02-10', 'Barsha Shop': 2592.7, 'Hamdan Shop': 9352, 'Khalydiha Shop': 1902, 'Mouroor Shop': 3030, 'Satwa Shop': 1387, 'Shabiya Shop': 2728 },
      { Date: '2025-02-11', 'Barsha Shop': 2053, 'Hamdan Shop': 6183, 'Khalydiha Shop': 1835, 'Mouroor Shop': 2771, 'Satwa Shop': 1009, 'Shabiya Shop': 2609 },
      { Date: '2025-02-12', 'Barsha Shop': 1628, 'Hamdan Shop': 3116.8, 'Khalydiha Shop': 1328, 'Mouroor Shop': 2287.9, 'Satwa Shop': 593.9, 'Shabiya Shop': 1000 },
      { Date: '2025-02-13', 'Barsha Shop': 1761, 'Hamdan Shop': 2736.8, 'Khalydiha Shop': 1460.9, 'Mouroor Shop': 1298.9, 'Satwa Shop': 786, 'Shabiya Shop': 1368 },
      { Date: '2025-02-14', 'Barsha Shop': 1635, 'Hamdan Shop': 4573.8, 'Khalydiha Shop': 2339.9, 'Mouroor Shop': 2586.8, 'Satwa Shop': 821, 'Shabiya Shop': 1806 },
      { Date: '2025-02-15', 'Barsha Shop': 1577, 'Hamdan Shop': 2821.9, 'Khalydiha Shop': 1817, 'Mouroor Shop': 1492.9, 'Satwa Shop': 629, 'Shabiya Shop': 2161.9 },
      { Date: '2025-02-16', 'Barsha Shop': 1384.9, 'Hamdan Shop': 3022.8, 'Khalydiha Shop': 1349, 'Mouroor Shop': 2695.8, 'Satwa Shop': 797, 'Shabiya Shop': 1828 },
      { Date: '2025-02-17', 'Barsha Shop': 2040, 'Hamdan Shop': 5180.9, 'Khalydiha Shop': 2233, 'Mouroor Shop': 2745, 'Satwa Shop': 1351, 'Shabiya Shop': 3401 },
      { Date: '2025-02-18', 'Barsha Shop': 1656, 'Hamdan Shop': 5282, 'Khalydiha Shop': 1937, 'Mouroor Shop': 3019, 'Satwa Shop': 1459, 'Shabiya Shop': 1950 },
      { Date: '2025-02-19', 'Barsha Shop': 2142, 'Hamdan Shop': 1833, 'Khalydiha Shop': 1197, 'Mouroor Shop': 778, 'Satwa Shop': 434, 'Shabiya Shop': 605 },
      { Date: '2025-02-20', 'Barsha Shop': 1911, 'Hamdan Shop': 3015.9, 'Khalydiha Shop': 846, 'Mouroor Shop': 1996.8, 'Satwa Shop': 457, 'Shabiya Shop': 599 },
      { Date: '2025-02-21', 'Barsha Shop': 1954, 'Hamdan Shop': 3731.9, 'Khalydiha Shop': 2080, 'Mouroor Shop': 2645, 'Satwa Shop': 591, 'Shabiya Shop': 1509 },
      { Date: '2025-02-22', 'Barsha Shop': 1175, 'Hamdan Shop': 4756.9, 'Khalydiha Shop': 1713, 'Mouroor Shop': 1801.9, 'Satwa Shop': 1567, 'Shabiya Shop': 1446.9 },
      { Date: '2025-02-23', 'Barsha Shop': 1638, 'Hamdan Shop': 3429, 'Khalydiha Shop': 1588.8, 'Mouroor Shop': 1129.9, 'Satwa Shop': 1106, 'Shabiya Shop': 1407 },
      { Date: '2025-02-24', 'Barsha Shop': 1535, 'Hamdan Shop': 3524, 'Khalydiha Shop': 1757.7, 'Mouroor Shop': 1612.9, 'Satwa Shop': 1081, 'Shabiya Shop': 2170 },
      { Date: '2025-02-25', 'Barsha Shop': 2629, 'Hamdan Shop': 4078.8, 'Khalydiha Shop': 1971, 'Mouroor Shop': 1885, 'Satwa Shop': 1062, 'Shabiya Shop': 2373.8 },
      { Date: '2025-02-26', 'Barsha Shop': 1859, 'Hamdan Shop': 3330, 'Khalydiha Shop': 2170.9, 'Mouroor Shop': 2029.8, 'Satwa Shop': 919.9, 'Shabiya Shop': 1948 },
      { Date: '2025-02-27', 'Barsha Shop': 2308.9, 'Hamdan Shop': 3325.8, 'Khalydiha Shop': 2151, 'Mouroor Shop': 2163, 'Satwa Shop': 805, 'Shabiya Shop': 1542 },
      { Date: '2025-02-28', 'Barsha Shop': 1290, 'Hamdan Shop': 4035.9, 'Khalydiha Shop': 2412.9, 'Mouroor Shop': 3301, 'Satwa Shop': 640, 'Shabiya Shop': 1445.9 },
      { Date: '2025-03-01', 'Barsha Shop': 754, 'Hamdan Shop': 2299, 'Khalydiha Shop': 753, 'Mouroor Shop': 914, 'Satwa Shop': 589, 'Shabiya Shop': 799 },
      { Date: '2025-03-02', 'Barsha Shop': 540.9, 'Hamdan Shop': 2156, 'Khalydiha Shop': 995.9, 'Mouroor Shop': 474, 'Satwa Shop': 654, 'Shabiya Shop': 697 },
      { Date: '2025-03-03', 'Barsha Shop': 561, 'Hamdan Shop': 2538, 'Khalydiha Shop': 847, 'Mouroor Shop': 1012, 'Satwa Shop': 747, 'Shabiya Shop': 1202 },
      { Date: '2025-03-04', 'Barsha Shop': 1231, 'Hamdan Shop': 1838, 'Khalydiha Shop': 962, 'Mouroor Shop': 1011, 'Satwa Shop': 515, 'Shabiya Shop': 702 },
      { Date: '2025-03-05', 'Barsha Shop': 1162, 'Hamdan Shop': 2042.8, 'Khalydiha Shop': 994, 'Mouroor Shop': 1113, 'Satwa Shop': 569.9, 'Shabiya Shop': 827 },
      { Date: '2025-03-06', 'Barsha Shop': 1353, 'Hamdan Shop': 2384.9, 'Khalydiha Shop': 1141, 'Mouroor Shop': 1395, 'Satwa Shop': 404, 'Shabiya Shop': 1076 },
      { Date: '2025-03-07', 'Barsha Shop': 1787, 'Hamdan Shop': 2623, 'Khalydiha Shop': 1459, 'Mouroor Shop': 921, 'Satwa Shop': 439, 'Shabiya Shop': 1396.8 },
      { Date: '2025-03-08', 'Barsha Shop': 2007.9, 'Hamdan Shop': 2508, 'Khalydiha Shop': 1369, 'Mouroor Shop': 1476.9, 'Satwa Shop': 579, 'Shabiya Shop': 1324 },
      { Date: '2025-03-09', 'Barsha Shop': 1224, 'Hamdan Shop': 2363, 'Khalydiha Shop': 1150.9, 'Mouroor Shop': 1024, 'Satwa Shop': 562, 'Shabiya Shop': 1212 },
      { Date: '2025-03-10', 'Barsha Shop': 1135, 'Hamdan Shop': 2624.9, 'Khalydiha Shop': 1409, 'Mouroor Shop': 1201, 'Satwa Shop': 471, 'Shabiya Shop': 887 },
      { Date: '2025-03-11', 'Barsha Shop': 1298.9, 'Hamdan Shop': 2340.8, 'Khalydiha Shop': 1088, 'Mouroor Shop': 1342.9, 'Satwa Shop': 712, 'Shabiya Shop': 1358.9 },
      { Date: '2025-03-12', 'Barsha Shop': 887, 'Hamdan Shop': 2182, 'Khalydiha Shop': 1116, 'Mouroor Shop': 1100, 'Satwa Shop': 976, 'Shabiya Shop': 850 },
      { Date: '2025-03-13', 'Barsha Shop': 989, 'Hamdan Shop': 2454, 'Khalydiha Shop': 1180, 'Mouroor Shop': 1156, 'Satwa Shop': 401.9, 'Shabiya Shop': 1093 },
      { Date: '2025-03-14', 'Barsha Shop': 1005, 'Hamdan Shop': 2978.9, 'Khalydiha Shop': 1742, 'Mouroor Shop': 1005, 'Satwa Shop': 793, 'Shabiya Shop': 1221.8 },
      { Date: '2025-03-15', 'Barsha Shop': 1445, 'Hamdan Shop': 3246, 'Khalydiha Shop': 1663, 'Mouroor Shop': 866, 'Satwa Shop': 991, 'Shabiya Shop': 1027 },
      { Date: '2025-03-16', 'Barsha Shop': 1568, 'Hamdan Shop': 2380, 'Khalydiha Shop': 1497, 'Mouroor Shop': 1188, 'Satwa Shop': 645, 'Shabiya Shop': 1211.9 },
      { Date: '2025-03-17', 'Barsha Shop': 1267, 'Hamdan Shop': 1733, 'Khalydiha Shop': 902, 'Mouroor Shop': 1183, 'Satwa Shop': 443, 'Shabiya Shop': 1123 },
      { Date: '2025-03-18', 'Barsha Shop': 814, 'Hamdan Shop': 3212.9, 'Khalydiha Shop': 1209, 'Mouroor Shop': 1598, 'Satwa Shop': 354, 'Shabiya Shop': 1256 },
      { Date: '2025-03-19', 'Barsha Shop': 1206, 'Hamdan Shop': 1647.9, 'Khalydiha Shop': 1892, 'Mouroor Shop': 1203.8, 'Satwa Shop': 557, 'Shabiya Shop': 1475 },
      { Date: '2025-03-20', 'Barsha Shop': 1330, 'Hamdan Shop': 2876.9, 'Khalydiha Shop': 945, 'Mouroor Shop': 1249.8, 'Satwa Shop': 699, 'Shabiya Shop': 1633 },
      { Date: '2025-03-21', 'Barsha Shop': 1199, 'Hamdan Shop': 3716.8, 'Khalydiha Shop': 1584, 'Mouroor Shop': 1647.9, 'Satwa Shop': 742, 'Shabiya Shop': 1357.9 },
      { Date: '2025-03-22', 'Barsha Shop': 1703, 'Hamdan Shop': 2556.9, 'Khalydiha Shop': 856, 'Mouroor Shop': 1301.9, 'Satwa Shop': 776.9, 'Shabiya Shop': 1729.9 },
      { Date: '2025-03-23', 'Barsha Shop': 1347, 'Hamdan Shop': 2214.9, 'Khalydiha Shop': 1236, 'Mouroor Shop': 1020, 'Satwa Shop': 663, 'Shabiya Shop': 1336.9 },
      { Date: '2025-03-24', 'Barsha Shop': 1269, 'Hamdan Shop': 3100.9, 'Khalydiha Shop': 1517, 'Mouroor Shop': 1082, 'Satwa Shop': 761, 'Shabiya Shop': 1030 },
      { Date: '2025-03-25', 'Barsha Shop': 1768, 'Hamdan Shop': 2631, 'Khalydiha Shop': 1513, 'Mouroor Shop': 1314, 'Satwa Shop': 437, 'Shabiya Shop': 1434 },
      { Date: '2025-03-26', 'Barsha Shop': 1756, 'Hamdan Shop': 2111, 'Khalydiha Shop': 1559.9, 'Mouroor Shop': 898, 'Satwa Shop': 971, 'Shabiya Shop': 1258 },
      { Date: '2025-03-27', 'Barsha Shop': 1903, 'Hamdan Shop': 2649, 'Khalydiha Shop': 1739, 'Mouroor Shop': 1429, 'Satwa Shop': 1063, 'Shabiya Shop': 1628 },
      { Date: '2025-03-28', 'Barsha Shop': 1575, 'Hamdan Shop': 3737.8, 'Khalydiha Shop': 1993, 'Mouroor Shop': 1701.9, 'Satwa Shop': 550, 'Shabiya Shop': 1398 },
      { Date: '2025-03-29', 'Barsha Shop': 1719, 'Hamdan Shop': 5034, 'Khalydiha Shop': 1713, 'Mouroor Shop': 2592, 'Satwa Shop': 754, 'Shabiya Shop': 2184 },
      { Date: '2025-03-30', 'Barsha Shop': 2413.9, 'Hamdan Shop': 5554.9, 'Khalydiha Shop': 3767, 'Mouroor Shop': 3191, 'Satwa Shop': 1594.9, 'Shabiya Shop': 2223 },
      { Date: '2025-03-31', 'Barsha Shop': 1856, 'Hamdan Shop': 6045.9, 'Khalydiha Shop': 2827.9, 'Mouroor Shop': 3195.9, 'Satwa Shop': 1519, 'Shabiya Shop': 2321 },
      { Date: '2025-04-01', 'Barsha Shop': 2059, 'Hamdan Shop': 4877.15, 'Khalydiha Shop': 2128.9, 'Mouroor Shop': 2820.8, 'Satwa Shop': 909, 'Shabiya Shop': 1286 },
      { Date: '2025-04-02', 'Barsha Shop': 1618, 'Hamdan Shop': 2944.9, 'Khalydiha Shop': 1092, 'Mouroor Shop': 1512.8, 'Satwa Shop': 745, 'Shabiya Shop': 1440 },
      { Date: '2025-04-03', 'Barsha Shop': 1321.8, 'Hamdan Shop': 2491, 'Khalydiha Shop': 1660.9, 'Mouroor Shop': 1260.9, 'Satwa Shop': 948, 'Shabiya Shop': 1077 },
      { Date: '2025-04-04', 'Barsha Shop': 1945, 'Hamdan Shop': 3929, 'Khalydiha Shop': 2218.9, 'Mouroor Shop': 2534.9, 'Satwa Shop': 859, 'Shabiya Shop': 885 },
      { Date: '2025-04-05', 'Barsha Shop': 2258, 'Hamdan Shop': 3508, 'Khalydiha Shop': 1736.9, 'Mouroor Shop': 1572.9, 'Satwa Shop': 1317, 'Shabiya Shop': 1833 },
      { Date: '2025-04-06', 'Barsha Shop': 2016.9, 'Hamdan Shop': 3932.9, 'Khalydiha Shop': 1981.9, 'Mouroor Shop': 1731, 'Satwa Shop': 1098, 'Shabiya Shop': 2401 },
      { Date: '2025-04-07', 'Barsha Shop': 2988.9, 'Hamdan Shop': 5638, 'Khalydiha Shop': 3136, 'Mouroor Shop': 2993, 'Satwa Shop': 1333, 'Shabiya Shop': 3161 }
    ];

    // Initialize with provided September 2025 totals
    let salesData = [];
    const branches = ['Hamdan', 'Shabiya', 'Khalidiyah', 'Muroor', 'Barsha', 'Satwa'];
    const septemberTotals = {
      'Hamdan': { deliveryOrders: 983, deliverySales: 43645.9, peakDay: '2025-09-02', peakSales: 5977.0 },
      'Shabiya': { deliveryOrders: 567, deliverySales: 26410.0, peakDay: '2025-09-02', peakSales: 3384.9 },
      'Khalidiyah': { deliveryOrders: 508, deliverySales: 24320.5, peakDay: '2025-09-02', peakSales: 3238.0 },
      'Muroor': { deliveryOrders: 466, deliverySales: 22598.4, peakDay: '2025-09-02', peakSales: 3221.0 },
      'Barsha': { deliveryOrders: 387, deliverySales: 18809.4, peakDay: '2025-09-01', peakSales: 3207.0 },
      'Satwa': { deliveryOrders: 219, deliverySales: 10039.5, peakDay: '2025-09-02', peakSales: 1500.0 }
    };

    // Process provided delivery sales (Jan–April 2025)
    function processProvidedData() {
      salesData = [];
      providedDeliverySales.forEach(row => {
        branches.forEach(branch => {
          const deliverySales = row[Object.keys(branchMapping).find(key => branchMapping[key] === branch)] || 0;
          const avgOrderValue = septemberTotals[branch].deliverySales / septemberTotals[branch].deliveryOrders;
          const deliveryOrders = Math.round(deliverySales / avgOrderValue);
          salesData.push({
            date: row.Date,
            outlet: branch,
            deliveryOrders: deliveryOrders,
            deliverySales: parseFloat(deliverySales.toFixed(1))
          });
        });
      });
    }

    // Generate dummy data for May–August 2025
    function generateDummyData(month, days) {
      const monthlyFactors = {
        '2025-05': 0.9,
        '2025-06': 0.95,
        '2025-07': 1.0,
        '2025-08': 1.05
      };
      const data = [];
      for (let day = 1; day <= days; day++) {
        const date = `${month}-${String(day).padStart(2, '0')}`;
        branches.forEach(branch => {
          const factor = monthlyFactors[month];
          const avgOrderValue = septemberTotals[branch].deliverySales / septemberTotals[branch].deliveryOrders;
          const dailyDeliverySales = (septemberTotals[branch].deliverySales / 24 * factor).toFixed(1);
          const dailyDeliveryOrders = Math.round(dailyDeliverySales / avgOrderValue);
          data.push({
            date,
            outlet: branch,
            deliveryOrders: dailyDeliveryOrders,
            deliverySales: parseFloat(dailyDeliverySales)
          });
        });
      }
      return data;
    }

    // Generate September 2025 data
    function generateSeptemberData() {
      for (let day = 1; day <= 24; day++) {
        const date = `2025-09-${String(day).padStart(2, '0')}`;
        branches.forEach(branch => {
          const dailyDeliveryOrders = Math.round(septemberTotals[branch].deliveryOrders / 24);
          const dailyDeliverySales = (septemberTotals[branch].deliverySales / 24).toFixed(1);
          salesData.push({
            date,
            outlet: branch,
            deliveryOrders: dailyDeliveryOrders,
            deliverySales: parseFloat(dailyDeliverySales)
          });
        });
      }
      // Adjust last day to match September totals
      const lastDayData = salesData.filter(d => d.date === '2025-09-24');
      branches.forEach(branch => {
        const branchData = salesData.filter(d => d.outlet === branch);
        const currentDeliveryOrders = branchData.reduce((sum, d) => sum + d.deliveryOrders, 0);
        const currentDeliverySales = branchData.reduce((sum, d) => sum + d.deliverySales, 0);
        const lastDayEntry = lastDayData.find(d => d.outlet === branch);
        lastDayEntry.deliveryOrders += septemberTotals[branch].deliveryOrders - currentDeliveryOrders;
        lastDayEntry.deliverySales += septemberTotals[branch].deliverySales - currentDeliverySales;
        lastDayEntry.deliverySales = parseFloat(lastDayEntry.deliverySales.toFixed(1));
      });
    }

    // Initialize data
    function initializeData() {
      processProvidedData();
      salesData = salesData.concat(generateDummyData('2025-05', 31));
      salesData = salesData.concat(generateDummyData('2025-06', 30));
      salesData = salesData.concat(generateDummyData('2025-07', 31));
      salesData = salesData.concat(generateDummyData('2025-08', 31));
      generateSeptemberData();
    }

    // Goals and targets
    let goals = {
      monthly: {
        sales: 150000,
        orders: 3000
      },
      branch: {}
    };

    // Load saved data from localStorage
    const savedData = localStorage.getItem('salesData');
    if (savedData) {
      salesData = JSON.parse(savedData);
    }

    // Load saved goals
    const savedGoals = localStorage.getItem('dashboardGoals');
    if (savedGoals) {
      goals = JSON.parse(savedGoals);
    }

    // Initialize DataTable and Charts
    $(document).ready(function() {
      const table = $('#dataTable').DataTable({
        data: salesData,
        columns: [
          { data: 'date', render: data => data ? new Date(data).toLocaleDateString('en-GB') : '' },
          { data: 'outlet' },
          { data: 'deliveryOrders' },
          { data: 'deliverySales', render: data => data ? parseFloat(data).toLocaleString('en-AE', { minimumFractionDigits: 1 }) + ' AED' : '' },
          {
            data: null,
            render: (data, type, row, meta) => `
              <button onclick="editRow(${meta.row})" class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</button>
              <button onclick="deleteRow(${meta.row})" class="px-2 py-1 bg-red-500 text-white rounded">Delete</button>
            `
          }
        ],
        pageLength: 10,
        order: [[0, 'desc']],
        language: { searchPlaceholder: 'Search records...', search: '' }
      });

      // Month filter
      $('#monthFilterTop').on('change', function() {
        const month = $(this).val();
        table.draw();
        updateKpis(month);
        renderBranches(month);
        updateCharts(month);
        updateGoalsProgress();
        generateThreeMonthReport();
      });

      // Custom DataTable filter
      $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
        const month = $('#monthFilterTop').val();
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        const selectedBranches = Array.from($('#branchFilter').val());
        const row = salesData[dataIndex];
        const rowDate = row.date;
        const rowOutlet = row.outlet;
        if (month !== 'all' && rowDate && !rowDate.startsWith(month)) return false;
        if (startDate && rowDate < startDate) return false;
        if (endDate && rowDate > endDate) return false;
        if (!selectedBranches.includes('all') && !selectedBranches.includes(rowOutlet)) return false;
        return true;
      });

      // Apply filters
      $('#applyFilters').on('click', function() {
        showLoading();
        setTimeout(() => {
          table.draw();
          updateKpis($('#monthFilterTop').val());
          renderBranches($('#monthFilterTop').val());
          updateCharts($('#monthFilterTop').val());
          updateGoalsProgress();
          generateThreeMonthReport();
          hideLoading();
          showNotification('Filters applied', 'success');
        }, 500);
      });

      // Initialize with September 2025 data
      updateKpis('2025-09');
      renderBranches('2025-09');
      updateCharts('2025-09');
      updateGoalsProgress();
      updateLastUpdated();
      generateInsights();
      updateAuditLog();
      generateThreeMonthReport();

      // Event listeners
      $('#btnClearInput').on('click', () => $('#dataInput').val(''));
      $('#btnUpdate').on('click', updateData);
      $('#btnExportCSV').on('click', exportCSV);
      $('#btnExportPDF').on('click', exportPDF);
      $('#btnExportExcel').on('click', exportExcel);
      $('#btnScheduleExport').on('click', showScheduleModal);
      $('#btnPresentMode').on('click', enterPresentMode);
      $('#btnReset').on('click', resetData);
      $('#btnClearAll').on('click', clearAllData);
      $('#darkModeToggle').on('click', () => $('html').toggleClass('dark'));
      $('#btnTour').on('click', startTour);
      $('#btnSetGoals').on('click', showGoalModal);
      $('#refreshReport').on('click', () => {
        showLoading();
        setTimeout(() => {
          generateThreeMonthReport();
          hideLoading();
          showNotification('Report refreshed', 'success');
        }, 500);
      });

      // Drill-down functionality
      $('.drillable').on('click', function() {
        const metric = $(this).data('metric');
        const drillType = $(this).data('drill-type');
        showDrilldown(metric, drillType);
      });

      // Resize charts on window resize
      window.addEventListener('resize', () => {
        if (barChart) barChart.resize();
        if (lineChart) lineChart.resize();
        if (pieChart) pieChart.resize();
      });

      // Initialize guided tour
      initializeTour();
    });

    // Chart instances
    let barChart, lineChart, pieChart;

    // Update KPIs with enhanced formatting
    function updateKpis(month) {
      const filteredData = month === 'all' ? salesData : salesData.filter(d => d.date && d.date.startsWith(month));
      const totalDeliverySales = filteredData.reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0);
      const totalDeliveryOrders = filteredData.reduce((sum, d) => sum + (d.deliveryOrders || 0), 0);
      const avgDeliveryOrderValue = totalDeliveryOrders ? (totalDeliverySales / totalDeliveryOrders).toFixed(1) : 0;
      const branchSales = branches.map(branch => ({
        branch,
        deliverySales: filteredData.filter(d => d.outlet === branch).reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0)
      }));
      const topBranch = branchSales.reduce((max, b) => b.deliverySales > max.deliverySales ? b : max, { branch: '—', deliverySales: 0 }).branch;
      const peakDayData = filteredData.reduce((max, d) => (!max || (parseFloat(d.deliverySales) || 0) > max.deliverySales ? { date: d.date, deliverySales: parseFloat(d.deliverySales) || 0 } : max), { date: '—', deliverySales: 0 });
      const peakOrdersData = filteredData.reduce((max, d) => (!max || (d.deliveryOrders || 0) > max.deliveryOrders ? { date: d.date, deliveryOrders: d.deliveryOrders || 0 } : max), { date: '—', deliveryOrders: 0 });
      const prevMonth = month === 'all' ? null : (month === '2025-01' ? null : `${parseInt(month.split('-')[0]) - 1}-12`);
      const prevSales = prevMonth ? salesData.filter(d => d.date && d.date.startsWith(prevMonth)).reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0) : 0;
      const prevOrders = prevMonth ? salesData.filter(d => d.date && d.date.startsWith(prevMonth)).reduce((sum, d) => sum + (d.deliveryOrders || 0), 0) : 0;
      const salesDelta = prevSales ? ((totalDeliverySales - prevSales) / prevSales * 100).toFixed(1) : 0;
      const ordersDelta = prevOrders ? ((totalDeliveryOrders - prevOrders) / prevOrders * 100).toFixed(1) : 0;

      // Update KPIs with animations
      animateValue('kpiSales', totalDeliverySales, ' AED');
      animateValue('kpiOrders', totalDeliveryOrders);
      $('#kpiAOV').text(avgDeliveryOrderValue + ' AED');
      $('#kpiTopBranch').text(topBranch);
      $('#kpiPeakDay').text(peakDayData.date !== '—' ? new Date(peakDayData.date).toLocaleDateString('en-GB') : '—');
      $('#kpiPeakOrders').text(peakOrdersData.date !== '—' ? new Date(peakOrdersData.date).toLocaleDateString('en-GB') : '—');
      
      // Update delta badges with conditional formatting
      const salesDeltaEl = $('#kpiSalesDelta');
      salesDeltaEl.text(salesDelta >= 0 ? `+${salesDelta}%` : `${salesDelta}%`)
        .removeClass('badge-up badge-down badge-warning')
        .addClass(salesDelta >= 0 ? 'badge-up' : salesDelta >= -10 ? 'badge-warning' : 'badge-down');
      
      const ordersDeltaEl = $('#kpiOrdersGrowth');
      ordersDeltaEl.text(ordersDelta >= 0 ? `+${ordersDelta}%` : `${ordersDelta}%`)
        .removeClass('badge-up badge-down badge-warning')
        .addClass(ordersDelta >= 0 ? 'badge-up' : ordersDelta >= -10 ? 'badge-warning' : 'badge-down');
    }

    // Animate value changes
    function animateValue(id, end, suffix = '') {
      const el = document.getElementById(id);
      const start = parseInt(el.innerText.replace(/[^0-9.-]+/g, '')) || 0;
      const duration = 1000;
      const startTime = performance.now();
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const value = Math.floor(start + (end - start) * progress);
        el.innerText = value.toLocaleString('en-AE') + suffix;
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }

    // Render branch performance cards with enhanced features
    function renderBranches(month) {
      const filteredData = month === 'all' ? salesData : salesData.filter(d => d.date && d.date.startsWith(month));
      const branchMetrics = branches.map(branch => {
        const branchData = filteredData.filter(d => d.outlet === branch);
        const totalDeliveryOrders = branchData.reduce((sum, d) => sum + (d.deliveryOrders || 0), 0);
        const totalDeliverySales = branchData.reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0);
        const avgDeliveryOrder = totalDeliveryOrders ? (totalDeliverySales / totalDeliveryOrders).toFixed(1) : 0;
        const peakDayData = month === '2025-09' ? septemberTotals[branch] : branchData.reduce((max, d) => (!max || (parseFloat(d.deliverySales) || 0) > max.deliverySales ? { date: d.date, deliverySales: parseFloat(d.deliverySales) || 0 } : max), { date: '—', deliverySales: 0 });
        
        // Calculate goal progress
        const branchGoal = goals.branch[branch] || { sales: totalDeliverySales * 1.2, orders: totalDeliveryOrders * 1.2 };
        const salesProgress = Math.min(100, (totalDeliverySales / branchGoal.sales) * 100);
        const ordersProgress = Math.min(100, (totalDeliveryOrders / branchGoal.orders) * 100);
        
        return {
          branch,
          totalDeliveryOrders,
          totalDeliverySales: totalDeliverySales.toFixed(1),
          avgDeliveryOrder,
          peakDay: peakDayData.date !== '—' ? `${new Date(peakDayData.date).toLocaleDateString('en-GB')} (${peakDayData.deliverySales.toLocaleString('en-AE', { minimumFractionDigits: 1 })} AED)` : '—',
          salesProgress,
          ordersProgress,
          anomaly: detectBranchAnomaly(branchData)
        };
      });

      const row1Container = $('#branchRow1');
      const row2Container = $('#branchRow2');
      row1Container.html(branchMetrics.slice(0, 3).map(metric => `
        <div class="card branch-card expandable p-4 min-w-[12rem] h-auto" onclick="toggleCard(this)">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold text-base">${metric.branch}</h3>
            ${metric.anomaly ? '<div class="anomaly-marker"></div>' : ''}
          </div>
          <div class="mt-2">
            <div class="small">Delivery Orders: <span>${metric.totalDeliveryOrders.toLocaleString('en-AE')}</span></div>
            <div class="small">Delivery Sales: <span>${metric.totalDeliverySales.toLocaleString('en-AE', { minimumFractionDigits: 1 })} AED</span></div>
            <div class="small mt-1">Avg Delivery Order: <span>${metric.avgDeliveryOrder} AED</span></div>
            <div class="small mt-1">Peak Day: <span>${metric.peakDay}</span></div>
            
            <div class="mt-3">
              <div class="text-xs mb-1">Sales Goal Progress: ${metric.salesProgress.toFixed(1)}%</div>
              <div class="goal-progress">
                <div class="goal-progress-bar" style="width: ${metric.salesProgress}%"></div>
              </div>
            </div>
            
            <div class="details mt-2">
              <div class="small">Compare to Previous Period: <a href="#" onclick="showComparison('${metric.branch}'); return false;">Analyze</a></div>
            </div>
            <div class="small mt-2 text-gray-500">Click to expand</div>
          </div>
        </div>
      `).join(''));
      row2Container.html(branchMetrics.slice(3, 6).map(metric => `
        <div class="card branch-card expandable p-4 min-w-[12rem] h-auto" onclick="toggleCard(this)">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold text-base">${metric.branch}</h3>
            ${metric.anomaly ? '<div class="anomaly-marker"></div>' : ''}
          </div>
          <div class="mt-2">
            <div class="small">Delivery Orders: <span>${metric.totalDeliveryOrders.toLocaleString('en-AE')}</span></div>
            <div class="small">Delivery Sales: <span>${metric.totalDeliverySales.toLocaleString('en-AE', { minimumFractionDigits: 1 })} AED</span></div>
            <div class="small mt-1">Avg Delivery Order: <span>${metric.avgDeliveryOrder} AED</span></div>
            <div class="small mt-1">Peak Day: <span>${metric.peakDay}</span></div>
            
            <div class="mt-3">
              <div class="text-xs mb-1">Orders Goal Progress: ${metric.ordersProgress.toFixed(1)}%</div>
              <div class="goal-progress">
                <div class="goal-progress-bar" style="width: ${metric.ordersProgress}%"></div>
              </div>
            </div>
            
            <div class="details mt-2">
              <div class="small">Compare to Previous Period: <a href="#" onclick="showComparison('${metric.branch}'); return false;">Analyze</a></div>
            </div>
            <div class="small mt-2 text-gray-500">Click to expand</div>
          </div>
        </div>
      `).join(''));
    }

    // Generate Three Month Report
    function generateThreeMonthReport() {
      const container = $('#threeMonthReportContainer');
      const month = $('#monthFilterTop').val();
      
      // Get the last three months
      let months = [];
      if (month === 'all') {
        months = ['2025-07', '2025-08', '2025-09'];
      } else {
        const year = parseInt(month.split('-')[0]);
        const monthNum = parseInt(month.split('-')[1]);
        
        if (monthNum >= 3) {
          months = [
            `${year}-${String(monthNum - 2).padStart(2, '0')}`,
            `${year}-${String(monthNum - 1).padStart(2, '0')}`,
            `${year}-${String(monthNum).padStart(2, '0')}`
          ];
        } else {
          // Handle year transition
          months = [
            `${year - 1}-${String(12 + monthNum - 2).padStart(2, '0')}`,
            `${year - 1}-${String(12 + monthNum - 1).padStart(2, '0')}`,
            `${year}-${String(monthNum).padStart(2, '0')}`
          ];
        }
      }
      
      const monthNames = {
        '2025-07': 'July 2025',
        '2025-08': 'August 2025',
        '2025-09': 'September 2025'
      };
      
      // Generate report for each branch
      const reportHtml = branches.map(branch => {
        const branchData = months.map(month => {
          const data = salesData.filter(d => d.outlet === branch && d.date.startsWith(month));
          const totalSales = data.reduce((sum, d) => sum + d.deliverySales, 0);
          const totalOrders = data.reduce((sum, d) => sum + d.deliveryOrders, 0);
          return {
            month,
            monthName: monthNames[month] || month,
            totalSales,
            totalOrders,
            avgOrderValue: totalOrders > 0 ? totalSales / totalOrders : 0
          };
        });
        
        // Calculate growth percentages
        const growth1 = branchData[1].totalSales > 0 
          ? ((branchData[2].totalSales - branchData[1].totalSales) / branchData[1].totalSales * 100).toFixed(1)
          : 0;
        const growth2 = branchData[0].totalSales > 0 
          ? ((branchData[1].totalSales - branchData[0].totalSales) / branchData[0].totalSales * 100).toFixed(1)
          : 0;
        
        // Determine performance indicator
        let performanceClass = 'performance-stable';
        let performanceText = 'Stable';
        if (parseFloat(growth1) > 5) {
          performanceClass = 'performance-up';
          performanceText = 'Growing';
        } else if (parseFloat(growth1) < -5) {
          performanceClass = 'performance-down';
          performanceText = 'Declining';
        }
        
        return `
          <div class="report-card">
            <div class="report-header">
              <div class="report-title">${branch} Branch</div>
              <div class="report-period">Three-Month Analysis</div>
            </div>
            
            <table class="report-table">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Delivery Sales (AED)</th>
                  <th>Delivery Orders</th>
                  <th>Avg Order Value</th>
                  <th>Growth</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${branchData[0].monthName}</td>
                  <td>${branchData[0].totalSales.toLocaleString('en-AE', { minimumFractionDigits: 1 })}</td>
                  <td>${branchData[0].totalOrders.toLocaleString('en-AE')}</td>
                  <td>${branchData[0].avgOrderValue.toFixed(1)}</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td>${branchData[1].monthName}</td>
                  <td>${branchData[1].totalSales.toLocaleString('en-AE', { minimumFractionDigits: 1 })}</td>
                  <td>${branchData[1].totalOrders.toLocaleString('en-AE')}</td>
                  <td>${branchData[1].avgOrderValue.toFixed(1)}</td>
                  <td class="${growth2 >= 0 ? 'growth-positive' : 'growth-negative'}">${growth2 >= 0 ? '+' : ''}${growth2}%</td>
                </tr>
                <tr>
                  <td><strong>${branchData[2].monthName}</strong></td>
                  <td><strong>${branchData[2].totalSales.toLocaleString('en-AE', { minimumFractionDigits: 1 })}</strong></td>
                  <td><strong>${branchData[2].totalOrders.toLocaleString('en-AE')}</strong></td>
                  <td><strong>${branchData[2].avgOrderValue.toFixed(1)}</strong></td>
                  <td class="${growth1 >= 0 ? 'growth-positive' : 'growth-negative'}"><strong>${growth1 >= 0 ? '+' : ''}${growth1}%</strong></td>
                </tr>
              </tbody>
            </table>
            
            <div class="branch-summary">
              <div class="branch-performance">
                <div class="performance-indicator ${performanceClass}"></div>
                <span>${performanceText} Performance</span>
              </div>
              <div class="report-actions">
                <button class="report-action primary" onclick="exportBranchReport('${branch}')">Export Report</button>
                <button class="report-action secondary" onclick="showBranchDetails('${branch}')">View Details</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.html(reportHtml);
    }

    // Export branch report
    function exportBranchReport(branch) {
      showLoading();
      
      const month = $('#monthFilterTop').val();
      let months = [];
      if (month === 'all') {
        months = ['2025-07', '2025-08', '2025-09'];
      } else {
        const year = parseInt(month.split('-')[0]);
        const monthNum = parseInt(month.split('-')[1]);
        
        if (monthNum >= 3) {
          months = [
            `${year}-${String(monthNum - 2).padStart(2, '0')}`,
            `${year}-${String(monthNum - 1).padStart(2, '0')}`,
            `${year}-${String(monthNum).padStart(2, '0')}`
          ];
        } else {
          months = [
            `${year - 1}-${String(12 + monthNum - 2).padStart(2, '0')}`,
            `${year - 1}-${String(12 + monthNum - 1).padStart(2, '0')}`,
            `${year}-${String(monthNum).padStart(2, '0')}`
          ];
        }
      }
      
      const monthNames = {
        '2025-07': 'July 2025',
        '2025-08': 'August 2025',
        '2025-09': 'September 2025'
      };
      
      const branchData = months.map(month => {
        const data = salesData.filter(d => d.outlet === branch && d.date.startsWith(month));
        const totalSales = data.reduce((sum, d) => sum + d.deliverySales, 0);
        const totalOrders = data.reduce((sum, d) => sum + d.deliveryOrders, 0);
        return {
          month,
          monthName: monthNames[month] || month,
          totalSales,
          totalOrders,
          avgOrderValue: totalOrders > 0 ? totalSales / totalOrders : 0
        };
      });
      
      // Calculate growth percentages
      const growth1 = branchData[1].totalSales > 0 
        ? ((branchData[2].totalSales - branchData[1].totalSales) / branchData[1].totalSales * 100).toFixed(1)
        : 0;
      const growth2 = branchData[0].totalSales > 0 
        ? ((branchData[1].totalSales - branchData[0].totalSales) / branchData[0].totalSales * 100).toFixed(1)
        : 0;
      
      // Create PDF report
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text(`Crispy Chicken - ${branch} Branch Report`, 20, 20);
      doc.setFontSize(12);
      doc.text(`Three-Month Delivery Sales Analysis`, 20, 30);
      doc.text(`Generated: ${new Date().toLocaleDateString('en-GB')}`, 20, 40);
      
      // Add table
      let y = 60;
      doc.setFontSize(10);
      doc.text('Month', 20, y);
      doc.text('Delivery Sales (AED)', 80, y);
      doc.text('Delivery Orders', 140, y);
      doc.text('Avg Order Value', 180, y);
      doc.text('Growth', 220, y);
      
      y += 10;
      branchData.forEach((data, index) => {
        if (index === 0) {
          doc.text(data.monthName, 20, y);
          doc.text(data.totalSales.toLocaleString('en-AE', { minimumFractionDigits: 1 }), 80, y);
          doc.text(data.totalOrders.toLocaleString('en-AE'), 140, y);
          doc.text(data.avgOrderValue.toFixed(1), 180, y);
          doc.text('-', 220, y);
        } else if (index === 1) {
          doc.text(data.monthName, 20, y);
          doc.text(data.totalSales.toLocaleString('en-AE', { minimumFractionDigits: 1 }), 80, y);
          doc.text(data.totalOrders.toLocaleString('en-AE'), 140, y);
          doc.text(data.avgOrderValue.toFixed(1), 180, y);
          doc.text(`${growth2 >= 0 ? '+' : ''}${growth2}%`, 220, y);
        } else {
          doc.setFont('helvetica', 'bold');
          doc.text(data.monthName, 20, y);
          doc.text(data.totalSales.toLocaleString('en-AE', { minimumFractionDigits: 1 }), 80, y);
          doc.text(data.totalOrders.toLocaleString('en-AE'), 140, y);
          doc.text(data.avgOrderValue.toFixed(1), 180, y);
          doc.text(`${growth1 >= 0 ? '+' : ''}${growth1}%`, 220, y);
          doc.setFont('helvetica', 'normal');
        }
        y += 10;
      });
      
      // Add summary
      y += 20;
      doc.text('Summary:', 20, y);
      y += 10;
      doc.text(`- Total 3-month sales: ${branchData.reduce((sum, d) => sum + d.totalSales, 0).toLocaleString('en-AE', { minimumFractionDigits: 1 })} AED`, 20, y);
      y += 10;
      doc.text(`- Total 3-month orders: ${branchData.reduce((sum, d) => sum + d.totalOrders, 0).toLocaleString('en-AE')}`, 20, y);
      y += 10;
      doc.text(`- Average monthly growth: ${((parseFloat(growth1) + parseFloat(growth2)) / 2).toFixed(1)}%`, 20, y);
      
      doc.save(`${branch}_branch_report.pdf`);
      
      hideLoading();
      showNotification(`${branch} branch report exported`, 'success');
      updateAuditLog();
    }

    // Show branch details
    function showBranchDetails(branch) {
      const month = $('#monthFilterTop').val();
      let months = [];
      if (month === 'all') {
        months = ['2025-07', '2025-08', '2025-09'];
      } else {
        const year = parseInt(month.split('-')[0]);
        const monthNum = parseInt(month.split('-')[1]);
        
        if (monthNum >= 3) {
          months = [
            `${year}-${String(monthNum - 2).padStart(2, '0')}`,
            `${year}-${String(monthNum - 1).padStart(2, '0')}`,
            `${year}-${String(monthNum).padStart(2, '0')}`
          ];
        } else {
          months = [
            `${year - 1}-${String(12 + monthNum - 2).padStart(2, '0')}`,
            `${year - 1}-${String(12 + monthNum - 1).padStart(2, '0')}`,
            `${year}-${String(monthNum).padStart(2, '0')}`
          ];
        }
      }
      
      const branchData = months.map(month => {
        const data = salesData.filter(d => d.outlet === branch && d.date.startsWith(month));
        const totalSales = data.reduce((sum, d) => sum + d.deliverySales, 0);
        const totalOrders = data.reduce((sum, d) => sum + d.deliveryOrders, 0);
        return {
          month,
          totalSales,
          totalOrders,
          data
        };
      });
      
      // Show drilldown modal with branch details
      const modal = $('#drillModal');
      const title = $('#drillModalTitle');
      const content = $('#drillModalContent');
      
      title.text(`${branch} Branch - Detailed Analysis`);
      content.html(`
        <div class="mb-4">
          <h4 class="font-semibold mb-2">Monthly Summary</h4>
          <div class="grid grid-cols-3 gap-4">
            ${branchData.map(data => `
              <div class="bg-gray-50 p-4 rounded-lg">
                <h5 class="font-medium">${data.month}</h5>
                <p>Sales: ${data.totalSales.toLocaleString('en-AE', { minimumFractionDigits: 1 })} AED</p>
                <p>Orders: ${data.totalOrders.toLocaleString('en-AE')}</p>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="mb-4">
          <h4 class="font-semibold mb-2">Daily Sales Trend</h4>
          <canvas id="branchDetailChart" height="200"></canvas>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Top Performing Days</h4>
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-100">
                <th class="border p-2 text-left">Date</th>
                <th class="border p-2 text-left">Sales (AED)</th>
                <th class="border p-2 text-left">Orders</th>
              </tr>
            </thead>
            <tbody>
              ${branchData[2].data
                .sort((a, b) => b.deliverySales - a.deliverySales)
                .slice(0, 5)
                .map(row => `
                  <tr>
                    <td class="border p-2">${new Date(row.date).toLocaleDateString('en-GB')}</td>
                    <td class="border p-2">${row.deliverySales.toLocaleString('en-AE', { minimumFractionDigits: 1 })}</td>
                    <td class="border p-2">${row.deliveryOrders}</td>
                  </tr>
                `).join('')}
            </tbody>
          </table>
        </div>
      `);
      
      modal.removeClass('hidden');
      
      // Create chart
      setTimeout(() => {
        const ctx = document.getElementById('branchDetailChart').getContext('2d');
        const dailyData = {};
        
        branchData.forEach(monthData => {
          monthData.data.forEach(day => {
            if (!dailyData[day.date]) {
              dailyData[day.date] = 0;
            }
            dailyData[day.date] += day.deliverySales;
          });
        });
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: Object.keys(dailyData),
            datasets: [{
              label: 'Daily Sales',
              data: Object.values(dailyData),
              borderColor: '#d7263d',
              backgroundColor: 'rgba(215, 38, 61, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Sales (AED)'
                }
              }
            }
          }
        });
      }, 100);
    }

    // Detect anomalies in branch data
    function detectBranchAnomaly(branchData) {
      if (branchData.length < 7) return false;
      
      const sales = branchData.map(d => d.deliverySales);
      const mean = sales.reduce((a, b) => a + b, 0) / sales.length;
      const stdDev = Math.sqrt(sales.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / sales.length);
      
      const recent = sales.slice(-7);
      const recentMean = recent.reduce((a, b) => a + b, 0) / recent.length;
      
      return Math.abs(recentMean - mean) > 1.5 * stdDev;
    }

    // Toggle card expansion
    function toggleCard(element) {
      $(element).toggleClass('expanded');
      $(element).find('.details').slideToggle(300);
      const toggleText = $(element).find('.small.text-gray-500');
      toggleText.text($(element).hasClass('expanded') ? 'Click to collapse' : 'Click to expand');
    }

    // Update charts with enhanced features
    function updateCharts(month) {
      const filteredData = month === 'all' ? salesData : salesData.filter(d => d.date && d.date.startsWith(month));
      const days = Array.from({ length: 31 }, (_, i) => `${i + 1}`);
      const branchTotals = branches.map(branch => ({
        branch,
        deliverySales: filteredData.filter(d => d.outlet === branch).reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0)
      }));

      // Bar Chart with conditional formatting
      if (barChart) barChart.destroy();
      barChart = new Chart($('#barChart'), {
        type: 'bar',
        data: {
          labels: branches,
          datasets: [{
            label: `Delivery Sales (${month === 'all' ? 'Jan–Sep 2025' : month})`,
            data: branchTotals.map(b => b.deliverySales),
            backgroundColor: branchTotals.map(b => {
              const goal = goals.branch[b.branch] || { sales: b.deliverySales * 1.2 };
              const progress = (b.deliverySales / goal.sales) * 100;
              return progress >= 100 ? '#10b981' : progress >= 80 ? '#f59e0b' : '#ef4444';
            }),
            borderColor: branchTotals.map(b => {
              const goal = goals.branch[b.branch] || { sales: b.deliverySales * 1.2 };
              const progress = (b.deliverySales / goal.sales) * 100;
              return progress >= 100 ? '#10b981' : progress >= 80 ? '#f59e0b' : '#ef4444';
            }),
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { 
              beginAtZero: true, 
              title: { display: true, text: 'Delivery Sales (AED)' },
              ticks: {
                callback: function(value) {
                  return 'AED ' + value.toLocaleString();
                }
              }
            },
            x: { 
              title: { display: true, text: 'Branch' },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          },
          plugins: {
            legend: { display: true, position: 'top' },
            title: { display: true, text: `Delivery Sales by Branch` },
            datalabels: {
              anchor: 'end',
              align: 'top',
              formatter: value => 'AED ' + value.toLocaleString('en-AE', { minimumFractionDigits: 1 })
            }
          }
        }
      });

      // Line Chart
      if (lineChart) lineChart.destroy();
      const dailySales = days.map((day, i) => {
        const date = `${month || '2025-09'}-${String(i + 1).padStart(2, '0')}`;
        return filteredData.filter(d => d.date === date).reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0);
      });
      lineChart = new Chart($('#lineChart'), {
        type: 'line',
        data: {
          labels: days.slice(0, filteredData.length ? Math.max(...filteredData.map(d => parseInt(d.date.split('-')[2] || 0))) : 31),
          datasets: [{
            label: 'Daily Delivery Sales',
            data: dailySales,
            borderColor: '#d7263d',
            backgroundColor: 'rgba(215, 38, 61, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          scales: {
            y: { 
              beginAtZero: true, 
              title: { display: true, text: 'Delivery Sales (AED)' },
              ticks: {
                callback: function(value) {
                  return 'AED ' + value.toLocaleString();
                }
              }
            },
            x: { 
              title: { display: true, text: `Date (${month === 'all' ? 'Jan–Sep 2025' : month})` }
            }
          },
          plugins: {
            legend: { display: true, position: 'top' },
            title: { display: true, text: `Daily Delivery Sales Trend` },
            annotation: {
              annotations: month === '2025-09' ? {
                note: {
                  type: 'label',
                  xValue: 23,
                  yValue: dailySales[23],
                  content: ['Note: 24 Sep data adjusted'],
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  borderColor: 'rgb(255, 99, 132)',
                  borderWidth: 1,
                  font: { size: 10 }
                }
              } : {}
            }
          }
        }
      });

      // Pie Chart with enhanced labels
      if (pieChart) pieChart.destroy();
      pieChart = new Chart($('#pieChart'), {
        type: 'pie',
        data: {
          labels: branches,
          datasets: [{
            label: 'Delivery Sales Distribution',
            data: branchTotals.map(b => b.deliverySales),
            backgroundColor: ['#1b9e77', '#d95f02', '#7570b3', '#e7298a', '#66a61e', '#e6ab02'],
            borderColor: ['#fff', '#fff', '#fff', '#fff', '#fff', '#fff'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { display: true, position: 'top' },
            title: { display: true, text: `Delivery Sales Distribution by Branch` },
            datalabels: {
              formatter: (value, context) => {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                return ((value / total) * 100).toFixed(1) + '%';
              },
              color: '#fff',
              font: { weight: 'bold' }
            }
          }
        }
      });
    }

    // Enhanced insights generation
    function generateInsights() {
      const insights = [];
      
      // Check for significant changes
      const changes = identifySignificantChanges();
      changes.forEach(change => {
        insights.push({
          type: change.percentage > 20 ? 'critical' : 'warning',
          icon: change.percentage > 20 ? '⚠️' : '📊',
          title: `${change.branch} ${change.metric} changed by ${change.percentage}%`,
          context: `Compared to ${change.period}`,
          recommendation: change.percentage > 20 ? 'Investigate immediately' : 'Monitor closely',
          actions: [
            { text: 'View Details', type: 'primary' },
            { text: 'Ignore', type: 'secondary' }
          ]
        });
      });
      
      // Check for trends
      const trends = identifyTrends();
      trends.forEach(trend => {
        insights.push({
          type: trend.direction === 'up' ? 'success' : 'info',
          icon: trend.direction === 'up' ? '📈' : '📉',
          title: `Trend detected: ${trend.description}`,
          context: `Based on ${trend.period} data`,
          recommendation: trend.direction === 'up' ? 'Consider increasing capacity' : 'Review marketing strategies',
          actions: [
            { text: 'Analyze', type: 'primary' },
            { text: 'Dismiss', type: 'secondary' }
          ]
        });
      });
      
      // Check for anomalies
      const anomalies = detectAnomalies();
      anomalies.forEach(anomaly => {
        insights.push({
          type: 'critical',
          icon: '🚨',
          title: `Unusual pattern in ${anomaly.branch}`,
          context: `On ${anomaly.date}: ${anomaly.value} AED`,
          recommendation: 'Review for potential issues',
          actions: [
            { text: 'Investigate', type: 'primary' },
            { text: 'Report', type: 'primary' }
          ]
        });
      });
      
      // Add seasonal insights
      const seasonalInsights = getSeasonalInsights();
      seasonalInsights.forEach(insight => {
        insights.push(insight);
      });
      
      // Display insights
      displayInsights(insights);
    }

    // Get seasonal insights
    function getSeasonalInsights() {
      const month = $('#monthFilterTop').val();
      const insights = [];
      
      // Ramadan insight (March-April 2025)
      if (month.startsWith('2025-03') || month.startsWith('2025-04')) {
        insights.push({
          type: 'info',
          icon: '🌙',
          title: 'Ramadan Season Impact',
          context: 'During Ramadan, delivery patterns change significantly',
          recommendation: 'Adjust delivery hours and promotions for iftar',
          actions: [
            { text: 'View Report', type: 'primary' },
            { text: 'Plan Strategy', type: 'primary' }
          ]
        });
      }
      
      // Summer insight (June-August 2025)
      if (month.startsWith('2025-06') || month.startsWith('2025-07') || month.startsWith('2025-08')) {
        insights.push({
          type: 'success',
          icon: '☀️',
          title: 'Summer Sales Boost',
          context: 'Higher sales during summer months',
          recommendation: 'Maintain summer promotions and staffing',
          actions: [
            { text: 'View Trends', type: 'primary' },
            { text: 'Optimize', type: 'secondary' }
          ]
        });
      }
      
      // Back to school insight (September 2025)
      if (month === '2025-09') {
        insights.push({
          type: 'info',
          icon: '🎒',
          title: 'Back to School Season',
          context: 'Increased family orders during school season',
          recommendation: 'Focus on family meal deals and promotions',
          actions: [
            { text: 'View Data', type: 'primary' },
            { text: 'Create Campaign', type: 'primary' }
          ]
        });
      }
      
      return insights;
    }

    // Display insights with enhanced UI
    function displayInsights(insights) {
      const container = $('#insightsContainer');
      const count = $('#insightCount');
      
      count.text(`${insights.length} insight${insights.length !== 1 ? 's' : ''}`);
      
      if (insights.length === 0) {
        container.html(`
          <div class="insight-empty">
            All metrics are within expected ranges. No significant insights to report.
          </div>
        `);
        return;
      }
      
      container.empty();
      
      insights.forEach((insight, index) => {
        const insightEl = $(`
          <div class="insight-item ${insight.type}" style="animation: fadeIn 0.5s ease ${index * 0.1}s both;">
            <div class="insight-header">
              <div class="insight-icon ${insight.type}">
                ${insight.icon}
              </div>
              <div class="insight-title">${insight.title}</div>
            </div>
            <div class="insight-context">${insight.context}</div>
            <div class="insight-recommendation">
              <strong>Recommendation:</strong> ${insight.recommendation}
            </div>
            <div class="insight-actions">
              ${insight.actions.map(action => `
                <div class="insight-action ${action.type}" onclick="handleInsightAction('${insight.type}', '${action.text}')">
                  ${action.text}
                </div>
              `).join('')}
            </div>
          </div>
        `);
        
        container.append(insightEl);
      });
    }

    // Handle insight actions
    function handleInsightAction(type, action) {
      switch(action) {
        case 'View Details':
        case 'Analyze':
          showNotification(`Detailed analysis for ${type} insights requested`, 'info');
          break;
        case 'Investigate':
          showNotification(`Investigation initiated for ${type} issue`, 'warning');
          break;
        case 'Report':
          showNotification(`Report generated for ${type} anomaly`, 'success');
          break;
        case 'View Report':
          showNotification('Seasonal impact report generated', 'info');
          break;
        case 'Plan Strategy':
          showNotification('Strategy planning session scheduled', 'success');
          break;
        case 'Create Campaign':
          showNotification('New campaign creation initiated', 'success');
          break;
        case 'Ignore':
        case 'Dismiss':
          showNotification('Insight dismissed', 'info');
          break;
        default:
          showNotification(`Action: ${action} for ${type} insights`, 'info');
      }
    }

    // Refresh insights
    function refreshInsights() {
      showLoading();
      setTimeout(() => {
        generateInsights();
        hideLoading();
        showNotification('Insights refreshed', 'success');
      }, 800);
    }

    // Identify significant changes
    function identifySignificantChanges() {
      const changes = [];
      const month = $('#monthFilterTop').val();
      const prevMonth = month === 'all' ? null : (month === '2025-01' ? null : `${parseInt(month.split('-')[0]) - 1}-12`);
      
      if (prevMonth) {
        const currentData = salesData.filter(d => d.date.startsWith(month));
        const prevData = salesData.filter(d => d.date.startsWith(prevMonth));
        
        branches.forEach(branch => {
          const currentSales = currentData.filter(d => d.outlet === branch).reduce((sum, d) => sum + d.deliverySales, 0);
          const prevSales = prevData.filter(d => d.outlet === branch).reduce((sum, d) => sum + d.deliverySales, 0);
          
          if (prevSales > 0) {
            const percentage = ((currentSales - prevSales) / prevSales) * 100;
            if (Math.abs(percentage) > 15) {
              changes.push({
                branch,
                metric: 'sales',
                percentage: percentage.toFixed(1),
                period: 'previous month'
              });
            }
          }
        });
      }
      
      return changes;
    }

    // Identify trends
    function identifyTrends() {
      const trends = [];
      const month = $('#monthFilterTop').val();
      const data = month === 'all' ? salesData : salesData.filter(d => d.date.startsWith(month));
      
      // Simple trend detection based on first and last week
      const firstWeek = data.filter(d => {
        const day = parseInt(d.date.split('-')[2]);
        return day <= 7;
      });
      
      const lastWeek = data.filter(d => {
        const day = parseInt(d.date.split('-')[2]);
        return day >= (month === 'all' ? 24 : 24);
      });
      
      if (firstWeek.length > 0 && lastWeek.length > 0) {
        const firstWeekSales = firstWeek.reduce((sum, d) => sum + d.deliverySales, 0);
        const lastWeekSales = lastWeek.reduce((sum, d) => sum + d.deliverySales, 0);
        
        if (lastWeekSales > firstWeekSales * 1.1) {
          trends.push({
            description: 'increasing sales trend',
            direction: 'up',
            period: 'month'
          });
        } else if (lastWeekSales < firstWeekSales * 0.9) {
          trends.push({
            description: 'decreasing sales trend',
            direction: 'down',
            period: 'month'
          });
        }
      }
      
      return trends;
    }

    // Detect anomalies
    function detectAnomalies() {
      const anomalies = [];
      const month = $('#monthFilterTop').val();
      const data = month === 'all' ? salesData : salesData.filter(d => d.date.startsWith(month));
      
      // Check for days with unusually low sales
      const dailySales = {};
      data.forEach(d => {
        if (!dailySales[d.date]) dailySales[d.date] = [];
        dailySales[d.date].push(d.deliverySales);
      });
      
      Object.keys(dailySales).forEach(date => {
        const sales = dailySales[date];
        const avg = sales.reduce((a, b) => a + b, 0) / sales.length;
        const minSales = Math.min(...sales);
        
        // Check if any branch had unusually low sales
        if (minSales < avg * 0.5) {
          anomalies.push({
            date,
            branch: sales.indexOf(minSales) > -1 ? branches[sales.indexOf(minSales)] : 'Unknown',
            value: minSales,
            reason: 'Unusually low sales for this day'
          });
        }
      });
      
      return anomalies;
    }

    // Update goals progress
    function updateGoalsProgress() {
      const month = $('#monthFilterTop').val();
      const filteredData = month === 'all' ? salesData : salesData.filter(d => d.date && d.date.startsWith(month));
      const totalSales = filteredData.reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0);
      const totalOrders = filteredData.reduce((sum, d) => sum + (d.deliveryOrders || 0), 0);
      
      // Update monthly target progress
      const salesProgress = Math.min(100, (totalSales / goals.monthly.sales) * 100);
      const ordersProgress = Math.min(100, (totalOrders / goals.monthly.orders) * 100);
      
      $('#monthlyTarget').text('AED ' + goals.monthly.sales.toLocaleString());
      $('#monthlyProgress').text(salesProgress.toFixed(1) + '%');
      $('#monthlyProgressBar').css('width', salesProgress + '%');
      
      // Update branch ranking
      const branchRanking = branches.map(branch => {
        const branchData = filteredData.filter(d => d.outlet === branch);
        const branchSales = branchData.reduce((sum, d) => sum + (parseFloat(d.deliverySales) || 0), 0);
        return { branch, sales: branchSales };
      }).sort((a, b) => b.sales - a.sales);
      
      const rankingHtml = branchRanking.slice(0, 3).map((item, index) => `
        <div class="flex justify-between py-1">
          <span>${index + 1}. ${item.branch}</span>
          <span class="font-semibold">AED ${item.sales.toLocaleString({ minimumFractionDigits: 1 })}</span>
        </div>
      `).join('');
      
      $('#branchRanking').html(rankingHtml);
      
      // Update performance alerts
      const alerts = [];
      if (salesProgress < 80) {
        alerts.push({ type: 'warning', message: 'Monthly sales target at risk' });
      }
      if (ordersProgress < 80) {
        alerts.push({ type: 'warning', message: 'Monthly orders target at risk' });
      }
      
      const alertsHtml = alerts.map(alert => `
        <div class="flex items-center gap-2 py-1">
          <span class="w-2 h-2 rounded-full ${
            alert.type === 'warning' ? 'bg-yellow-500' : 'bg-red-500'
          }"></span>
          <span>${alert.message}</span>
        </div>
      `).join('');
      
      if (alerts.length === 0) {
        $('#performanceAlerts').html(`
          <div class="flex items-center gap-2 py-1">
            <span class="w-2 h-2 rounded-full bg-green-500"></span>
            <span>All targets on track</span>
          </div>
        `);
      } else {
        $('#performanceAlerts').html(alertsHtml);
      }
    }

    // Show drilldown modal
    function showDrilldown(metric, type) {
      const modal = $('#drillModal');
      const title = $('#drillModalTitle');
      const content = $('#drillModalContent');
      
      // Update drill path
      updateDrillPath(metric, type);
      
      // Set title based on metric
      switch(metric) {
        case 'sales':
          title.text('Delivery Sales Drill-down');
          content.html(`
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Sales by Branch</h4>
              <canvas id="drilldownSalesChart" height="200"></canvas>
            </div>
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Sales by Date</h4>
              <canvas id="drilldownDateChart" height="200"></canvas>
            </div>
            <div>
              <h4 class="font-semibold mb-2">Sales Distribution</h4>
              <canvas id="drilldownDistChart" height="200"></canvas>
            </div>
          `);
          break;
        case 'orders':
          title.text('Delivery Orders Drill-down');
          content.html(`
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Orders by Branch</h4>
              <canvas id="drilldownOrdersChart" height="200"></canvas>
            </div>
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Orders Trend</h4>
              <canvas id="drilldownOrdersTrendChart" height="200"></canvas>
            </div>
          `);
          break;
        case 'growth':
          title.text('Growth Analysis');
          content.html(`
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Growth by Branch</h4>
              <canvas id="drilldownGrowthChart" height="200"></canvas>
            </div>
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Governing Factors</h4>
              <ul class="list-disc pl-5">
                <li>Seasonal demand fluctuations</li>
                <li>Marketing campaign effectiveness</li>
                <li>Competitor activity</li>
                <li>Operational efficiency</li>
              </ul>
            </div>
          `);
          break;
        case 'top':
          title.text('Top Performer Analysis');
          content.html(`
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Top Branch Performance</h4>
              <div class="bg-gray-50 p-4 rounded-lg">
                <p><strong>Branch:</strong> <span id="topBranchName">Hamdan</span></p>
                <p><strong>Total Sales:</strong> <span id="topBranchSales">AED 43,645.90</span></p>
                <p><strong>Total Orders:</strong> <span id="topBranchOrders">983</span></p>
                <p><strong>Avg Order Value:</strong> <span id="topBranchAOV">AED 44.41</span></p>
                <p><strong>Peak Day:</strong> <span id="topBranchPeak">Sep 2, 2025 (AED 5,977.00)</span></p>
              </div>
            </div>
            <div class="mb-4">
              <h4 class="font-semibold mb-2">Success Factors</h4>
              <ul class="list-disc pl-5">
                <li>Prime location with high foot traffic</li>
                <li>Efficient delivery team</li>
                <li>Strong customer loyalty program</li>
                <li>Effective marketing promotions</li>
              </ul>
            </div>
          `);
          break;
      }
      
      modal.removeClass('hidden');
      
      // Create drilldown charts
      setTimeout(() => {
        createDrilldownCharts(metric);
      }, 100);
    }

    // Update drill path
    function updateDrillPath(metric, type) {
      const drillPath = $('#drillPath');
      drillPath.show();
      
      const pathItems = drillPath.find('.drill-path-item');
      pathItems.removeClass('active');
      
      // Add new drill level
      const drillLevels = {
        'sales': ['Dashboard', 'Sales Overview', 'Branch Sales', 'Daily Sales'],
        'orders': ['Dashboard', 'Orders Overview', 'Branch Orders', 'Daily Orders'],
        'growth': ['Dashboard', 'Growth Analysis', 'Branch Growth', 'Trend Analysis'],
        'top': ['Dashboard', 'Top Performers', 'Branch Analysis', 'Success Factors']
      };
      
      const levels = drillLevels[metric] || ['Dashboard'];
      const currentLevel = levels.length;
      
      // Clear existing path items except the first one
      pathItems.slice(1).remove();
      
      // Add path items
      for (let i = 1; i < levels.length; i++) {
        const item = $(`<div class="drill-path-item ${i === currentLevel - 1 ? 'active' : ''}" data-level="${i}">${levels[i]}</div>`);
        drillPath.append(item);
      }
    }

    // Create drilldown charts
    function createDrilldownCharts(metric) {
      const month = $('#monthFilterTop').val();
      const filteredData = month === 'all' ? salesData : salesData.filter(d => d.date && d.date.startsWith(month));
      
      switch(metric) {
        case 'sales':
          // Sales by branch chart
          const salesByBranchCtx = document.getElementById('drilldownSalesChart').getContext('2d');
          new Chart(salesByBranchCtx, {
            type: 'bar',
            data: {
              labels: branches,
              datasets: [{
                label: 'Sales by Branch',
                data: branches.map(b => filteredData.filter(d => d.outlet === b).reduce((sum, d) => sum + d.deliverySales, 0)),
                backgroundColor: '#d7263d'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
          
          // Sales by date chart
          const salesByDateCtx = document.getElementById('drilldownDateChart').getContext('2d');
          const dailySales = {};
          filteredData.forEach(d => {
            if (!dailySales[d.date]) dailySales[d.date] = 0;
            dailySales[d.date] += d.deliverySales;
          });
          
          new Chart(salesByDateCtx, {
            type: 'line',
            data: {
              labels: Object.keys(dailySales),
              datasets: [{
                label: 'Daily Sales',
                data: Object.values(dailySales),
                borderColor: '#3b82f6',
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
          
          // Sales distribution chart
          const salesDistCtx = document.getElementById('drilldownDistChart').getContext('2d');
          new Chart(salesDistCtx, {
            type: 'pie',
            data: {
              labels: branches,
              datasets: [{
                data: branches.map(b => filteredData.filter(d => d.outlet === b).reduce((sum, d) => sum + d.deliverySales, 0)),
                backgroundColor: ['#1b9e77', '#d95f02', '#7570b3', '#e7298a', '#66a61e', '#e6ab02']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
          break;
          
        case 'orders':
          // Orders by branch chart
          const ordersByBranchCtx = document.getElementById('drilldownOrdersChart').getContext('2d');
          new Chart(ordersByBranchCtx, {
            type: 'bar',
            data: {
              labels: branches,
              datasets: [{
                label: 'Orders by Branch',
                data: branches.map(b => filteredData.filter(d => d.outlet === b).reduce((sum, d) => sum + d.deliveryOrders, 0)),
                backgroundColor: '#10b981'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
          
          // Orders trend chart
          const ordersTrendCtx = document.getElementById('drilldownOrdersTrendChart').getContext('2d');
          const dailyOrders = {};
          filteredData.forEach(d => {
            if (!dailyOrders[d.date]) dailyOrders[d.date] = 0;
            dailyOrders[d.date] += d.deliveryOrders;
          });
          
          new Chart(ordersTrendCtx, {
            type: 'line',
            data: {
              labels: Object.keys(dailyOrders),
              datasets: [{
                label: 'Daily Orders',
                data: Object.values(dailyOrders),
                borderColor: '#8b5cf6',
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
          break;
      }
    }

    // Show goal modal
    function showGoalModal() {
      const modal = $('#goalModal');
      const content = $('#goalModalContent');
      
      content.html(`
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Monthly Sales Target (AED)</label>
          <input type="number" id="goalSales" class="w-full p-2 border rounded" value="${goals.monthly.sales}">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Monthly Orders Target</label>
          <input type="number" id="goalOrders" class="w-full p-2 border rounded" value="${goals.monthly.orders}">
        </div>
        <div class="mb-4">
          <h4 class="font-medium mb-2">Branch Targets</h4>
          ${branches.map(branch => `
            <div class="mb-2">
              <label class="block text-sm mb-1">${branch} Sales Target (AED)</label>
              <input type="number" id="goal-${branch}-sales" class="w-full p-2 border rounded" value="${goals.branch[branch]?.sales || ''}">
            </div>
            <div class="mb-2">
              <label class="block text-sm mb-1">${branch} Orders Target</label>
              <input type="number" id="goal-${branch}-orders" class="w-full p-2 border rounded" value="${goals.branch[branch]?.orders || ''}">
            </div>
          `).join('')}
        </div>
      `);
      
      modal.removeClass('hidden');
    }

    // Save goals
    function saveGoals() {
      goals.monthly.sales = parseInt($('#goalSales').val());
      goals.monthly.orders = parseInt($('#goalOrders').val());
      
      branches.forEach(branch => {
        goals.branch[branch] = {
          sales: parseInt($(`#goal-${branch}-sales`).val()) || goals.monthly.sales / branches.length,
          orders: parseInt($(`#goal-${branch}-orders`).val()) || goals.monthly.orders / branches.length
        };
      });
      
      localStorage.setItem('dashboardGoals', JSON.stringify(goals));
      updateGoalsProgress();
      showNotification('Goals saved successfully', 'success');
      $('#goalModal').addClass('hidden');
    }

    // Show schedule modal
    function showScheduleModal() {
      const modal = $('#scheduleModal');
      modal.removeClass('hidden');
    }

    // Save export schedule
    function saveSchedule() {
      const format = $('#exportFormat').val();
      const frequency = $('#exportFrequency').val();
      const time = $('#exportTime').val();
      const recipients = $('#exportRecipients').val();
      
      // In a real app, this would be sent to a backend
      const schedule = {
        format,
        frequency,
        time,
        recipients,
        created: new Date().toISOString()
      };
      
      localStorage.setItem('exportSchedule', JSON.stringify(schedule));
      showNotification('Export schedule saved', 'success');
      $('#scheduleModal').addClass('hidden');
      
      // Simulate scheduled export
      if (frequency === 'daily') {
        setInterval(() => {
          if (format === 'pdf') exportPDF();
          else if (format === 'excel') exportExcel();
          else exportCSV();
        }, 24 * 60 * 60 * 1000); // Every 24 hours
      }
    }

    // Enter present mode
    function enterPresentMode() {
      $('body').addClass('present-mode');
      showNotification('Entered presentation mode', 'info');
    }

    // Initialize guided tour
    function initializeTour() {
      tour.addStep({
        title: 'Welcome to the Enhanced Dashboard',
        text: 'This dashboard provides comprehensive delivery sales analytics with drill-down capabilities and goal tracking.',
        attachTo: '#header top',
        buttons: [
          { text: 'Take the tour', action: tour.next, classes: 'shepherd-button-primary' },
          { text: 'Skip tour', action: tour.complete }
        ]
      });
      
      tour.addStep({
        title: 'Key Performance Indicators',
        text: 'These cards show critical metrics. Click any KPI to drill down into detailed analysis.',
        attachTo: '.kpi first',
        buttons: [
          { text: 'Next', action: tour.next, classes: 'shepherd-button-primary' }
        ]
      });
      
      tour.addStep({
        title: 'Branch Performance Cards',
        text: 'Each branch card shows performance metrics and goal progress. Click to expand for more details.',
        attachTo: '#branchRow1 first',
        buttons: [
          { text: 'Next', action: tour.next, classes: 'shepherd-button-primary' }
        ]
      });
      
      tour.addStep({
        title: 'Three-Month Report',
        text: 'This section provides a comprehensive analysis of each branch\'s performance over the last three months with growth indicators.',
        attachTo: '#threeMonthReportContainer first',
        buttons: [
          { text: 'Next', action: tour.next, classes: 'shepherd-button-primary' }
        ]
      });
      
      tour.addStep({
        title: 'Interactive Charts',
        text: 'Charts update based on your filters. Hover for details, click to drill down.',
        attachTo: '#barChart first',
        buttons: [
          { text: 'Next', action: tour.next, classes: 'shepherd-button-primary' }
        ]
      });
      
      tour.addStep({
        title: 'Key Insights',
        text: 'The insights section provides actionable intelligence based on your data. Click insights to take action.',
        attachTo: '.insight-box first',
        buttons: [
          { text: 'Next', action: tour.next, classes: 'shepherd-button-primary' }
        ]
      });
      
      tour.addStep({
        title: 'Export & Sharing',
        text: 'Export data in various formats or schedule automatic reports. Present mode hides UI controls for meetings.',
        attachTo: '#btnExportCSV first',
        buttons: [
          { text: 'Finish', action: tour.complete, classes: 'shepherd-button-primary' }
        ]
      });
    }

    // Start tour
    function startTour() {
      tour.start();
    }

    // Update audit log
    function updateAuditLog() {
      const auditLog = $('#auditLog');
      const timestamp = new Date().toLocaleString('en-GB');
      
      const newEntry = `
        <div class="py-1 border-b">
          <span class="font-medium">${timestamp}</span> - Dashboard viewed by ${currentUser.name}
        </div>
      `;
      
      auditLog.prepend(newEntry);
      
      // Keep only last 10 entries
      const entries = auditLog.find('.py-1');
      if (entries.length > 10) {
        entries.slice(10).remove();
      }
    }

    // Update last updated timestamp
    function updateLastUpdated() {
      $('#lastUpdated').text(new Date().toLocaleString('en-GB'));
      $('#dataVersion').text('v1.' + (new Date().getMonth() + 1));
    }

    // Update data
    function updateData() {
      showLoading();
      const input = $('#dataInput').val().trim();
      if (!input) {
        hideLoading();
        showNotification('Please enter data!', 'error');
        return;
      }
      try {
        const newData = input.split('\n').map(row => {
          const [date, outlet, deliveryOrders, deliverySales] = row.split(',');
          return {
            date: date.trim(),
            outlet: outlet.trim(),
            deliveryOrders: parseInt(deliveryOrders),
            deliverySales: parseFloat(deliverySales)
          };
        });
        salesData = salesData.concat(newData);
        updateTableAndStorage();
        updateKpis($('#monthFilterTop').val());
        renderBranches($('#monthFilterTop').val());
        updateCharts($('#monthFilterTop').val());
        generateThreeMonthReport();
        hideLoading();
        showNotification('Data updated successfully', 'success');
        updateAuditLog();
      } catch (e) {
        hideLoading();
        showNotification('Invalid data format! Use: Date,Outlet,DeliveryOrders,DeliverySales', 'error');
      }
    }

    // Edit and delete rows
    function editRow(rowIndex) {
      const row = salesData[rowIndex];
      const newData = prompt('Enter updated data (Date,Outlet,DeliveryOrders,DeliverySales):', `${row.date},${row.outlet},${row.deliveryOrders},${row.deliverySales}`);
      if (newData) {
        try {
          const [date, outlet, deliveryOrders, deliverySales] = newData.split(',');
          salesData[rowIndex] = {
            date: date.trim(),
            outlet: outlet.trim(),
            deliveryOrders: parseInt(deliveryOrders),
            deliverySales: parseFloat(deliverySales)
          };
          updateTableAndStorage();
          updateKpis($('#monthFilterTop').val());
          renderBranches($('#monthFilterTop').val());
          updateCharts($('#monthFilterTop').val());
          generateThreeMonthReport();
          showNotification('Row updated', 'success');
          updateAuditLog();
        } catch (e) {
          showNotification('Invalid data format!', 'error');
        }
      }
    }

    function deleteRow(rowIndex) {
      if (confirm('Are you sure you want to delete this row?')) {
        salesData.splice(rowIndex, 1);
        updateTableAndStorage();
        updateKpis($('#monthFilterTop').val());
        renderBranches($('#monthFilterTop').val());
        updateCharts($('#monthFilterTop').val());
        generateThreeMonthReport();
        showNotification('Row deleted', 'success');
        updateAuditLog();
      }
    }

    function updateTableAndStorage() {
      localStorage.setItem('salesData', JSON.stringify(salesData));
      $('#dataTable').DataTable().clear().rows.add(salesData).draw();
      updateLastUpdated();
    }

    // Reset to original data
    function resetData() {
      if (confirm('Reset to original data? This will clear all custom entries.')) {
        showLoading();
        localStorage.removeItem('salesData');
        location.reload();
      }
    }

    // Clear all data
    function clearAllData() {
      if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        showLoading();
        salesData = [];
        localStorage.removeItem('salesData');
        updateTableAndStorage();
        updateKpis($('#monthFilterTop').val());
        renderBranches($('#monthFilterTop').val());
        updateCharts($('#monthFilterTop').val());
        generateThreeMonthReport();
        hideLoading();
        showNotification('All data cleared', 'success');
        updateAuditLog();
      }
    }

    // Export functions
    function exportCSV() {
      showLoading();
      const headers = ['Date,Outlet,DeliveryOrders,DeliverySales'];
      const csv = headers.concat(salesData.map(row => `${row.date},${row.outlet},${row.deliveryOrders},${row.deliverySales}`)).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'delivery_sales_data.csv';
      a.click();
      window.URL.revokeObjectURL(url);
      hideLoading();
      showNotification('CSV exported', 'success');
      updateAuditLog();
    }

    function exportPDF() {
      showLoading();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('Crispy Chicken Delivery Sales Report', 20, 20);
      doc.setFontSize(12);
      let y = 30;
      salesData.forEach(row => {
        doc.text(`${row.date} | ${row.outlet} | Delivery Orders: ${row.deliveryOrders} | Delivery Sales: ${row.deliverySales} AED`, 20, y);
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save('delivery_sales_report.pdf');
      hideLoading();
      showNotification('PDF exported', 'success');
      updateAuditLog();
    }

    function exportExcel() {
      showLoading();
      const ws = XLSX.utils.json_to_sheet(salesData, { header: ['date', 'outlet', 'deliveryOrders', 'deliverySales'] });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Delivery Sales Data');
      XLSX.writeFile(wb, 'delivery_sales_data.xlsx');
      hideLoading();
      showNotification('Excel exported', 'success');
      updateAuditLog();
    }

    // Notification and loading
    function showNotification(message, type) {
      const notification = $(`<div class="notification ${type}">${message}</div>`);
      $('#notificationContainer').append(notification);
      setTimeout(() => notification.fadeOut(300, () => notification.remove()), 3000);
    }

    function showLoading() {
      $('#loadingOverlay').removeClass('hidden');
    }

    function hideLoading() {
      $('#loadingOverlay').addClass('hidden');
    }

    // Modal event listeners
    $('#closeDrillModal').on('click', () => $('#drillModal').addClass('hidden'));
    $('#closeGoalModal').on('click', () => $('#goalModal').addClass('hidden'));
    $('#closeScheduleModal').on('click', () => $('#scheduleModal').addClass('hidden'));
    $('#cancelGoals').on('click', () => $('#goalModal').addClass('hidden'));
    $('#cancelSchedule').on('click', () => $('#scheduleModal').addClass('hidden'));
    $('#saveGoals').on('click', saveGoals);
    $('#saveSchedule').on('click', saveSchedule);

    // Comparison analysis
    function showComparison(branch) {
      const month = $('#monthFilterTop').val();
      const prevMonth = month === 'all' ? null : (month === '2025-01' ? null : `${parseInt(month.split('-')[0]) - 1}-12`);
      
      if (prevMonth) {
        const currentData = salesData.filter(d => d.date.startsWith(month) && d.outlet === branch);
        const prevData = salesData.filter(d => d.date.startsWith(prevMonth) && d.outlet === branch);
        
        const currentSales = currentData.reduce((sum, d) => sum + d.deliverySales, 0);
        const prevSales = prevData.reduce((sum, d) => sum + d.deliverySales, 0);
        const growth = ((currentSales - prevSales) / prevSales * 100).toFixed(1);
        
        showNotification(`${branch} sales ${growth >= 0 ? 'increased' : 'decreased'} by ${Math.abs(growth)}% vs previous month`, 'info');
      } else {
        showNotification('No previous month data available for comparison', 'warning');
      }
    }

    // Add animation keyframes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
