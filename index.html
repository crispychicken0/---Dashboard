<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä ŸÜÿ∏ÿßŸÖ ŸÖÿ≠ÿßÿ≥ÿ®ÿ© ŸÖÿ™ŸÉÿßŸÖŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #16a085;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark-color);
      line-height: 1.6;
    }
    
    h1 {
      text-align: center;
      color: var(--dark-color);
      margin-bottom: 30px;
      font-weight: 700;
      position: relative;
      padding-bottom: 15px;
    }
    
    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 4px;
      background: var(--secondary-color);
      border-radius: 2px;
    }
    
    .container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      max-width: 1400px;
      margin: auto;
      transition: var(--transition);
    }
    
    .container:hover {
      box-shadow: 0 8px 15px rgba(0,0,0,0.15);
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #fafafa;
      border-radius: 12px;
      border-right: 4px solid var(--secondary-color);
      transition: var(--transition);
    }
    
    .section:hover {
      transform: translateX(-5px);
    }
    
    .section-title {
      font-size: 1.3em;
      color: var(--dark-color);
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.15);
    }
    
    .card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
    }
    
    .card.revenue:before { background: var(--success-color); }
    .card.commission:before { background: var(--secondary-color); }
    .card.discounts:before { background: var(--danger-color); }
    .card.payout:before { background: var(--warning-color); }
    .card.difference:before { background: var(--info-color); }
    .card.clawbacks:before { background: #9b59b6; }
    
    .card h3 {
      font-size: 0.9em;
      color: #7f8c8d;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .card .value {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--dark-color);
      display: block;
      margin-bottom: 5px;
    }
    
    .card .change {
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .card .change.positive {
      color: var(--success-color);
    }
    
    .card .change.negative {
      color: var(--danger-color);
    }
    
    .input-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-color);
    }
    
    .form-group input, .form-group select, .form-group textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 12px 15px;
      text-align: center;
    }
    
    th {
      background: var(--light-color);
      color: var(--dark-color);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    
    .chart-wrapper {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    .chart-wrapper h3 {
      text-align: center;
      margin-bottom: 15px;
      color: var(--dark-color);
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: var(--secondary-color);
      color: white;
      font-size: 14px;
      font-weight: 600;
      margin: 8px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      background: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .file-upload {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin: 10px 0;
    }
    
    .file-upload input[type=file] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-upload-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: white;
      border: 2px dashed var(--secondary-color);
      border-radius: 8px;
      color: var(--secondary-color);
      font-weight: 600;
      transition: var(--transition);
    }
    
    .file-upload:hover .file-upload-label {
      background: rgba(52, 152, 219, 0.1);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--light-color);
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #7f8c8d;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      color: var(--secondary-color);
      border-bottom: 3px solid var(--secondary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification.success {
      background: var(--success-color);
    }
    
    .notification.error {
      background: var(--danger-color);
    }
    
    .notification.warning {
      background: var(--warning-color);
    }
    
    .export-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
    }
    
    .export-btn {
      padding: 12px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .export-excel {
      background: var(--success-color);
      color: white;
    }
    
    .export-excel:hover {
      background: #219653;
    }
    
    .export-pdf {
      background: var(--danger-color);
      color: white;
    }
    
    .export-pdf:hover {
      background: #c0392b;
    }
    
    .export-chart {
      background: #9b59b6;
      color: white;
    }
    
    .export-chart:hover {
      background: #8e44ad;
    }
    
    .print-btn {
      background: var(--primary-color);
      color: white;
    }
    
    .print-btn:hover {
      background: #1a252f;
    }
    
    .status-tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
    }
    
    .status-completed {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success-color);
    }
    
    .status-pending {
      background: rgba(241, 196, 15, 0.1);
      color: var(--warning-color);
    }
    
    .status-overdue {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }
    
    .reason-tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      margin: 2px;
    }
    
    .reason-promo {
      background: rgba(52, 152, 219, 0.1);
      color: var(--secondary-color);
    }
    
    .reason-quality {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }
    
    .reason-delivery {
      background: rgba(241, 196, 15, 0.1);
      color: var(--warning-color);
    }
    
    .reason-other {
      background: rgba(46, 204, 113, 0.1);
      color: var(--success-color);
    }
    
    .alert {
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border-right: 4px solid;
    }
    
    .alert-info {
      background: rgba(52, 152, 219, 0.1);
      border-color: var(--secondary-color);
      color: var(--secondary-color);
    }
    
    .alert-warning {
      background: rgba(241, 196, 15, 0.1);
      border-color: var(--warning-color);
      color: var(--warning-color);
    }
    
    .alert-danger {
      background: rgba(231, 76, 60, 0.1);
      border-color: var(--danger-color);
      color: var(--danger-color);
    }
    
    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .input-form {
        grid-template-columns: 1fr;
      }
      
      .export-options {
        flex-direction: column;
        align-items: center;
      }
      
      .export-btn {
        width: 100%;
        max-width: 300px;
        justify-content: center;
      }
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .container {
        box-shadow: none;
        padding: 0;
      }
      
      .section {
        break-inside: avoid;
        border-right: none;
        border-bottom: 1px solid #eee;
      }
      
      button, .export-options, input[type="file"] {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>üìä ŸÜÿ∏ÿßŸÖ ŸÖÿ≠ÿßÿ≥ÿ®ÿ© ŸÖÿ™ŸÉÿßŸÖŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ</h1>
  <div class="container">
    <div class="section">
      <div class="section-title"><i class="fas fa-upload"></i> ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ</div>
      <div class="file-upload">
        <input type="file" id="careemFile" accept=".xlsx,.xls,.csv">
        <label for="careemFile" class="file-upload-label">
          <i class="fas fa-file-excel"></i>
          <span>ŸÖŸÑŸÅ ÿ£ŸàÿßŸÖÿ± ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ</span>
        </label>
      </div>
      <div class="file-upload">
        <input type="file" id="payoutsFile" accept=".xlsx,.xls,.csv">
        <label for="payoutsFile" class="file-upload-label">
          <i class="fas fa-file-excel"></i>
          <span>ŸÖŸÑŸÅ ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</span>
        </label>
      </div>
      <div class="file-upload">
        <input type="file" id="adjustmentsFile" accept=".xlsx,.xls,.csv">
        <label for="adjustmentsFile" class="file-upload-label">
          <i class="fas fa-file-excel"></i>
          <span>ŸÖŸÑŸÅ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ŸàÿßŸÑÿÆÿµŸàŸÖÿßÿ™</span>
        </label>
      </div>
      <p style="margin: 10px 0; color: #7f8c8d;">ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅÿßÿ™ ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™ Ÿàÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπŸÖŸàŸÑÿßÿ™ ŸàÿßŸÑÿÆÿµŸàŸÖÿßÿ™</p>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-cog"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
      <div class="input-form">
        <div class="form-group">
          <label for="commissionRate">ŸÜÿ≥ÿ®ÿ© ÿπŸÖŸàŸÑÿ© ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ (%):</label>
          <input type="number" id="commissionRate" min="0" max="100" step="0.1" value="25" placeholder="ŸÖÿ´ÿßŸÑ: 25">
        </div>
        
        <div class="form-group">
          <label for="deliveryFee">ÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ™ŸàÿµŸäŸÑ (ÿØÿ±ŸáŸÖ):</label>
          <input type="number" id="deliveryFee" min="0" step="0.1" value="7" placeholder="ŸÖÿ´ÿßŸÑ: 7">
        </div>
        
        <div class="form-group">
          <label for="vatRate">ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© (%):</label>
          <input type="number" id="vatRate" min="0" max="100" step="0.1" value="5" placeholder="ŸÖÿ´ÿßŸÑ: 5">
        </div>
        
        <div class="form-group">
          <label for="penaltyRate">ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™ (%):</label>
          <input type="number" id="penaltyRate" min="0" max="100" step="0.1" value="10" placeholder="ŸÖÿ´ÿßŸÑ: 10">
        </div>
        
        <div class="form-group">
          <label for="maxDiscountRate">ÿ£ŸÇÿµŸâ ŸÜÿ≥ÿ®ÿ© ÿÆÿµŸÖ ŸÖŸÇÿ®ŸàŸÑÿ© (%):</label>
          <input type="number" id="maxDiscountRate" min="0" max="100" step="0.1" value="20" placeholder="ŸÖÿ´ÿßŸÑ: 20">
        </div>
        
        <div class="form-group">
          <label>&nbsp;</label>
          <button onclick="saveSettings()"><i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-chart-line"></i> ŸÖŸÑÿÆÿµ ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑŸÖÿßŸÑŸä</div>
      <div class="dashboard">
        <div class="card revenue">
          <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</h3>
          <span class="value" id="totalRevenue">0</span>
          <span class="change positive" id="revenueChange">+0%</span>
        </div>
        <div class="card commission">
          <h3>ÿπŸÖŸàŸÑÿ© ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ</h3>
          <span class="value" id="totalCommission">0</span>
          <span class="change negative" id="commissionChange">+0%</span>
        </div>
        <div class="card discounts">
          <h3>ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ŸàÿßŸÑÿπÿ±Ÿàÿ∂</h3>
          <span class="value" id="totalDiscounts">0</span>
          <span class="change negative" id="discountsChange">+0%</span>
        </div>
        <div class="card clawbacks">
          <h3>ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™ ŸàÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™</h3>
          <span class="value" id="totalClawbacks">0</span>
          <span class="change negative" id="clawbacksChange">+0%</span>
        </div>
        <div class="card payout">
          <h3>ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿµÿßŸÅŸäÿ©</h3>
          <span class="value" id="totalPayout">0</span>
          <span class="change positive" id="payoutChange">+0%</span>
        </div>
        <div class="card difference">
          <h3>ÿßŸÑŸÅÿ±ŸÇ ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®</h3>
          <span class="value" id="totalDifference">0</span>
          <span class="change negative" id="differenceChange">+0%</span>
        </div>
      </div>
      
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿßŸÑŸÅÿ±ŸÇ ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ® = ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™ - (ÿßŸÑÿπŸÖŸàŸÑÿ© + ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ + ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™ + ÿßŸÑÿ±ÿ≥ŸàŸÖ)
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-balance-scale"></i> ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™ ŸàÿßŸÑÿ£ÿ≥ÿ®ÿßÿ®</div>
      <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'dailyAnalysisTab')">ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸäŸàŸÖŸä</div>
        <div class="tab" onclick="openTab(event, 'weeklyAnalysisTab')">ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä</div>
        <div class="tab" onclick="openTab(event, 'reasonsAnalysisTab')">ÿ£ÿ≥ÿ®ÿßÿ® ÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™</div>
      </div>
      
      <div id="dailyAnalysisTab" class="tab-content active">
        <input type="text" id="dailySearch" placeholder="üîç ÿ®ÿ≠ÿ´..." onkeyup="filterTable('dailyTable', this.value)">
        <table id="dailyTable">
          <thead>
            <tr>
              <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
              <th>ÿπÿØÿØ ÿßŸÑÿ£ŸàÿßŸÖÿ±</th>
              <th>ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</th>
              <th>ÿßŸÑÿπŸÖŸàŸÑÿ©</th>
              <th>ÿßŸÑÿÆÿµŸàŸÖÿßÿ™</th>
              <th>ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™</th>
              <th>ÿßŸÑÿØŸÅÿπÿ©</th>
              <th>ÿßŸÑŸÅÿ±ŸÇ</th>
              <th>ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅÿ±ŸÇ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="weeklyAnalysisTab" class="tab-content">
        <input type="text" id="weeklySearch" placeholder="üîç ÿ®ÿ≠ÿ´..." onkeyup="filterTable('weeklyTable', this.value)">
        <table id="weeklyTable">
          <thead>
            <tr>
              <th>ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</th>
              <th>ÿπÿØÿØ ÿßŸÑÿ£ŸàÿßŸÖÿ±</th>
              <th>ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</th>
              <th>ÿßŸÑÿπŸÖŸàŸÑÿ©</th>
              <th>ÿßŸÑÿÆÿµŸàŸÖÿßÿ™</th>
              <th>ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™</th>
              <th>ÿßŸÑÿØŸÅÿπÿ©</th>
              <th>ÿßŸÑŸÅÿ±ŸÇ</th>
              <th>ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅÿ±ŸÇ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="reasonsAnalysisTab" class="tab-content">
        <input type="text" id="reasonsSearch" placeholder="üîç ÿ®ÿ≠ÿ´..." onkeyup="filterTable('reasonsTable', this.value)">
        <table id="reasonsTable">
          <thead>
            <tr>
              <th>ÿ≥ÿ®ÿ® ÿßŸÑŸÅÿ±ŸÇ</th>
              <th>ÿßŸÑÿπÿØÿØ</th>
              <th>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
              <th>ŸÜÿ≥ÿ®ÿ© ŸÖŸÜ ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</th>
              <th>ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
              <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-chart-bar"></i> ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸäÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑŸäÿ©</div>
      <div class="charts-container">
        <div class="chart-wrapper">
          <h3>ÿ™ÿ∑Ÿàÿ± ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™ ŸàÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™</h3>
          <canvas id="revenueVsDifferenceChart" height="140"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3>ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ŸàÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™</h3>
          <canvas id="deductionsDistributionChart" height="140"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3>ÿ£ÿ≥ÿ®ÿßÿ® ÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™</h3>
          <canvas id="reasonsChart" height="140"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3>ŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑŸÅÿ™ÿ±ÿßÿ™</h3>
          <canvas id="periodComparisonChart" height="140"></canvas>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ŸàÿßŸÑÿ™ŸàÿµŸäÿßÿ™</div>
      <div id="alertsContainer">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>ÿ™ŸÜÿ®ŸäŸá:</strong> ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© (18%) ÿ™ŸÇÿ™ÿ±ÿ® ŸÖŸÜ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ (20%)
        </div>
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle"></i>
          <strong>ÿÆÿ∑ÿ±:</strong> ŸáŸÜÿßŸÉ 5 ÿ£ŸàÿßŸÖÿ± ÿ®ÿ™ÿπŸàŸäÿ∂ÿßÿ™ ÿπÿßŸÑŸäÿ© ÿ™ÿ™ÿ∑ŸÑÿ® ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÅŸàÿ±Ÿäÿ©
        </div>
        <div class="alert alert-info">
          <i class="fas fa-lightbulb"></i>
          <strong>ÿ™ŸàÿµŸäÿ©:</strong>ÂèØ‰ª•ËÄÉËôëÂçèÂïÜÈôç‰Ωé‰Ω£ÈáëÊØî‰æãÊàñ‰ºòÂåñ‰øÉÈîÄÁ≠ñÁï•‰ª•ÂáèÂ∞ëÂ∑ÆÂºÇ
        </div>
      </div>
    </div>
    
    <div class="export-options">
      <button class="export-btn export-excel" onclick="exportExcel()">
        <i class="fas fa-file-excel"></i> ÿ™ÿµÿØŸäÿ± Excel
      </button>
      <button class="export-btn export-pdf" onclick="exportPDF()">
        <i class="fas fa-file-pdf"></i> ÿ™ÿµÿØŸäÿ± PDF
      </button>
      <button class="export-btn export-chart" onclick="exportCharts()">
        <i class="fas fa-chart-pie"></i> ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸäÿ©
      </button>
      <button class="export-btn print-btn" onclick="window.print()">
        <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
      </button>
    </div>
  </div>
  
  <div id="notification" class="notification"></div>
  
  <script>
    // System settings
    let systemSettings = {
      commissionRate: 25,
      deliveryFee: 7,
      vatRate: 5,
      penaltyRate: 10,
      maxDiscountRate: 20
    };
    
    // Data structure for Careem Food analysis
    let careemData = {
      orders: [],
      payouts: [],
      adjustments: [],
      dailyAnalysis: [],
      weeklyAnalysis: [],
      reasonsAnalysis: []
    };
    
    // Chart instances
    let revenueVsDifferenceChartInstance = null;
    let deductionsDistributionChartInstance = null;
    let reasonsChartInstance = null;
    let periodComparisonChartInstance = null;
    
    // Initialize sample data
    function initializeSampleData() {
      // Sample orders data
      careemData.orders = [
        { id: "ORD001", date: "2025-09-01", customer: "ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ", amount: 120, discount: 20, commission: 30, status: "completed" },
        { id: "ORD002", date: "2025-09-01", customer: "ŸÅÿßÿ∑ŸÖÿ© ÿπŸÑŸä", amount: 85, discount: 15, commission: 21.25, status: "completed" },
        { id: "ORD003", date: "2025-09-02", customer: "ŸÖÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ", amount: 95, discount: 10, commission: 23.75, status: "completed" },
        { id: "ORD004", date: "2025-09-02", customer: "ÿÆÿßŸÑÿØ ÿπÿ®ÿØÿßŸÑŸÑŸá", amount: 110, discount: 25, commission: 27.5, status: "completed" },
        { id: "ORD005", date: "2025-09-03", customer: "ŸÜŸàÿ±ÿ© ÿ≥ÿßŸÑŸÖ", amount: 75, discount: 5, commission: 18.75, status: "completed" },
        { id: "ORD006", date: "2025-09-03", customer: "ÿ≥ÿßÿ±ÿ© ÿ£ÿ≠ŸÖÿØ", amount: 130, discount: 30, commission: 32.5, status: "completed" },
        { id: "ORD007", date: "2025-09-04", customer: "ÿπÿ®ÿØÿßŸÑŸÑŸá ŸÖÿ≠ŸÖÿØ", amount: 90, discount: 15, commission: 22.5, status: "completed" },
        { id: "ORD008", date: "2025-09-04", customer: "ŸÖÿ±ŸäŸÖ ÿÆÿßŸÑÿØ", amount: 105, discount: 20, commission: 26.25, status: "completed" },
        { id: "ORD009", date: "2025-09-05", customer: "ŸäŸàÿ≥ŸÅ ÿπŸÑŸä", amount: 80, discount: 10, commission: 20, status: "completed" },
        { id: "ORD010", date: "2025-09-05", customer: "ŸÑŸäŸÑŸâ ÿ£ÿ≠ŸÖÿØ", amount: 125, discount: 25, commission: 31.25, status: "completed" }
      ];
      
      // Sample adjustments data
      careemData.adjustments = [
        { id: "ADJ001", date: "2025-09-02", orderID: "ORD001", amount: -15, reason: "quality", description: "ŸÖÿ¥ÿßŸÉŸÑ ŸÅŸä ÿßŸÑÿ¨ŸàÿØÿ©", type: "clawback" },
        { id: "ADJ002", date: "2025-09-03", orderID: "ORD003", amount: -10, reason: "delivery", description: "ÿ™ÿ£ÿÆŸäÿ± ŸÅŸä ÿßŸÑÿ™ŸàÿµŸäŸÑ", type: "clawback" },
        { id: "ADJ003", date: "2025-09-04", orderID: "ORD005", amount: -5, reason: "wrong", description: "ÿ∑ŸÑÿ® ÿÆÿßÿ∑ÿ¶", type: "clawback" },
        { id: "ADJ004", date: "2025-09-05", orderID: "ORD007", amount: -8, reason: "promo", description: "ÿÆÿµŸÖ ÿ™ÿ±ŸàŸäÿ¨Ÿä", type: "discount" },
        { id: "ADJ005", date: "2025-09-06", orderID: "ORD009", amount: -12, reason: "quality", description: "ŸÖÿ¥ÿßŸÉŸÑ ŸÅŸä ÿßŸÑÿ¨ŸàÿØÿ©", type: "clawback" }
      ];
      
      // Sample payouts data
      careemData.payouts = [
        { id: "PAYOUT001", date: "2025-09-08", amount: 450, period: "2025-09-01 to 2025-09-07", status: "completed" },
        { id: "PAYOUT002", date: "2025-09-15", amount: 520, period: "2025-09-08 to 2025-09-14", status: "pending" }
      ];
      
      // Process data for analysis
      processDataForAnalysis();
    }
    
    // Process data for analysis
    function processDataForAnalysis() {
      // Group orders by date
      const dailyData = {};
      careemData.orders.forEach(order => {
        if (!dailyData[order.date]) {
          dailyData[order.date] = {
            orders: [],
            revenue: 0,
            commission: 0,
            discounts: 0,
            clawbacks: 0
          };
        }
        dailyData[order.date].orders.push(order);
        dailyData[order.date].revenue += order.amount;
        dailyData[order.date].commission += order.commission;
        dailyData[order.date].discounts += order.discount;
      });
      
      // Add clawbacks to daily data
      careemData.adjustments.forEach(adj => {
        if (dailyData[adj.date]) {
          dailyData[adj.date].clawbacks += Math.abs(adj.amount);
        }
      });
      
      // Create daily analysis
      careemData.dailyAnalysis = Object.keys(dailyData).map(date => {
        const data = dailyData[date];
        const totalDeductions = data.commission + data.discounts + data.clawbacks;
        const payout = data.revenue - totalDeductions;
        const difference = data.revenue - payout;
        const differenceRate = data.revenue > 0 ? (difference / data.revenue * 100).toFixed(2) : 0;
        
        return {
          date: date,
          orderCount: data.orders.length,
          revenue: data.revenue,
          commission: data.commission,
          discounts: data.discounts,
          clawbacks: data.clawbacks,
          payout: payout,
          difference: difference,
          differenceRate: differenceRate
        };
      });
      
      // Create weekly analysis
      const weeklyData = {};
      careemData.dailyAnalysis.forEach(day => {
        const week = getWeekNumber(day.date);
        if (!weeklyData[week]) {
          weeklyData[week] = {
            orders: [],
            revenue: 0,
            commission: 0,
            discounts: 0,
            clawbacks: 0
          };
        }
        weeklyData[week].orders.push(day);
        weeklyData[week].revenue += day.revenue;
        weeklyData[week].commission += day.commission;
        weeklyData[week].discounts += day.discounts;
        weeklyData[week].clawbacks += day.clawbacks;
      });
      
      careemData.weeklyAnalysis = Object.keys(weeklyData).map(week => {
        const data = weeklyData[week];
        const totalDeductions = data.commission + data.discounts + data.clawbacks;
        const payout = data.revenue - totalDeductions;
        const difference = data.revenue - payout;
        const differenceRate = data.revenue > 0 ? (difference / data.revenue * 100).toFixed(2) : 0;
        
        return {
          week: week,
          orderCount: data.orders.reduce((sum, day) => sum + day.orderCount, 0),
          revenue: data.revenue,
          commission: data.commission,
          discounts: data.discounts,
          clawbacks: data.clawbacks,
          payout: payout,
          difference: difference,
          differenceRate: differenceRate
        };
      });
      
      // Create reasons analysis
      const reasonsData = {};
      careemData.adjustments.forEach(adj => {
        if (!reasonsData[adj.reason]) {
          reasonsData[adj.reason] = {
            count: 0,
            totalAmount: 0,
            type: adj.type
          };
        }
        reasonsData[adj.reason].count++;
        reasonsData[adj.reason].totalAmount += Math.abs(adj.amount);
      });
      
      careemData.reasonsAnalysis = Object.keys(reasonsData).map(reason => {
        const data = reasonsData[reason];
        const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
        const revenuePercentage = totalRevenue > 0 ? (data.totalAmount / totalRevenue * 100).toFixed(2) : 0;
        const averageAmount = data.count > 0 ? (data.totalAmount / data.count).toFixed(2) : 0;
        
        return {
          reason: getReasonText(reason),
          count: data.count,
          totalAmount: data.totalAmount,
          revenuePercentage: revenuePercentage,
          averageAmount: averageAmount,
          type: data.type,
          status: data.totalAmount > 100 ? "ŸÖÿ±ÿßÿ¨ÿπÿ©" : "ÿ∑ÿ®ŸäÿπŸä"
        };
      });
    }
    
    // Get week number
    function getWeekNumber(dateString) {
      const date = new Date(dateString);
      const startOfYear = new Date(date.getFullYear(), 0, 1);
      const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
      return Math.ceil((days + startOfYear.getDay() + 1) / 7);
    }
    
    // Get reason text
    function getReasonText(reason) {
      const reasons = {
        'quality': 'ŸÖÿ¥ÿßŸÉŸÑ ŸÅŸä ÿßŸÑÿ¨ŸàÿØÿ©',
        'delivery': 'ÿ™ÿ£ÿÆŸäÿ± ŸÅŸä ÿßŸÑÿ™ŸàÿµŸäŸÑ',
        'wrong': 'ÿ∑ŸÑÿ® ÿÆÿßÿ∑ÿ¶',
        'promo': 'ÿÆÿµŸÖ ÿ™ÿ±ŸàŸäÿ¨Ÿä',
        'other': 'ÿ≥ÿ®ÿ® ÿ¢ÿÆÿ±'
      };
      return reasons[reason] || reason;
    }
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeSampleData();
      updateDashboard();
      renderTables();
      renderCharts();
      updateAlerts();
    });
    
    // Update dashboard
    function updateDashboard() {
      const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
      const totalCommission = careemData.orders.reduce((sum, order) => sum + order.commission, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const totalClawbacks = careemData.adjustments.reduce((sum, adj) => sum + Math.abs(adj.amount), 0);
      const totalPayout = careemData.payouts.reduce((sum, payout) => sum + payout.amount, 0);
      const totalDifference = totalRevenue - totalPayout;
      
      document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('totalCommission').textContent = formatCurrency(totalCommission);
      document.getElementById('totalDiscounts').textContent = formatCurrency(totalDiscounts);
      document.getElementById('totalClawbacks').textContent = formatCurrency(totalClawbacks);
      document.getElementById('totalPayout').textContent = formatCurrency(totalPayout);
      document.getElementById('totalDifference').textContent = formatCurrency(totalDifference);
      
      // Calculate changes (using dummy data for demonstration)
      document.getElementById('revenueChange').textContent = '+12.5%';
      document.getElementById('commissionChange').textContent = '+8.3%';
      document.getElementById('discountsChange').textContent = '+15.7%';
      document.getElementById('clawbacksChange').textContent = '+22.1%';
      document.getElementById('payoutChange').textContent = '+9.8%';
      document.getElementById('differenceChange').textContent = '+18.2%';
    }
    
    // Render tables
    function renderTables() {
      renderDailyTable();
      renderWeeklyTable();
      renderReasonsTable();
    }
    
    // Render daily table
    function renderDailyTable() {
      const tbody = document.querySelector('#dailyTable tbody');
      tbody.innerHTML = '';
      
      careemData.dailyAnalysis.forEach(day => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${day.date}</td>
          <td>${day.orderCount}</td>
          <td>${formatCurrency(day.revenue)}</td>
          <td>${formatCurrency(day.commission)}</td>
          <td>${formatCurrency(day.discounts)}</td>
          <td>${formatCurrency(day.clawbacks)}</td>
          <td>${formatCurrency(day.payout)}</td>
          <td class="${day.difference > 0 ? 'negative' : 'positive'}">${formatCurrency(day.difference)}</td>
          <td class="${day.differenceRate > 20 ? 'danger' : 'warning'}">${day.differenceRate}%</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render weekly table
    function renderWeeklyTable() {
      const tbody = document.querySelector('#weeklyTable tbody');
      tbody.innerHTML = '';
      
      careemData.weeklyAnalysis.forEach(week => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ${week.week}</td>
          <td>${week.orderCount}</td>
          <td>${formatCurrency(week.revenue)}</td>
          <td>${formatCurrency(week.commission)}</td>
          <td>${formatCurrency(week.discounts)}</td>
          <td>${formatCurrency(week.clawbacks)}</td>
          <td>${formatCurrency(week.payout)}</td>
          <td class="${week.difference > 0 ? 'negative' : 'positive'}">${formatCurrency(week.difference)}</td>
          <td class="${week.differenceRate > 20 ? 'danger' : 'warning'}">${week.differenceRate}%</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render reasons table
    function renderReasonsTable() {
      const tbody = document.querySelector('#reasonsTable tbody');
      tbody.innerHTML = '';
      
      careemData.reasonsAnalysis.forEach(reason => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="reason-tag reason-${reason.type}">${reason.reason}</span></td>
          <td>${reason.count}</td>
          <td>${formatCurrency(reason.totalAmount)}</td>
          <td>${reason.revenuePercentage}%</td>
          <td>${formatCurrency(reason.averageAmount)}</td>
          <td><span class="status-tag status-${reason.status === 'ŸÖÿ±ÿßÿ¨ÿπÿ©' ? 'overdue' : 'completed'}">${reason.status}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render charts
    function renderCharts() {
      renderRevenueVsDifferenceChart();
      renderDeductionsDistributionChart();
      renderReasonsChart();
      renderPeriodComparisonChart();
    }
    
    // Render revenue vs difference chart
    function renderRevenueVsDifferenceChart() {
      const ctx = document.getElementById('revenueVsDifferenceChart').getContext('2d');
      
      if (revenueVsDifferenceChartInstance) {
        revenueVsDifferenceChartInstance.destroy();
      }
      
      const labels = careemData.dailyAnalysis.map(d => d.date);
      const revenue = careemData.dailyAnalysis.map(d => d.revenue);
      const difference = careemData.dailyAnalysis.map(d => d.difference);
      
      revenueVsDifferenceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™',
              data: revenue,
              borderColor: '#27ae60',
              backgroundColor: 'rgba(39, 174, 96, 0.1)',
              tension: 0.3,
              fill: true
            },
            {
              label: 'ÿßŸÑŸÅÿ±ŸÇ',
              data: difference,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension:  Ô∏è0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += formatCurrency(context.parsed.y);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, true);
                }
              }
            }
          }
        }
      });
    }
    
    // Render deductions distribution chart
    function renderDeductionsDistributionChart() {
      const ctx = document.getElementById('deductionsDistributionChart').getContext('2d');
      
      if (deductionsDistributionChartInstance) {
        deductionsDistributionChartInstance.destroy();
      }
      
      const totalCommission = careemData.orders.reduce((sum, order) => sum + order.commission, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const totalClawbacks = careemData.adjustments.reduce((sum, adj) => sum + Math.abs(adj.amount), 0);
      
      deductionsDistributionChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['ÿßŸÑÿπŸÖŸàŸÑÿ©', 'ÿßŸÑÿÆÿµŸàŸÖÿßÿ™', 'ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™'],
          datasets: [{
            data: [totalCommission, totalDiscounts, totalClawbacks],
            backgroundColor: ['#3498db', '#e74c3c', '#9b59b6']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed !== null) {
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    label += formatCurrency(value);
                    label += ` (${percentage}%)`;
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }
    
    // Render reasons chart
    function renderReasonsChart() {
      const ctx = document.getElementById('reasonsChart').getContext('2d');
      
      if (reasonsChartInstance) {
        reasonsChartInstance.destroy();
      }
      
      const labels = careemData.reasonsAnalysis.map(r => r.reason);
      const data = careemData.reasonsAnalysis.map(r => r.totalAmount);
      
      reasonsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ÿßŸÑŸÖÿ®ŸÑÿ∫',
            data: data,
            backgroundColor: careemData.reasonsAnalysis.map(r => 
              r.type === 'clawback' ? '#e74c3c' : '#f39c12'
            )
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const reason = careemData.reasonsAnalysis[context.dataIndex];
                  return [
                    `ÿßŸÑŸÖÿ®ŸÑÿ∫: ${formatCurrency(context.parsed.y)}`,
                    `ÿßŸÑÿπÿØÿØ: ${reason.count}`,
                    `ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑: ${formatCurrency(reason.averageAmount)}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, true);
                }
              }
            }
          }
        }
      });
    }
    
    // Render period comparison chart
    function renderPeriodComparisonChart() {
      const ctx = document.getElementById('periodComparisonChart').getContext('2d');
      
      if (periodComparisonChartInstance) {
        periodComparisonChartInstance.destroy();
      }
      
      // Sample data for comparison
      periodComparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä', 'ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇ', 'ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±'],
          datasets: [
            {
              label: 'ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™',
              data: [1200, 1100, 1150],
              backgroundColor: '#27ae60'
            },
            {
              label: 'ÿßŸÑÿÆÿµŸàŸÖÿßÿ™',
              data: [300, 250, 275],
              backgroundColor: '#e74c3c'
            },
            {
              label: 'ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™',
              data: [150, 120, 135],
              backgroundColor: '#9b59b6'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += formatCurrency(context.parsed.y);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, true);
                }
              }
            }
          }
        }
      });
    }
    
    // Update alerts
    function updateAlerts() {
      const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const discountRate = totalRevenue > 0 ? (totalDiscounts / totalRevenue * 100) : 0;
      
      const highClawbacks = careemData.adjustments.filter(adj => Math.abs(adj.amount) > 10);
      
      let alertsHTML = '';
      
      if (discountRate > systemSettings.maxDiscountRate) {
        alertsHTML += `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>ÿ™ŸÜÿ®ŸäŸá:</strong> ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© (${discountRate.toFixed(1)}%) ÿ™ŸÇÿ™ÿ±ÿ® ŸÖŸÜ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ (${systemSettings.maxDiscountRate}%)
          </div>
        `;
      }
      
      if (highClawbacks.length > 0) {
        alertsHTML += `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <strong>ÿÆÿ∑ÿ±:</strong> ŸáŸÜÿßŸÉ ${highClawbacks.length} ÿ£ŸàÿßŸÖÿ± ÿ®ÿ™ÿπŸàŸäÿ∂ÿßÿ™ ÿπÿßŸÑŸäÿ© ÿ™ÿ™ÿ∑ŸÑÿ® ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÅŸàÿ±Ÿäÿ©
          </div>
        `;
      }
      
      alertsHTML += `
        <div class="alert alert-info">
          <i class="fas fa-lightbulb"></i>
          <strong>ÿ™ŸàÿµŸäÿ©:</strong>ÂèØ‰ª•ËÄÉËôëÂçèÂïÜÈôç‰Ωé‰Ω£ÈáëÊØî‰æãÊàñ‰ºòÂåñ‰øÉÈîÄÁ≠ñÁï•‰ª•ÂáèÂ∞ëÂ∑ÆÂºÇ
        </div>
      `;
      
      document.getElementById('alertsContainer').innerHTML = alertsHTML;
    }
    
    // Save settings
    function saveSettings() {
      systemSettings.commissionRate = parseFloat(document.getElementById('commissionRate').value) || 25;
      systemSettings.deliveryFee = parseFloat(document.getElementById('deliveryFee').value) || 7;
      systemSettings.vatRate = parseFloat(document.getElementById('vatRate').value) || 5;
      systemSettings.penaltyRate = parseFloat(document.getElementById('penaltyRate').value) || 10;
      systemSettings.maxDiscountRate = parseFloat(document.getElementById('maxDiscountRate').value) || 20;
      
      updateAlerts();
      showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    }
    
    // Tab functionality
    function openTab(evt, tabName) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      
      const tabs = document.getElementsByClassName('tab');
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }
      
      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');
    }
    
    // Filter table
    function filterTable(tableId, query) {
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
      });
    }
    
    // Format currency
    function formatCurrency(amount, short = false) {
      if (short) {
        return amount.toLocaleString('ar-AE') + ' AED';
      }
      return amount.toLocaleString('ar-AE', { style: 'currency', currency: 'AED' });
    }
    
    // Export to Excel
    function exportExcel() {
      const wb = XLSX.utils.book_new();
      
      // Daily analysis sheet
      const dailyDataSheet = careemData.dailyAnalysis.map(day => ({
        'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ': day.date,
        'ÿπÿØÿØ ÿßŸÑÿ£ŸàÿßŸÖÿ±': day.orderCount,
        'ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™': day.revenue,
        'ÿßŸÑÿπŸÖŸàŸÑÿ©': day.commission,
        'ÿßŸÑÿÆÿµŸàŸÖÿßÿ™': day.discounts,
        'ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™': day.clawbacks,
        'ÿßŸÑÿØŸÅÿπÿ©': day.payout,
        'ÿßŸÑŸÅÿ±ŸÇ': day.difference,
        'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅÿ±ŸÇ': day.differenceRate + '%'
      }));
      
      const wsDaily = XLSX.utils.json_to_sheet(dailyDataSheet);
      
      // Weekly analysis sheet
      const weeklyDataSheet = careemData.weeklyAnalysis.map(week => ({
        'ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ': week.week,
        'ÿπÿØÿØ ÿßŸÑÿ£ŸàÿßŸÖÿ±': week.orderCount,
        'ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™': week.revenue,
        'ÿßŸÑÿπŸÖŸàŸÑÿ©': week.commission,
        'ÿßŸÑÿÆÿµŸàŸÖÿßÿ™': week.discounts,
        'ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™': week.clawbacks,
        'ÿßŸÑÿØŸÅÿπÿ©': week.payout,
        'ÿßŸÑŸÅÿ±ŸÇ': week.difference,
        'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÅÿ±ŸÇ': week.differenceRate + '%'
      }));
      
      const wsWeekly = XLSX.utils.json_to_sheet(weeklyDataSheet);
      
      // Reasons analysis sheet
      const reasonsDataSheet = careemData.reasonsAnalysis.map(reason => ({
        'ÿ≥ÿ®ÿ® ÿßŸÑŸÅÿ±ŸÇ': reason.reason,
        'ÿßŸÑÿπÿØÿØ': reason.count,
        'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫': reason.totalAmount,
        'ŸÜÿ≥ÿ®ÿ© ŸÖŸÜ ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™': reason.revenuePercentage + '%',
        'ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ®ŸÑÿ∫': reason.averageAmount,
        'ÿßŸÑÿ≠ÿßŸÑÿ©': reason.status
      }));
      
      const wsReasons = XLSX.utils.json_to_sheet(reasonsDataSheet);
      
      XLSX.utils.book_append_sheet(wb, wsDaily, 'ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸäŸàŸÖŸä');
      XLSX.utils.book_append_sheet(wb, wsWeekly, 'ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä');
      XLSX.utils.book_append_sheet(wb, wsReasons, 'ÿ£ÿ≥ÿ®ÿßÿ® ÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™');
      
      XLSX.writeFile(wb, 'ÿ™ŸÇÿ±Ÿäÿ±_ŸÉÿ±ŸäŸÖ_ŸÅŸàÿØ.xlsx');
      showNotification('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    }
    
    // Export to PDF
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add Arabic font support
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');
      
      doc.setFontSize(18);
      doc.text("ÿ™ŸÇÿ±Ÿäÿ± ÿ™ÿ≠ŸÑŸäŸÑ ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ", 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text("ÿßŸÑŸÅÿ™ÿ±ÿ©: 1-7 ÿ≥ÿ®ÿ™ŸÖÿ®ÿ± 2025", 20, 30);
      
      // Summary
      doc.setFontSize(14);
      doc.text("ŸÖŸÑÿÆÿµ ÿßŸÑÿ£ÿØÿßÿ°", 20, 45);
      
      doc.setFontSize(12);
      const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
      const totalCommission = careemData.orders.reduce((sum, order) => sum + order.commission, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const totalClawbacks = careemData.adjustments.reduce((sum, adj) => sum + Math.abs(adj.amount), 0);
      
      doc.text("ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™: " + formatCurrency(totalRevenue), 20, 55);
      doc.text("ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπŸÖŸàŸÑÿ©: " + formatCurrency(totalCommission), 20, 65);
      doc.text("ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿµŸàŸÖÿßÿ™: " + formatCurrency(totalDiscounts), 20, 75);
      doc.text("ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™: " + formatCurrency(totalClawbacks), 20, 85);
      
      // Add charts as images
      const charts = [
        { canvas: 'revenueVsDifferenceChart', y: 95 },
        { canvas: 'deductionsDistributionChart', y: 170 },
        { canvas: 'reasonsChart', y: 245 }
      ];
      
      charts.forEach(chart => {
        const chartCanvas = document.getElementById(chart.canvas);
        const chartImage = chartCanvas.toDataURL('image/png');
        doc.addImage(chartImage, 'PNG', 15, chart.y, 180, 70);
      });
      
      doc.save('ÿ™ŸÇÿ±Ÿäÿ±_ŸÉÿ±ŸäŸÖ_ŸÅŸàÿØ.pdf');
      showNotification('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ PDF ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    }
    
    // Export charts
    function exportCharts() {
      // Create a new canvas to combine all charts
      const combinedCanvas = document.createElement('canvas');
      const ctx = combinedCanvas.getContext('2d');
      combinedCanvas.width = 1200;
      combinedCanvas.height = 1600;
      
      // Fill background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
      
      // Add title
      ctx.fillStyle = '#2c3e50';
      ctx.font = 'bold 28px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸäÿ© - ÿ™ÿ≠ŸÑŸäŸÑ ŸÉÿ±ŸäŸÖ ŸÅŸàÿØ', combinedCanvas.width / 2, 40);
      
      // Add date
      ctx.fillStyle = '#7f8c8d';
      ctx.font = '16px Arial';
      ctx.fillText('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + new Date().toLocaleDateString('ar-AE'), combinedCanvas.width / 2, 70);
      
      // Get chart canvases
      const charts = [
        { canvas: 'revenueVsDifferenceChart', y: 100, title: 'ÿ™ÿ∑Ÿàÿ± ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™ ŸàÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™' },
        { canvas: 'deductionsDistributionChart', y: 450, title: 'ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ŸàÿßŸÑÿ™ÿπŸàŸäÿ∂ÿßÿ™' },
        { canvas: 'reasonsChart', y: 800, title: 'ÿ£ÿ≥ÿ®ÿßÿ® ÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™' },
        { canvas: 'periodComparisonChart', y: 1150, title: 'ŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑŸÅÿ™ÿ±ÿßÿ™' }
      ];
      
      charts.forEach(chart => {
        // Add chart title
        ctx.fillStyle = '#2c3e50';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(chart.title, combinedCanvas.width / 2, chart.y - 20);
        
        // Draw chart
        const chartCanvas = document.getElementById(chart.canvas);
        ctx.drawImage(chartCanvas, 100, chart.y, 1000, 300);
      });
      
      // Create download link
      const link = document.createElement('a');
      link.download = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ±ÿ≥ŸàŸÖ_ÿßŸÑÿ®ŸäÿßŸÜŸäÿ©_ŸÉÿ±ŸäŸÖ_ŸÅŸàÿØ.png';
      link.href = combinedCanvas.toDataURL('image/png');
      link.click();
      
      showNotification('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    }
    
    // Show notification
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // File upload handlers
    document.getElementById('careemFile').addEventListener('change', function(e) {
      handleFileUpload(e, 'careem');
    });
    
    document.getElementById('payoutsFile').addEventListener('change', function(e) {
      handleFileUpload(e, 'payouts');
    });
    
    document.getElementById('adjustmentsFile').addEventListener('change', function(e) {
      handleFileUpload(e, 'adjustments');
    });
    
    // Handle file upload
    function handleFileUpload(e, type) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          let data;
          if (file.name.endsWith('.csv')) {
            data = Papa.parse(event.target.result, {
              header: true,
              skipEmptyLines: true
            }).data;
          } else {
            const workbook = XLSX.read(event.target.result, { type: 'array' });
            data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
          }
          
          // Process the uploaded data
          processUploadedData(data, type);
          showNotification('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ' + getTypeText(type) + ' ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        } catch (error) {
          showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }
    
    // Get type text
    function getTypeText(type) {
      const types = {
        'careem': 'ÿ£ŸàÿßŸÖÿ± ŸÉÿ±ŸäŸÖ',
        'payouts': 'ÿßŸÑÿØŸÅÿπÿßÿ™',
        'adjustments': 'ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™'
      };
      return types[type] || type;
    }
    
    // Process uploaded data
    function processUploadedData(data, type) {
      if (type === 'careem') {
        careemData.orders = data.map(row => ({
          id: row['Order ID'] || row['ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®'] || '',
          date: row['Date'] || row['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ'] || '',
          customer: row['Customer'] || row['ÿßŸÑÿπŸÖŸäŸÑ'] || '',
          amount: parseFloat(row['Amount'] || row['ÿßŸÑŸÖÿ®ŸÑÿ∫'] || 0),
          discount: parseFloat(row['Discount'] || row['ÿßŸÑÿÆÿµŸÖ'] || 0),
          commission: parseFloat(row['Commission'] || row['ÿßŸÑÿπŸÖŸàŸÑÿ©'] || 0),
          status: row['Status'] || row['ÿßŸÑÿ≠ÿßŸÑÿ©'] || 'completed'
        }));
      } else if (type === 'payouts') {
        careemData.payouts = data.map(row => ({
          id: row['Payout ID'] || row['ŸÖÿπÿ±ŸÅ ÿßŸÑÿØŸÅÿπÿ©'] || '',
          date: row['Date'] || row['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ'] || '',
          amount: parseFloat(row['Amount'] || row['ÿßŸÑŸÖÿ®ŸÑÿ∫'] || 0),
          period: row['Period'] || row['ÿßŸÑŸÅÿ™ÿ±ÿ©'] || '',
          status: row['Status'] || row['ÿßŸÑÿ≠ÿßŸÑÿ©'] || 'completed'
        }));
      } else if (type === 'adjustments') {
        careemData.adjustments = data.map(row => ({
          id: row['Adjustment ID'] || row['ŸÖÿπÿ±ŸÅ ÿßŸÑÿ™ÿπÿØŸäŸÑ'] || '',
          date: row['Date'] || row['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ'] || '',
          orderID: row['Order ID'] || row['ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®'] || '',
          amount: parseFloat(row['Amount'] || row['ÿßŸÑŸÖÿ®ŸÑÿ∫'] || 0),
          reason: row['Reason'] || row['ÿßŸÑÿ≥ÿ®ÿ®'] || 'other',
          description: row['Description'] || row['ÿßŸÑŸàÿµŸÅ'] || '',
          type: row['Type'] || row['ÿßŸÑŸÜŸàÿπ'] || 'clawback'
        }));
      }
      
      // Re-process data for analysis
      processDataForAnalysis();
      
      // Update displays
      updateDashboard();
      renderTables();
      renderCharts();
      updateAlerts();
    }
  </script>
</body>
</html>
