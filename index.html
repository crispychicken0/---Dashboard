<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© ÙƒØ±ÙŠÙ… ÙÙˆØ¯</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #16a085;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark-color);
      line-height: 1.6;
    }
    
    h1 {
      text-align: center;
      color: var(--dark-color);
      margin-bottom: 30px;
      font-weight: 700;
      position: relative;
      padding-bottom: 15px;
    }
    
    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 4px;
      background: var(--secondary-color);
      border-radius: 2px;
    }
    
    .container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      max-width: 1400px;
      margin: auto;
      transition: var(--transition);
    }
    
    .container:hover {
      box-shadow: 0 8px 15px rgba(0,0,0,0.15);
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #fafafa;
      border-radius: 12px;
      border-right: 4px solid var(--secondary-color);
      transition: var(--transition);
    }
    
    .section:hover {
      transform: translateX(-5px);
    }
    
    .section-title {
      font-size: 1.3em;
      color: var(--dark-color);
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.15);
    }
    
    .card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
    }
    
    .card.revenue:before { background: var(--success-color); }
    .card.commission:before { background: var(--secondary-color); }
    .card.discounts:before { background: var(--danger-color); }
    .card.payout:before { background: var(--warning-color); }
    .card.difference:before { background: var(--info-color); }
    .card.clawbacks:before { background: #9b59b6; }
    
    .card h3 {
      font-size: 0.9em;
      color: #7f8c8d;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .card .value {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--dark-color);
      display: block;
      margin-bottom: 5px;
    }
    
    .card .change {
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .card .change.positive {
      color: var(--success-color);
    }
    
    .card .change.negative {
      color: var(--danger-color);
    }
    
    .input-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-color);
    }
    
    .form-group input, .form-group select, .form-group textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 12px 15px;
      text-align: center;
    }
    
    th {
      background: var(--light-color);
      color: var(--dark-color);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    
    .chart-wrapper {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    .chart-wrapper h3 {
      text-align: center;
      margin-bottom: 15px;
      color: var(--dark-color);
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: var(--secondary-color);
      color: white;
      font-size: 14px;
      font-weight: 600;
      margin: 8px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      background: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .file-upload {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin: 10px 0;
    }
    
    .file-upload input[type=file] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-upload-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: white;
      border: 2px dashed var(--secondary-color);
      border-radius: 8px;
      color: var(--secondary-color);
      font-weight: 600;
      transition: var(--transition);
    }
    
    .file-upload:hover .file-upload-label {
      background: rgba(52, 152, 219, 0.1);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--light-color);
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #7f8c8d;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      color: var(--secondary-color);
      border-bottom: 3px solid var(--secondary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification.success {
      background: var(--success-color);
    }
    
    .notification.error {
      background: var(--danger-color);
    }
    
    .notification.warning {
      background: var(--warning-color);
    }
    
    .export-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
    }
    
    .export-btn {
      padding: 12px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .export-excel {
      background: var(--success-color);
      color: white;
    }
    
    .export-excel:hover {
      background: #219653;
    }
    
    .export-pdf {
      background: var(--danger-color);
      color: white;
    }
    
    .export-pdf:hover {
      background: #c0392b;
    }
    
    .export-chart {
      background: #9b59b6;
      color: white;
    }
    
    .export-chart:hover {
      background: #8e44ad;
    }
    
    .print-btn {
      background: var(--primary-color);
      color: white;
    }
    
    .print-btn:hover {
      background: #1a252f;
    }
    
    .status-tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
    }
    
    .status-completed {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success-color);
    }
    
    .status-pending {
      background: rgba(241, 196, 15, 0.1);
      color: var(--warning-color);
    }
    
    .status-overdue {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }
    
    .reason-tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      margin: 2px;
    }
    
    .reason-promo {
      background: rgba(52, 152, 219, 0.1);
      color: var(--secondary-color);
    }
    
    .reason-quality {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }
    
    .reason-delivery {
      background: rgba(241, 196, 15, 0.1);
      color: var(--warning-color);
    }
    
    .reason-other {
      background: rgba(46, 204, 113, 0.1);
      color: var(--success-color);
    }
    
    .alert {
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border-right: 4px solid;
    }
    
    .alert-info {
      background: rgba(52, 152, 219, 0.1);
      border-color: var(--secondary-color);
      color: var(--secondary-color);
    }
    
    .alert-warning {
      background: rgba(241, 196, 15, 0.1);
      border-color: var(--warning-color);
      color: var(--warning-color);
    }
    
    .alert-danger {
      background: rgba(231, 76, 60, 0.1);
      border-color: var(--danger-color);
      color: var(--danger-color);
    }
    
    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .input-form {
        grid-template-columns: 1fr;
      }
      
      .export-options {
        flex-direction: column;
        align-items: center;
      }
      
      .export-btn {
        width: 100%;
        max-width: 300px;
        justify-content: center;
      }
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .container {
        box-shadow: none;
        padding: 0;
      }
      
      .section {
        break-inside: avoid;
        border-right: none;
        border-bottom: 1px solid #eee;
      }
      
      button, .export-options, input[type="file"] {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© ÙƒØ±ÙŠÙ… ÙÙˆØ¯</h1>
  <div class="container">
    <div class="section">
      <div class="section-title"><i class="fas fa-upload"></i> ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ±ÙŠÙ… ÙÙˆØ¯</div>
      <div class="file-upload">
        <input type="file" id="careemFile" accept=".xlsx,.xls,.csv">
        <label for="careemFile" class="file-upload-label">
          <i class="fas fa-file-excel"></i>
          <span>Ù…Ù„Ù Ø£ÙˆØ§Ù…Ø± ÙƒØ±ÙŠÙ… ÙÙˆØ¯</span>
        </label>
      </div>
      <div class="file-upload">
        <input type="file" id="payoutsFile" accept=".xlsx,.xls,.csv">
        <label for="payoutsFile" class="file-upload-label">
          <i class="fas fa-file-excel"></i>
          <span>Ù…Ù„Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</span>
        </label>
      </div>
      <div class="file-upload">
        <input type="file" id="adjustmentsFile" accept=".xlsx,.xls,.csv">
        <label for="adjustmentsFile" class="file-upload-label">
          <i class="fas fa-file-excel"></i>
          <span>Ù…Ù„Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª</span>
        </label>
      </div>
      <p style="margin: 10px 0; color: #7f8c8d;">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª ÙƒØ±ÙŠÙ… ÙÙˆØ¯ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª</p>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</div>
      <div class="input-form">
        <div class="form-group">
          <label for="commissionRate">Ù†Ø³Ø¨Ø© Ø¹Ù…ÙˆÙ„Ø© ÙƒØ±ÙŠÙ… ÙÙˆØ¯ (%):</label>
          <input type="number" id="commissionRate" min="0" max="100" step="0.1" value="25" placeholder="Ù…Ø«Ø§Ù„: 25">
        </div>
        
        <div class="form-group">
          <label for="deliveryFee">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯Ø±Ù‡Ù…):</label>
          <input type="number" id="deliveryFee" min="0" step="0.1" value="7" placeholder="Ù…Ø«Ø§Ù„: 7">
        </div>
        
        <div class="form-group">
          <label for="vatRate">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%):</label>
          <input type="number" id="vatRate" min="0" max="100" step="0.1" value="5" placeholder="Ù…Ø«Ø§Ù„: 5">
        </div>
        
        <div class="form-group">
          <label for="penaltyRate">Ù†Ø³Ø¨Ø© Ø§Ù„ØºØ±Ø§Ù…Ø§Øª (%):</label>
          <input type="number" id="penaltyRate" min="0" max="100" step="0.1" value="10" placeholder="Ù…Ø«Ø§Ù„: 10">
        </div>
        
        <div class="form-group">
          <label for="maxDiscountRate">Ø£Ù‚ØµÙ‰ Ù†Ø³Ø¨Ø© Ø®ØµÙ… Ù…Ù‚Ø¨ÙˆÙ„Ø© (%):</label>
          <input type="number" id="maxDiscountRate" min="0" max="100" step="0.1" value="20" placeholder="Ù…Ø«Ø§Ù„: 20">
        </div>
        
        <div class="form-group">
          <label>&nbsp;</label>
          <button onclick="saveSettings()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-chart-line"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
      <div class="dashboard">
        <div class="card revenue">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
          <span class="value" id="totalRevenue">0</span>
          <span class="change positive" id="revenueChange">+0%</span>
        </div>
        <div class="card commission">
          <h3>Ø¹Ù…ÙˆÙ„Ø© ÙƒØ±ÙŠÙ… ÙÙˆØ¯</h3>
          <span class="value" id="totalCommission">0</span>
          <span class="change negative" id="commissionChange">+0%</span>
        </div>
        <div class="card discounts">
          <h3>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶</h3>
          <span class="value" id="totalDiscounts">0</span>
          <span class="change negative" id="discountsChange">+0%</span>
        </div>
        <div class="card clawbacks">
          <h3>Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª ÙˆØ§Ù„ØºØ±Ø§Ù…Ø§Øª</h3>
          <span class="value" id="totalClawbacks">0</span>
          <span class="change negative" id="clawbacksChange">+0%</span>
        </div>
        <div class="card payout">
          <h3>Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„ØµØ§ÙÙŠØ©</h3>
          <span class="value" id="totalPayout">0</span>
          <span class="change positive" id="payoutChange">+0%</span>
        </div>
        <div class="card difference">
          <h3>Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨</h3>
          <span class="value" id="totalDifference">0</span>
          <span class="change negative" id="differenceChange">+0%</span>
        </div>
      </div>
      
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ = Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª - (Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© + Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª + Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª + Ø§Ù„Ø±Ø³ÙˆÙ…)
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-balance-scale"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¨Ø§Ø¨</div>
      <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'dailyAnalysisTab')">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
        <div class="tab" onclick="openTab(event, 'weeklyAnalysisTab')">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
        <div class="tab" onclick="openTab(event, 'reasonsAnalysisTab')">Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</div>
      </div>
      
      <div id="dailyAnalysisTab" class="tab-content active">
        <input type="text" id="dailySearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('dailyTable', this.value)">
        <table id="dailyTable">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</th>
              <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
              <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
              <th>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</th>
              <th>Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª</th>
              <th>Ø§Ù„Ø¯ÙØ¹Ø©</th>
              <th>Ø§Ù„ÙØ±Ù‚</th>
              <th>Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ±Ù‚</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="weeklyAnalysisTab" class="tab-content">
        <input type="text" id="weeklySearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('weeklyTable', this.value)">
        <table id="weeklyTable">
          <thead>
            <tr>
              <th>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</th>
              <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
              <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
              <th>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</th>
              <th>Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª</th>
              <th>Ø§Ù„Ø¯ÙØ¹Ø©</th>
              <th>Ø§Ù„ÙØ±Ù‚</th>
              <th>Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ±Ù‚</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="reasonsAnalysisTab" class="tab-content">
        <input type="text" id="reasonsSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('reasonsTable', this.value)">
        <table id="reasonsTable">
          <thead>
            <tr>
              <th>Ø³Ø¨Ø¨ Ø§Ù„ÙØ±Ù‚</th>
              <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
              <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-chart-bar"></i> Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©</div>
      <div class="charts-container">
        <div class="chart-wrapper">
          <h3>ØªØ·ÙˆØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„ÙØ±ÙˆÙ‚Ø§Øª</h3>
          <canvas id="revenueVsDifferenceChart" height="140"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª</h3>
          <canvas id="deductionsDistributionChart" height="140"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3>Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</h3>
          <canvas id="reasonsChart" height="140"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙØªØ±Ø§Øª</h3>
          <canvas id="periodComparisonChart" height="140"></canvas>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª</div>
      <div id="alertsContainer">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (18%) ØªÙ‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (20%)
        </div>
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle"></i>
          <strong>Ø®Ø·Ø±:</strong> Ù‡Ù†Ø§Ùƒ 5 Ø£ÙˆØ§Ù…Ø± Ø¨ØªØ¹ÙˆÙŠØ¶Ø§Øª Ø¹Ø§Ù„ÙŠØ© ØªØªØ·Ù„Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙˆØ±ÙŠØ©
        </div>
        <div class="alert alert-info">
          <i class="fas fa-lightbulb"></i>
          <strong>ØªÙˆØµÙŠØ©:</strong>å¯ä»¥è€ƒè™‘åå•†é™ä½ä½£é‡‘æ¯”ä¾‹æˆ–ä¼˜åŒ–ä¿ƒé”€ç­–ç•¥ä»¥å‡å°‘å·®å¼‚
        </div>
      </div>
    </div>
    
    <div class="export-options">
      <button class="export-btn export-excel" onclick="exportExcel()">
        <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
      </button>
      <button class="export-btn export-pdf" onclick="exportPDF()">
        <i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± PDF
      </button>
      <button class="export-btn export-chart" onclick="exportCharts()">
        <i class="fas fa-chart-pie"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
      </button>
      <button class="export-btn print-btn" onclick="window.print()">
        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      </button>
    </div>
  </div>
  
  <div id="notification" class="notification"></div>
  
  <script>
    // System settings
    let systemSettings = {
      commissionRate: 25,
      deliveryFee: 7,
      vatRate: 5,
      penaltyRate: 10,
      maxDiscountRate: 20
    };
    
    // Data structure for Careem Food analysis
    let careemData = {
      orders: [],
      payouts: [],
      adjustments: [],
      dailyAnalysis: [],
      weeklyAnalysis: [],
      reasonsAnalysis: []
    };
    
    // Chart instances
    let revenueVsDifferenceChartInstance = null;
    let deductionsDistributionChartInstance = null;
    let reasonsChartInstance = null;
    let periodComparisonChartInstance = null;
    
    // Initialize sample data
    function initializeSampleData() {
      // Sample orders data
      careemData.orders = [
        { id: "ORD001", date: "2025-09-01", customer: "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯", amount: 120, discount: 20, commission: 30, status: "completed" },
        { id: "ORD002", date: "2025-09-01", customer: "ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ", amount: 85, discount: 15, commission: 21.25, status: "completed" },
        { id: "ORD003", date: "2025-09-02", customer: "Ù…Ø­Ù…Ø¯ Ø³Ø¹ÙŠØ¯", amount: 95, discount: 10, commission: 23.75, status: "completed" },
        { id: "ORD004", date: "2025-09-02", customer: "Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", amount: 110, discount: 25, commission: 27.5, status: "completed" },
        { id: "ORD005", date: "2025-09-03", customer: "Ù†ÙˆØ±Ø© Ø³Ø§Ù„Ù…", amount: 75, discount: 5, commission: 18.75, status: "completed" },
        { id: "ORD006", date: "2025-09-03", customer: "Ø³Ø§Ø±Ø© Ø£Ø­Ù…Ø¯", amount: 130, discount: 30, commission: 32.5, status: "completed" },
        { id: "ORD007", date: "2025-09-04", customer: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯", amount: 90, discount: 15, commission: 22.5, status: "completed" },
        { id: "ORD008", date: "2025-09-04", customer: "Ù…Ø±ÙŠÙ… Ø®Ø§Ù„Ø¯", amount: 105, discount: 20, commission: 26.25, status: "completed" },
        { id: "ORD009", date: "2025-09-05", customer: "ÙŠÙˆØ³Ù Ø¹Ù„ÙŠ", amount: 80, discount: 10, commission: 20, status: "completed" },
        { id: "ORD010", date: "2025-09-05", customer: "Ù„ÙŠÙ„Ù‰ Ø£Ø­Ù…Ø¯", amount: 125, discount: 25, commission: 31.25, status: "completed" }
      ];
      
      // Sample adjustments data
      careemData.adjustments = [
        { id: "ADJ001", date: "2025-09-02", orderID: "ORD001", amount: -15, reason: "quality", description: "Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©", type: "clawback" },
        { id: "ADJ002", date: "2025-09-03", orderID: "ORD003", amount: -10, reason: "delivery", description: "ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„", type: "clawback" },
        { id: "ADJ003", date: "2025-09-04", orderID: "ORD005", amount: -5, reason: "wrong", description: "Ø·Ù„Ø¨ Ø®Ø§Ø·Ø¦", type: "clawback" },
        { id: "ADJ004", date: "2025-09-05", orderID: "ORD007", amount: -8, reason: "promo", description: "Ø®ØµÙ… ØªØ±ÙˆÙŠØ¬ÙŠ", type: "discount" },
        { id: "ADJ005", date: "2025-09-06", orderID: "ORD009", amount: -12, reason: "quality", description: "Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©", type: "clawback" }
      ];
      
      // Sample payouts data
      careemData.payouts = [
        { id: "PAYOUT001", date: "2025-09-08", amount: 450, period: "2025-09-01 to 2025-09-07", status: "completed" },
        { id: "PAYOUT002", date: "2025-09-15", amount: 520, period: "2025-09-08 to 2025-09-14", status: "pending" }
      ];
      
      // Process data for analysis
      processDataForAnalysis();
    }
    
    // Process data for analysis
    function processDataForAnalysis() {
      // Group orders by date
      const dailyData = {};
      careemData.orders.forEach(order => {
        if (!dailyData[order.date]) {
          dailyData[order.date] = {
            orders: [],
            revenue: 0,
            commission: 0,
            discounts: 0,
            clawbacks: 0
          };
        }
        dailyData[order.date].orders.push(order);
        dailyData[order.date].revenue += order.amount;
        dailyData[order.date].commission += order.commission;
        dailyData[order.date].discounts += order.discount;
      });
      
      // Add clawbacks to daily data
      careemData.adjustments.forEach(adj => {
        if (dailyData[adj.date]) {
          dailyData[adj.date].clawbacks += Math.abs(adj.amount);
        }
      });
      
      // Create daily analysis
      careemData.dailyAnalysis = Object.keys(dailyData).map(date => {
        const data = dailyData[date];
        const totalDeductions = data.commission + data.discounts + data.clawbacks;
        const payout = data.revenue - totalDeductions;
        const difference = data.revenue - payout;
        const differenceRate = data.revenue > 0 ? (difference / data.revenue * 100).toFixed(2) : 0;
        
        return {
          date: date,
          orderCount: data.orders.length,
          revenue: data.revenue,
          commission: data.commission,
          discounts: data.discounts,
          clawbacks: data.clawbacks,
          payout: payout,
          difference: difference,
          differenceRate: differenceRate
        };
      });
      
      // Create weekly analysis
      const weeklyData = {};
      careemData.dailyAnalysis.forEach(day => {
        const week = getWeekNumber(day.date);
        if (!weeklyData[week]) {
          weeklyData[week] = {
            orders: [],
            revenue: 0,
            commission: 0,
            discounts: 0,
            clawbacks: 0
          };
        }
        weeklyData[week].orders.push(day);
        weeklyData[week].revenue += day.revenue;
        weeklyData[week].commission += day.commission;
        weeklyData[week].discounts += day.discounts;
        weeklyData[week].clawbacks += day.clawbacks;
      });
      
      careemData.weeklyAnalysis = Object.keys(weeklyData).map(week => {
        const data = weeklyData[week];
        const totalDeductions = data.commission + data.discounts + data.clawbacks;
        const payout = data.revenue - totalDeductions;
        const difference = data.revenue - payout;
        const differenceRate = data.revenue > 0 ? (difference / data.revenue * 100).toFixed(2) : 0;
        
        return {
          week: week,
          orderCount: data.orders.reduce((sum, day) => sum + day.orderCount, 0),
          revenue: data.revenue,
          commission: data.commission,
          discounts: data.discounts,
          clawbacks: data.clawbacks,
          payout: payout,
          difference: difference,
          differenceRate: differenceRate
        };
      });
      
      // Create reasons analysis
      const reasonsData = {};
      careemData.adjustments.forEach(adj => {
        if (!reasonsData[adj.reason]) {
          reasonsData[adj.reason] = {
            count: 0,
            totalAmount: 0,
            type: adj.type
          };
        }
        reasonsData[adj.reason].count++;
        reasonsData[adj.reason].totalAmount += Math.abs(adj.amount);
      });
      
      careemData.reasonsAnalysis = Object.keys(reasonsData).map(reason => {
        const data = reasonsData[reason];
        const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
        const revenuePercentage = totalRevenue > 0 ? (data.totalAmount / totalRevenue * 100).toFixed(2) : 0;
        const averageAmount = data.count > 0 ? (data.totalAmount / data.count).toFixed(2) : 0;
        
        return {
          reason: getReasonText(reason),
          count: data.count,
          totalAmount: data.totalAmount,
          revenuePercentage: revenuePercentage,
          averageAmount: averageAmount,
          type: data.type,
          status: data.totalAmount > 100 ? "Ù…Ø±Ø§Ø¬Ø¹Ø©" : "Ø·Ø¨ÙŠØ¹ÙŠ"
        };
      });
    }
    
    // Get week number
    function getWeekNumber(dateString) {
      const date = new Date(dateString);
      const startOfYear = new Date(date.getFullYear(), 0, 1);
      const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
      return Math.ceil((days + startOfYear.getDay() + 1) / 7);
    }
    
    // Get reason text
    function getReasonText(reason) {
      const reasons = {
        'quality': 'Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©',
        'delivery': 'ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„',
        'wrong': 'Ø·Ù„Ø¨ Ø®Ø§Ø·Ø¦',
        'promo': 'Ø®ØµÙ… ØªØ±ÙˆÙŠØ¬ÙŠ',
        'other': 'Ø³Ø¨Ø¨ Ø¢Ø®Ø±'
      };
      return reasons[reason] || reason;
    }
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeSampleData();
      updateDashboard();
      renderTables();
      renderCharts();
      updateAlerts();
    });
    
    // Update dashboard
    function updateDashboard() {
      const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
      const totalCommission = careemData.orders.reduce((sum, order) => sum + order.commission, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const totalClawbacks = careemData.adjustments.reduce((sum, adj) => sum + Math.abs(adj.amount), 0);
      const totalPayout = careemData.payouts.reduce((sum, payout) => sum + payout.amount, 0);
      const totalDifference = totalRevenue - totalPayout;
      
      document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('totalCommission').textContent = formatCurrency(totalCommission);
      document.getElementById('totalDiscounts').textContent = formatCurrency(totalDiscounts);
      document.getElementById('totalClawbacks').textContent = formatCurrency(totalClawbacks);
      document.getElementById('totalPayout').textContent = formatCurrency(totalPayout);
      document.getElementById('totalDifference').textContent = formatCurrency(totalDifference);
      
      // Calculate changes (using dummy data for demonstration)
      document.getElementById('revenueChange').textContent = '+12.5%';
      document.getElementById('commissionChange').textContent = '+8.3%';
      document.getElementById('discountsChange').textContent = '+15.7%';
      document.getElementById('clawbacksChange').textContent = '+22.1%';
      document.getElementById('payoutChange').textContent = '+9.8%';
      document.getElementById('differenceChange').textContent = '+18.2%';
    }
    
    // Render tables
    function renderTables() {
      renderDailyTable();
      renderWeeklyTable();
      renderReasonsTable();
    }
    
    // Render daily table
    function renderDailyTable() {
      const tbody = document.querySelector('#dailyTable tbody');
      tbody.innerHTML = '';
      
      careemData.dailyAnalysis.forEach(day => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${day.date}</td>
          <td>${day.orderCount}</td>
          <td>${formatCurrency(day.revenue)}</td>
          <td>${formatCurrency(day.commission)}</td>
          <td>${formatCurrency(day.discounts)}</td>
          <td>${formatCurrency(day.clawbacks)}</td>
          <td>${formatCurrency(day.payout)}</td>
          <td class="${day.difference > 0 ? 'negative' : 'positive'}">${formatCurrency(day.difference)}</td>
          <td class="${day.differenceRate > 20 ? 'danger' : 'warning'}">${day.differenceRate}%</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render weekly table
    function renderWeeklyTable() {
      const tbody = document.querySelector('#weeklyTable tbody');
      tbody.innerHTML = '';
      
      careemData.weeklyAnalysis.forEach(week => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week.week}</td>
          <td>${week.orderCount}</td>
          <td>${formatCurrency(week.revenue)}</td>
          <td>${formatCurrency(week.commission)}</td>
          <td>${formatCurrency(week.discounts)}</td>
          <td>${formatCurrency(week.clawbacks)}</td>
          <td>${formatCurrency(week.payout)}</td>
          <td class="${week.difference > 0 ? 'negative' : 'positive'}">${formatCurrency(week.difference)}</td>
          <td class="${week.differenceRate > 20 ? 'danger' : 'warning'}">${week.differenceRate}%</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render reasons table
    function renderReasonsTable() {
      const tbody = document.querySelector('#reasonsTable tbody');
      tbody.innerHTML = '';
      
      careemData.reasonsAnalysis.forEach(reason => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="reason-tag reason-${reason.type}">${reason.reason}</span></td>
          <td>${reason.count}</td>
          <td>${formatCurrency(reason.totalAmount)}</td>
          <td>${reason.revenuePercentage}%</td>
          <td>${formatCurrency(reason.averageAmount)}</td>
          <td><span class="status-tag status-${reason.status === 'Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'overdue' : 'completed'}">${reason.status}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render charts
    function renderCharts() {
      renderRevenueVsDifferenceChart();
      renderDeductionsDistributionChart();
      renderReasonsChart();
      renderPeriodComparisonChart();
    }
    
    // Render revenue vs difference chart
    function renderRevenueVsDifferenceChart() {
      const ctx = document.getElementById('revenueVsDifferenceChart').getContext('2d');
      
      if (revenueVsDifferenceChartInstance) {
        revenueVsDifferenceChartInstance.destroy();
      }
      
      const labels = careemData.dailyAnalysis.map(d => d.date);
      const revenue = careemData.dailyAnalysis.map(d => d.revenue);
      const difference = careemData.dailyAnalysis.map(d => d.difference);
      
      revenueVsDifferenceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
              data: revenue,
              borderColor: '#27ae60',
              backgroundColor: 'rgba(39, 174, 96, 0.1)',
              tension: 0.3,
              fill: true
            },
            {
              label: 'Ø§Ù„ÙØ±Ù‚',
              data: difference,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension:  ï¸0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += formatCurrency(context.parsed.y);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, true);
                }
              }
            }
          }
        }
      });
    }
    
    // Render deductions distribution chart
    function renderDeductionsDistributionChart() {
      const ctx = document.getElementById('deductionsDistributionChart').getContext('2d');
      
      if (deductionsDistributionChartInstance) {
        deductionsDistributionChartInstance.destroy();
      }
      
      const totalCommission = careemData.orders.reduce((sum, order) => sum + order.commission, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const totalClawbacks = careemData.adjustments.reduce((sum, adj) => sum + Math.abs(adj.amount), 0);
      
      deductionsDistributionChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©', 'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª', 'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª'],
          datasets: [{
            data: [totalCommission, totalDiscounts, totalClawbacks],
            backgroundColor: ['#3498db', '#e74c3c', '#9b59b6']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed !== null) {
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    label += formatCurrency(value);
                    label += ` (${percentage}%)`;
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }
    
    // Render reasons chart
    function renderReasonsChart() {
      const ctx = document.getElementById('reasonsChart').getContext('2d');
      
      if (reasonsChartInstance) {
        reasonsChartInstance.destroy();
      }
      
      const labels = careemData.reasonsAnalysis.map(r => r.reason);
      const data = careemData.reasonsAnalysis.map(r => r.totalAmount);
      
      reasonsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ø§Ù„Ù…Ø¨Ù„Øº',
            data: data,
            backgroundColor: careemData.reasonsAnalysis.map(r => 
              r.type === 'clawback' ? '#e74c3c' : '#f39c12'
            )
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const reason = careemData.reasonsAnalysis[context.dataIndex];
                  return [
                    `Ø§Ù„Ù…Ø¨Ù„Øº: ${formatCurrency(context.parsed.y)}`,
                    `Ø§Ù„Ø¹Ø¯Ø¯: ${reason.count}`,
                    `Ø§Ù„Ù…ØªÙˆØ³Ø·: ${formatCurrency(reason.averageAmount)}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, true);
                }
              }
            }
          }
        }
      });
    }
    
    // Render period comparison chart
    function renderPeriodComparisonChart() {
      const ctx = document.getElementById('periodComparisonChart').getContext('2d');
      
      if (periodComparisonChartInstance) {
        periodComparisonChartInstance.destroy();
      }
      
      // Sample data for comparison
      periodComparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚', 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ù‡Ø±'],
          datasets: [
            {
              label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
              data: [1200, 1100, 1150],
              backgroundColor: '#27ae60'
            },
            {
              label: 'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª',
              data: [300, 250, 275],
              backgroundColor: '#e74c3c'
            },
            {
              label: 'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª',
              data: [150, 120, 135],
              backgroundColor: '#9b59b6'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += formatCurrency(context.parsed.y);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, true);
                }
              }
            }
          }
        }
      });
    }
    
    // Update alerts
    function updateAlerts() {
      const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const discountRate = totalRevenue > 0 ? (totalDiscounts / totalRevenue * 100) : 0;
      
      const highClawbacks = careemData.adjustments.filter(adj => Math.abs(adj.amount) > 10);
      
      let alertsHTML = '';
      
      if (discountRate > systemSettings.maxDiscountRate) {
        alertsHTML += `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (${discountRate.toFixed(1)}%) ØªÙ‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${systemSettings.maxDiscountRate}%)
          </div>
        `;
      }
      
      if (highClawbacks.length > 0) {
        alertsHTML += `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Ø®Ø·Ø±:</strong> Ù‡Ù†Ø§Ùƒ ${highClawbacks.length} Ø£ÙˆØ§Ù…Ø± Ø¨ØªØ¹ÙˆÙŠØ¶Ø§Øª Ø¹Ø§Ù„ÙŠØ© ØªØªØ·Ù„Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙˆØ±ÙŠØ©
          </div>
        `;
      }
      
      alertsHTML += `
        <div class="alert alert-info">
          <i class="fas fa-lightbulb"></i>
          <strong>ØªÙˆØµÙŠØ©:</strong>å¯ä»¥è€ƒè™‘åå•†é™ä½ä½£é‡‘æ¯”ä¾‹æˆ–ä¼˜åŒ–ä¿ƒé”€ç­–ç•¥ä»¥å‡å°‘å·®å¼‚
        </div>
      `;
      
      document.getElementById('alertsContainer').innerHTML = alertsHTML;
    }
    
    // Save settings
    function saveSettings() {
      systemSettings.commissionRate = parseFloat(document.getElementById('commissionRate').value) || 25;
      systemSettings.deliveryFee = parseFloat(document.getElementById('deliveryFee').value) || 7;
      systemSettings.vatRate = parseFloat(document.getElementById('vatRate').value) || 5;
      systemSettings.penaltyRate = parseFloat(document.getElementById('penaltyRate').value) || 10;
      systemSettings.maxDiscountRate = parseFloat(document.getElementById('maxDiscountRate').value) || 20;
      
      updateAlerts();
      showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    
    // Tab functionality
    function openTab(evt, tabName) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      
      const tabs = document.getElementsByClassName('tab');
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }
      
      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');
    }
    
    // Filter table
    function filterTable(tableId, query) {
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
      });
    }
    
    // Format currency
    function formatCurrency(amount, short = false) {
      if (short) {
        return amount.toLocaleString('ar-AE') + ' AED';
      }
      return amount.toLocaleString('ar-AE', { style: 'currency', currency: 'AED' });
    }
    
    // Export to Excel
    function exportExcel() {
      const wb = XLSX.utils.book_new();
      
      // Daily analysis sheet
      const dailyDataSheet = careemData.dailyAnalysis.map(day => ({
        'Ø§Ù„ØªØ§Ø±ÙŠØ®': day.date,
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±': day.orderCount,
        'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª': day.revenue,
        'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©': day.commission,
        'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª': day.discounts,
        'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª': day.clawbacks,
        'Ø§Ù„Ø¯ÙØ¹Ø©': day.payout,
        'Ø§Ù„ÙØ±Ù‚': day.difference,
        'Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ±Ù‚': day.differenceRate + '%'
      }));
      
      const wsDaily = XLSX.utils.json_to_sheet(dailyDataSheet);
      
      // Weekly analysis sheet
      const weeklyDataSheet = careemData.weeklyAnalysis.map(week => ({
        'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹': week.week,
        'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±': week.orderCount,
        'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª': week.revenue,
        'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©': week.commission,
        'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª': week.discounts,
        'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª': week.clawbacks,
        'Ø§Ù„Ø¯ÙØ¹Ø©': week.payout,
        'Ø§Ù„ÙØ±Ù‚': week.difference,
        'Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ±Ù‚': week.differenceRate + '%'
      }));
      
      const wsWeekly = XLSX.utils.json_to_sheet(weeklyDataSheet);
      
      // Reasons analysis sheet
      const reasonsDataSheet = careemData.reasonsAnalysis.map(reason => ({
        'Ø³Ø¨Ø¨ Ø§Ù„ÙØ±Ù‚': reason.reason,
        'Ø§Ù„Ø¹Ø¯Ø¯': reason.count,
        'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº': reason.totalAmount,
        'Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª': reason.revenuePercentage + '%',
        'Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨Ù„Øº': reason.averageAmount,
        'Ø§Ù„Ø­Ø§Ù„Ø©': reason.status
      }));
      
      const wsReasons = XLSX.utils.json_to_sheet(reasonsDataSheet);
      
      XLSX.utils.book_append_sheet(wb, wsDaily, 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ');
      XLSX.utils.book_append_sheet(wb, wsWeekly, 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ');
      XLSX.utils.book_append_sheet(wb, wsReasons, 'Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª');
      
      XLSX.writeFile(wb, 'ØªÙ‚Ø±ÙŠØ±_ÙƒØ±ÙŠÙ…_ÙÙˆØ¯.xlsx');
      showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    
    // Export to PDF
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add Arabic font support
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');
      
      doc.setFontSize(18);
      doc.text("ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙƒØ±ÙŠÙ… ÙÙˆØ¯", 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text("Ø§Ù„ÙØªØ±Ø©: 1-7 Ø³Ø¨ØªÙ…Ø¨Ø± 2025", 20, 30);
      
      // Summary
      doc.setFontSize(14);
      doc.text("Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡", 20, 45);
      
      doc.setFontSize(12);
      const totalRevenue = careemData.orders.reduce((sum, order) => sum + order.amount, 0);
      const totalCommission = careemData.orders.reduce((sum, order) => sum + order.commission, 0);
      const totalDiscounts = careemData.orders.reduce((sum, order) => sum + order.discount, 0);
      const totalClawbacks = careemData.adjustments.reduce((sum, adj) => sum + Math.abs(adj.amount), 0);
      
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: " + formatCurrency(totalRevenue), 20, 55);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: " + formatCurrency(totalCommission), 20, 65);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: " + formatCurrency(totalDiscounts), 20, 75);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª: " + formatCurrency(totalClawbacks), 20, 85);
      
      // Add charts as images
      const charts = [
        { canvas: 'revenueVsDifferenceChart', y: 95 },
        { canvas: 'deductionsDistributionChart', y: 170 },
        { canvas: 'reasonsChart', y: 245 }
      ];
      
      charts.forEach(chart => {
        const chartCanvas = document.getElementById(chart.canvas);
        const chartImage = chartCanvas.toDataURL('image/png');
        doc.addImage(chartImage, 'PNG', 15, chart.y, 180, 70);
      });
      
      doc.save('ØªÙ‚Ø±ÙŠØ±_ÙƒØ±ÙŠÙ…_ÙÙˆØ¯.pdf');
      showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù PDF Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    
    // Export charts
    function exportCharts() {
      // Create a new canvas to combine all charts
      const combinedCanvas = document.createElement('canvas');
      const ctx = combinedCanvas.getContext('2d');
      combinedCanvas.width = 1200;
      combinedCanvas.height = 1600;
      
      // Fill background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
      
      // Add title
      ctx.fillStyle = '#2c3e50';
      ctx.font = 'bold 28px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© - ØªØ­Ù„ÙŠÙ„ ÙƒØ±ÙŠÙ… ÙÙˆØ¯', combinedCanvas.width / 2, 40);
      
      // Add date
      ctx.fillStyle = '#7f8c8d';
      ctx.font = '16px Arial';
      ctx.fillText('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + new Date().toLocaleDateString('ar-AE'), combinedCanvas.width / 2, 70);
      
      // Get chart canvases
      const charts = [
        { canvas: 'revenueVsDifferenceChart', y: 100, title: 'ØªØ·ÙˆØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„ÙØ±ÙˆÙ‚Ø§Øª' },
        { canvas: 'deductionsDistributionChart', y: 450, title: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª' },
        { canvas: 'reasonsChart', y: 800, title: 'Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª' },
        { canvas: 'periodComparisonChart', y: 1150, title: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙØªØ±Ø§Øª' }
      ];
      
      charts.forEach(chart => {
        // Add chart title
        ctx.fillStyle = '#2c3e50';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(chart.title, combinedCanvas.width / 2, chart.y - 20);
        
        // Draw chart
        const chartCanvas = document.getElementById(chart.canvas);
        ctx.drawImage(chartCanvas, 100, chart.y, 1000, 300);
      });
      
      // Create download link
      const link = document.createElement('a');
      link.download = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø±Ø³ÙˆÙ…_Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©_ÙƒØ±ÙŠÙ…_ÙÙˆØ¯.png';
      link.href = combinedCanvas.toDataURL('image/png');
      link.click();
      
      showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    
    // Show notification
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // File upload handlers
    document.getElementById('careemFile').addEventListener('change', function(e) {
      handleFileUpload(e, 'careem');
    });
    
    document.getElementById('payoutsFile').addEventListener('change', function(e) {
      handleFileUpload(e, 'payouts');
    });
    
    document.getElementById('adjustmentsFile').addEventListener('change', function(e) {
      handleFileUpload(e, 'adjustments');
    });
    
    // Handle file upload
    function handleFileUpload(e, type) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          let data;
          if (file.name.endsWith('.csv')) {
            data = Papa.parse(event.target.result, {
              header: true,
              skipEmptyLines: true
            }).data;
          } else {
            const workbook = XLSX.read(event.target.result, { type: 'array' });
            data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
          }
          
          // Process the uploaded data
          processUploadedData(data, type);
          showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ' + getTypeText(type) + ' Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
          showNotification('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }
    
    // Get type text
    function getTypeText(type) {
      const types = {
        'careem': 'Ø£ÙˆØ§Ù…Ø± ÙƒØ±ÙŠÙ…',
        'payouts': 'Ø§Ù„Ø¯ÙØ¹Ø§Øª',
        'adjustments': 'Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª'
      };
      return types[type] || type;
    }
    
    // Process uploaded data
    function processUploadedData(data, type) {
      if (type === 'careem') {
        careemData.orders = data.map(row => ({
          id: row['Order ID'] || row['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || '',
          date: row['Date'] || row['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || '',
          customer: row['Customer'] || row['Ø§Ù„Ø¹Ù…ÙŠÙ„'] || '',
          amount: parseFloat(row['Amount'] || row['Ø§Ù„Ù…Ø¨Ù„Øº'] || 0),
          discount: parseFloat(row['Discount'] || row['Ø§Ù„Ø®ØµÙ…'] || 0),
          commission: parseFloat(row['Commission'] || row['Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©'] || 0),
          status: row['Status'] || row['Ø§Ù„Ø­Ø§Ù„Ø©'] || 'completed'
        }));
      } else if (type === 'payouts') {
        careemData.payouts = data.map(row => ({
          id: row['Payout ID'] || row['Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙØ¹Ø©'] || '',
          date: row['Date'] || row['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || '',
          amount: parseFloat(row['Amount'] || row['Ø§Ù„Ù…Ø¨Ù„Øº'] || 0),
          period: row['Period'] || row['Ø§Ù„ÙØªØ±Ø©'] || '',
          status: row['Status'] || row['Ø§Ù„Ø­Ø§Ù„Ø©'] || 'completed'
        }));
      } else if (type === 'adjustments') {
        careemData.adjustments = data.map(row => ({
          id: row['Adjustment ID'] || row['Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'] || '',
          date: row['Date'] || row['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || '',
          orderID: row['Order ID'] || row['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || '',
          amount: parseFloat(row['Amount'] || row['Ø§Ù„Ù…Ø¨Ù„Øº'] || 0),
          reason: row['Reason'] || row['Ø§Ù„Ø³Ø¨Ø¨'] || 'other',
          description: row['Description'] || row['Ø§Ù„ÙˆØµÙ'] || '',
          type: row['Type'] || row['Ø§Ù„Ù†ÙˆØ¹'] || 'clawback'
        }));
      }
      
      // Re-process data for analysis
      processDataForAnalysis();
      
      // Update displays
      updateDashboard();
      renderTables();
      renderCharts();
      updateAlerts();
    }
  </script>
</body>
</html>
