<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù… - Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Tahoma, sans-serif; margin:20px; background:#f5f6fa; }
    h1 { text-align:center; margin-bottom:20px; }
    .container { background:white; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
    .summary { margin:20px 0; display:flex; gap:15px; flex-wrap:wrap; }
    .card { background:#fafafa; padding:15px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); flex:1; min-width:160px; text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#eee; }
    canvas { margin-top:30px; }
    button { margin:10px 5px 0; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; background:#3498db; color:white; font-size:14px; }
    button:hover { background:#2980b9; }
    input[type="file"], input[type="date"] { margin:10px 5px; padding:6px; }
    .error { color: red; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù… - Dashboard</h1>
  <div class="container">
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
    <div id="errorMessage" class="error"></div>

    <div>
      ğŸ” ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©: 
      <input type="date" id="startDate"> Ø¥Ù„Ù‰ <input type="date" id="endDate"> 
      <button onclick="applyDateFilter()">ØªØµÙÙŠØ©</button>
    </div>

    <div class="summary">
      <div class="card">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±<br><span id="orderCount">0</span></div>
      <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª<br><span id="totalSales">0</span> AED</div>
      <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª<br><span id="totalDiscount">0</span> AED</div>
      <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª<br><span id="totalCommission">0</span> AED</div>
      <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª<br><span id="totalRefund">0</span> AED</div>
      <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª<br><span id="totalPayouts">0</span> AED</div>
      <div class="card">ğŸ’° ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­<br><span id="netProfit">0</span> AED</div>
      <div class="card">ğŸ“ˆ Ù†Ø³Ø¨Ø© ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­<br><span id="netProfitRate">0</span>%</div>
    </div>

    <h3>ğŸ“‘ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
    <input type="text" id="orderSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('ordersTable', this.value)">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>REFERENCE_ID</th>
          <th>TRANSACTION_DATE</th>
          <th>MERCHANT_NAME</th>
          <th>FOOD_GROSS_BASKET_AMOUNT</th>
          <th>PARTNER_FUNDED_PROMO_DISCOUNT</th>
          <th>BILLING_PLATFORM_FEE</th>
          <th>TOTAL_PAYOUT_AMOUNT</th>
          <th>STATUS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>ğŸ’µ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©</h3>
    <input type="text" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('payoutsTable', this.value)">
    <table id="payoutsTable">
      <thead>
        <tr>
          <th>PAYOUT_ID</th>
          <th>PAYOUT_DATE</th>
          <th>PLATFORM</th>
          <th>PAYOUT_AMOUNT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>âš ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª / Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª</h3>
    <input type="text" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('refundsTable', this.value)">
    <table id="refundsTable">
      <thead>
        <tr>
          <th>CASE_ID</th>
          <th>DATE</th>
          <th>REASON</th>
          <th>AMOUNT</th>
          <th>STATUS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <canvas id="chart" height="140"></canvas>

    <div style="text-align:center;">
      <button onclick="exportExcel()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>
      <button onclick="exportPDF()">â¬‡ï¸ ØªØµØ¯ÙŠØ± PDF</button>
    </div>
  </div>

  <script>
    let orders = [], payouts = [], refunds = [];
    let filteredOrders = [], filteredPayouts = [], filteredRefunds = [];
    let chartInstance = null;

    document.getElementById('fileInput').addEventListener('change', handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) {
        document.getElementById('errorMessage').textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel.';
        return;
      }
      document.getElementById('errorMessage').textContent = '';
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array', dateNF: 'yyyy-mm-dd' });

          orders = workbook.SheetNames[0] ? XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]) : [];
          payouts = workbook.SheetNames[1] ? XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[1]]) : [];
          refunds = workbook.SheetNames[2] ? XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[2]]) : [];

          filteredOrders = [...orders];
          filteredPayouts = [...payouts];
          filteredRefunds = [...refunds];
          renderAll();
        } catch (err) {
          document.getElementById('errorMessage').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message;
        }
      };
      reader.onerror = function() {
        document.getElementById('errorMessage').textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.';
      };
      reader.readAsArrayBuffer(file);
    }

    function renderAll(){
      renderTable();
      renderPayouts();
      renderRefunds();
      calculateSummary();
      renderChart();
    }

    function applyDateFilter(){
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      filteredOrders = orders.filter(row => {
        const d = new Date(row.TRANSACTION_DATE);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredPayouts = payouts.filter(row => {
        const d = new Date(row.PAYOUT_DATE);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredRefunds = refunds.filter(row => {
        const d = new Date(row.DATE);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      renderAll();
    }

    function filterTable(tableId, query){
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
      });
    }

    function renderTable(){
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      filteredOrders.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.REFERENCE_ID || ''}</td>
          <td>${row.TRANSACTION_DATE || ''}</td>
          <td>${row.MERCHANT_NAME || ''}</td>
          <td>${Number(row.FOOD_GROSS_BASKET_AMOUNT || 0).toFixed(2)}</td>
          <td>${Number(row.PARTNER_FUNDED_PROMO_DISCOUNT || 0).toFixed(2)}</td>
          <td>${Number(row.BILLING_PLATFORM_FEE || 0).toFixed(2)}</td>
          <td>${Number(row.TOTAL_PAYOUT_AMOUNT || 0).toFixed(2)}</td>
          <td>${row.STATUS || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderPayouts(){
      const tbody = document.querySelector('#payoutsTable tbody');
      tbody.innerHTML = '';
      filteredPayouts.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.PAYOUT_ID || ''}</td>
          <td>${row.PAYOUT_DATE || ''}</td>
          <td>${row.PLATFORM || ''}</td>
          <td>${Number(row.PAYOUT_AMOUNT || 0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderRefunds(){
      const tbody = document.querySelector('#refundsTable tbody');
      tbody.innerHTML = '';
      filteredRefunds.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.CASE_ID || ''}</td>
          <td>${row.DATE || ''}</td>
          <td>${row.REASON || ''}</td>
          <td>${Number(row.AMOUNT || 0).toFixed(2)}</td>
          <td>${row.STATUS || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function calculateSummary(){
      let totalSales = 0, totalDiscount = 0, totalCommission = 0, totalRefund = 0, totalPayouts = 0;

      filteredOrders.forEach(row => {
        totalSales += Number(row.FOOD_GROSS_BASKET_AMOUNT) || 0;
        totalDiscount += Math.abs(Number(row.PARTNER_FUNDED_PROMO_DISCOUNT) || 0);
        totalCommission += Math.abs(Number(row.BILLING_PLATFORM_FEE) || 0) + 
                           Math.abs(Number(row.BILLING_PLATFORM_FEE_TAX) || 0) + 
                           Math.abs(Number(row.BILLING_PAYMENT_GATEWAY_FEE) || 0) + 
                           Math.abs(Number(row.BILLING_PAYMENT_GATEWAY_FEE_TAX) || 0);
      });

      filteredPayouts.forEach(row => totalPayouts += Number(row.PAYOUT_AMOUNT) || 0);
      filteredRefunds.forEach(row => totalRefund += Math.abs(Number(row.AMOUNT) || 0));

      const netProfit = totalSales - totalDiscount - totalCommission - totalRefund;
      const netProfitRate = totalSales ? ((netProfit / totalSales) * 100).toFixed(2) : 0;

      document.getElementById('orderCount').textContent = filteredOrders.length;
      document.getElementById('totalSales').textContent = totalSales.toFixed(2);
      document.getElementById('totalDiscount').textContent = totalDiscount.toFixed(2);
      document.getElementById('totalCommission').textContent = totalCommission.toFixed(2);
      document.getElementById('totalRefund').textContent = totalRefund.toFixed(2);
      document.getElementById('totalPayouts').textContent = totalPayouts.toFixed(2);
      document.getElementById('netProfit').textContent = netProfit.toFixed(2);
      document.getElementById('netProfitRate').textContent = netProfitRate;
    }

    function renderChart(){
      const ctx = document.getElementById('chart').getContext('2d');
      if (chartInstance) {
        chartInstance.destroy();
      }
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª', 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª', 'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª', 'Ø§Ù„Ø¯ÙØ¹Ø§Øª', 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­'],
          datasets: [{
            label: 'AED',
            data: [
              parseFloat(document.getElementById('totalSales').textContent) || 0,
              parseFloat(document.getElementById('totalDiscount').textContent) || 0,
              parseFloat(document.getElementById('totalCommission').textContent) || 0,
              parseFloat(document.getElementById('totalRefund').textContent) || 0,
              parseFloat(document.getElementById('totalPayouts').textContent) || 0,
              parseFloat(document.getElementById('netProfit').textContent) || 0
            ],
            backgroundColor: ['#27ae60','#e67e22','#c0392b','#8e44ad','#16a085','#2980b9']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function exportExcel(){
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(filteredOrders);
      const ws2 = XLSX.utils.json_to_sheet(filteredPayouts);
      const ws3 = XLSX.utils.json_to_sheet(filteredRefunds);
      XLSX.utils.book_append_sheet(wb, ws1, 'Orders');
      XLSX.utils.book_append_sheet(wb, ws2, 'Payouts');
      XLSX.utils.book_append_sheet(wb, ws3, 'Refunds');
      XLSX.writeFile(wb, 'restaurant_report.xlsx');
    }

    function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù…", 10, 15);
      doc.text("Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±: " + document.getElementById('orderCount').textContent, 10, 30);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: " + document.getElementById('totalSales').textContent + " AED", 10, 40);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: " + document.getElementById('totalDiscount').textContent + " AED", 10, 50);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª: " + document.getElementById('totalCommission').textContent + " AED", 10, 60);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª: " + document.getElementById('totalRefund').textContent + " AED", 10, 70);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª: " + document.getElementById('totalPayouts').textContent + " AED", 10, 80);
      doc.text("ğŸ’° ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: " + document.getElementById('netProfit').textContent + " AED", 10, 90);
      doc.text("ğŸ“ˆ Ù†Ø³Ø¨Ø© ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: " + document.getElementById('netProfitRate').textContent + "%", 10, 100);
      doc.save('restaurant_report.pdf');
    }
  </script>
</body>
</html>
