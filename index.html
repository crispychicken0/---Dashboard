<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken — Exec Sales Dashboard (June–Sep 2025)</title>

  <!-- Tailwind CDN for layout & quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js and plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Export libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Dark mode support -->
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>

  <style>
    :root{
      --brand-red: #d7263d;
      --brand-gold: #f2b705;
      --muted: #6b7280;
      --card-bg: #ffffff;
      --glass: rgba(255,255,255,0.6);
    }
    body { background: linear-gradient(180deg,#fbfbfc 0,#f1f5f9 100%); font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#0b1220; }
    .dark { background: linear-gradient(180deg,#1a202c 0,#2d3748 100%); color: #e2e8f0; }
    .dark .card { background: #2d3748; }
    .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 6px 20px rgba(11,17,32,0.06); }
    .kpi { min-width: 12rem; }
    .small { font-size: 0.85rem; color:var(--muted); }
    .badge-up { color: #166534; background: rgba(16,185,129,0.08); padding:2px 8px; border-radius:999px; font-weight:600; }
    .badge-down { color: #7f1d1d; background: rgba(239,68,68,0.08); padding:2px 8px; border-radius:999px; font-weight:600; }

    /* interactive branch card */
    .branch-card { transition: transform .18s ease, box-shadow .18s ease; cursor:pointer; }
    .branch-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(11,17,32,0.12); }
    .expandable .details { display:none; }
    .expandable.expanded .details { display:block; }

    /* charts grid */
    .charts-grid { display:grid; grid-template-columns: repeat(1,1fr); gap:1rem; }
    @media (min-width: 900px) { .charts-grid { grid-template-columns: repeat(2,1fr); } }

    /* small responsive tweak for KPI row */
    @media (min-width: 900px) {
      .kpi-row { display:flex; gap:1rem; }
    }

    /* DataTable override */
    table.dataTable { width:100% !important; }
    .top-controls { gap: 0.75rem; display:flex; align-items:center; flex-wrap:wrap; }
    
    /* Loading spinner */
    .spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--brand-red);
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Heatmap cell styles */
    .heatmap-cell {
      transition: all 0.2s ease;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .dark .heatmap-cell {
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .notification.success { background: #10b981; }
    .notification.error { background: #ef4444; }
    .notification.info { background: #3b82f6; }
    
    /* Tooltip styles */
    .tooltip {
      position: relative;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="p-6">
  <div class="max-w-7xl mx-auto">

    <!-- HEADER -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <img src="https://crispychicken-uae.com/logo.png" alt="Crispy Chicken" style="height:64px;width:auto; border-radius:8px;" />
        <div>
          <h1 class="text-2xl font-bold" style="color:var(--brand-red)">Crispy Chicken — Executive Sales Dashboard</h1>
          <div class="small">January – September 2025 &middot; Real time preview · For top management</div>
        </div>
      </div>

      <div class="top-controls">
        <div class="card px-3 py-2 flex items-center gap-3">
          <label for="rangeSelect" class="small">Date range</label>
          <select id="monthFilterTop" class="p-2 border rounded text-sm" aria-label="Select month">
            <option value="2025-01">January 2025</option>
            <option value="2025-02">February 2025</option>
            <option value="2025-03">March 2025</option>
            <option value="2025-04">April 2025</option>
            <option value="2025-05">May 2025</option>
            <option value="2025-06">June 2025</option>
            <option value="2025-07">July 2025</option>
            <option value="2025-08">August 2025</option>
            <option value="2025-09" selected>September 2025</option>
            <option value="all">Jan–Sep 2025 (All)</option>
          </select>
        </div>

        <button id="btnExportCSV" class="px-3 py-2 card text-sm font-semibold" title="Export CSV">
          Export CSV
        </button>
        
        <button id="btnExportPDF" class="px-3 py-2 card text-sm font-semibold" title="Export PDF">
          Export PDF
        </button>
        
        <button id="btnExportExcel" class="px-3 py-2 card text-sm font-semibold" title="Export Excel">
          Export Excel
        </button>

        <button id="btnReset" class="px-3 py-2 card text-sm font-semibold" title="Reset data">Reset</button>
        
        <button id="darkModeToggle" class="px-3 py-2 card text-sm font-semibold" title="Toggle dark mode">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    </header>

    <!-- KPI CARDS -->
    <section class="kpi-row mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Total Sales</div>
            <div id="kpiSales" class="text-2xl font-bold" style="color:var(--brand-red)">— AED</div>
            <div class="small mt-1">Period total</div>
          </div>
          <div class="text-right">
            <div class="small">Growth</div>
            <div id="kpiSalesDelta" class="small badge-up">+0.0%</div>
          </div>
        </div>
      </div>

      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Total Orders</div>
            <div id="kpiOrders" class="text-2xl font-bold">—</div>
            <div class="small mt-1">Period total</div>
          </div>
          <div class="text-right">
            <div class="small">Avg Order Value</div>
            <div id="kpiAOV" class="small">— AED</div>
          </div>
        </div>
      </div>

      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Delivery % of Sales</div>
            <div id="kpiDeliveryShare" class="text-2xl font-bold">— %</div>
            <div class="small mt-1">Delivery contribution</div>
          </div>
          <div class="text-right">
            <div class="small">Delivery Orders</div>
            <div id="kpiDeliveryOrders" class="small">—</div>
          </div>
        </div>
      </div>

      <div class="card kpi p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="small">Top Branch</div>
            <div id="kpiTopBranch" class="text-2xl font-bold" style="color:var(--brand-gold)">—</div>
            <div class="small mt-1">By sales</div>
          </div>
          <div class="text-right">
            <div class="small">Best Day</div>
            <div id="kpiPeakDay" class="small">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Branch Performance Cards -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3" style="color:var(--brand-red)">Branch Performance</h2>
      <div id="branches" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </section>

    <!-- Chart Filters -->
    <section class="mb-6">
      <div class="card p-4">
        <h3 class="font-semibold mb-3">Chart Filters</h3>
        <div class="flex flex-wrap gap-4">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium mb-1">Branches</label>
            <select id="branchFilter" multiple class="w-full p-2 border rounded" size="3">
              <option value="all" selected>All branches</option>
              <option value="Barsha">Barsha</option>
              <option value="Hamdan">Hamdan</option>
              <option value="Khalidiyah">Khalidiyah</option>
              <option value="Muroor">Muroor</option>
              <option value="Satwa">Satwa</option>
              <option value="Shabiya">Shabiya</option>
            </select>
          </div>
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium mb-1">Date Range</label>
            <div class="flex gap-2">
              <input type="date" id="startDate" class="flex-1 p-2 border rounded" placeholder="Start date">
              <input type="date" id="endDate" class="flex-1 p-2 border rounded" placeholder="End date">
            </div>
          </div>
          <div class="flex items-end">
            <button id="applyFilters" class="px-4 py-2 bg-red-600 text-white rounded font-medium">Apply Filters</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Charts grid -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3" style="color:var(--brand-red)">Sales Analysis</h2>
      <div class="charts-grid">
        <div class="card p-4">
          <h3 class="font-semibold mb-2">Total Sales by Branch</h3>
          <canvas id="barChart" height="220"></canvas>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold mb-2">Daily Sales Trend</h3>
          <canvas id="lineChart" height="220"></canvas>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold mb-2">Sales Distribution</h3>
          <canvas id="pieChart" height="220"></canvas>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold mb-2">Delivery Sales Heatmap</h3>
          <div id="heatmapContainer" style="height:220px; position:relative;"></div>
        </div>
      </div>
    </section>

    <!-- Data Input and Table -->
    <section class="mb-6">
      <div class="flex flex-col lg:flex-row gap-4">
        <div class="card p-4 flex-1">
          <h3 class="font-semibold mb-2">Quick Data Input</h3>
          <textarea id="dataInput" class="w-full h-28 p-2 border rounded mb-2" placeholder="Paste CSV rows: Date,Outlet,Orders,Sales,DeliveryOrders,DeliverySales"></textarea>
          <div class="flex gap-2">
            <button id="btnUpdate" class="px-3 py-2 bg-red-600 text-white rounded">Update Data</button>
            <button id="btnClearInput" class="px-3 py-2 border rounded">Clear</button>
            <div class="small self-center ml-auto text-gray-500">Tip: Use YYYY-MM-DD dates</div>
          </div>
        </div>

        <div class="card p-4 flex-1">
          <h3 class="font-semibold mb-2">Raw Data (drill-down)</h3>
          <table id="dataTable" class="display w-full">
            <thead>
              <tr>
                <th>Date</th>
                <th>Outlet</th>
                <th>Orders</th>
                <th>Sales (AED)</th>
                <th>Delivery Orders</th>
                <th>Delivery Sales (AED)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="text-sm text-gray-500 mt-6">
      Last updated: <span id="lastUpdated">—</span> &middot; Prepared for Top Management — Crispy Chicken
    </footer>
  </div>

  <!-- Notification container -->
  <div id="notificationContainer"></div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-4 rounded-lg flex items-center">
      <div class="spinner mr-3"></div>
      <span>Processing...</span>
    </div>
  </div>

  <!-- --------------- SCRIPT --------------- -->
  <script>
    // Register Chart plugins
    Chart.register(ChartDataLabels, window.ChartAnnotationPlugin || { id: 'annotation' });

    // Branch mapping for provided data
    const branchMapping = {
      'Barsha Shop': 'Barsha',
      'Hamdan Shop': 'Hamdan',
      'Khalidiyah Shop': 'Khalidiyah',
      'Muroor Shop': 'Muroor',
      'Satwa Shop': 'Satwa',
      'Shabiya Shop': 'Shabiya'
    };

    // Provided delivery sales data
    const providedDataString = `Sum of Delivery	Branch						
Date	Barsha Shop	Hamdan Shop	Khalydiha Shop	Mouroor Shop	Satwa Shop	Shabiha Shop	Grand Total
1/1/2025	1644.42	3826.34	2507.46	1491.36	546.85	1336.69	11353.12
1/2/2025	1874.26	2516.93	1839.71	1228.67	907.6	1511.48	9878.65
1/3/2025	1674.3	3338.91	1858.38	1392.6	562.73	1587.6	10414.52
1/4/2025	1677.43	4383.58	1498.64	1485.55	837.73	1192.66	11075.59
1/5/2025	1320.35	3410.83	1722.67	1709.27	568.79	954.68	9686.59
1/6/2025	1099.65	4599.34	1720.27	2175.13	807.68	1707.5	12109.57
1/7/2025	2218.85	4515.34	2463.98	1876.96	770.63	1951.52	13797.28
1/8/2025	1685.47	2940.91	1631.49	1689.31	557.79	1592.64	10097.61
1/9/2025	2274.9	2800.3	1643.33	2044.27	997.61	1567.41	11327.82
1/10/2025	2280.41	4231.62	2365.57	2538.04	1160.43	1920.52	14496.59
1/11/2025	1949.26	4181.46	2163.39	1892.35	1054.76	1713.34	12954.56
1/12/2025	1620.47	4012.76	1819.4	2215.43	1069.57	1558.49	12296.12
1/13/2025	1789.59	5220.35	2488.75	2776.5	1559.74	2249.67	16084.6
1/14/2025	2188.36	4965.58	2541.56	2836.61	1332.76	2228.78	16093.65
1/15/2025	1249.4	3886.86	1383.48	1944.43	437.82	1683.31	10585.3
1/16/2025	1471.46	3212.9	1488.65	1959.35	673.71	1270.68	10076.75
1/17/2025	1577.39	3295.87	2695.2	1963.06	717.69	2117.55	12366.76
1/18/2025	1290.27	3477.94	1915.32	1464.79	758.72	1434.49	10341.53
1/19/2025	988	2446.9	1441.9	1148	512	1702	8238.8
1/20/2025	3317	5909	2198.9	2607	1216.9	2304	17552.8
1/21/2025	2333	5323.9	2684	2338	912	2570	16160.9
1/22/2025	1510.9	3472.9	1367	1194.8	869	904.9	9319.5
1/23/2025	1705.9	2808.9	1661.9	1650	557	1528	9911.7
1/24/2025	2127	4341.8	2298.8	1355	413	2854	13389.6
1/25/2025	1611	3025	1887	1712	980	2053.8	11268.8
1/26/2025	1515	2092	1108	1583.9	1085	548	7931.9
1/27/2025	1716	5718.9	2047	1928	911	2206	14526.9
1/28/2025	2818	5546	2624	2897	1442	2395	17722
1/29/2025	1795	2606	1851	1898	758	1210	10118
1/30/2025	1667	2825.7	1599	2025.4	721	1020	9858.1
1/31/2025	1762	4365.6	1844.6	2727.9	1149	1903	13752.1
2/1/2025	2433	3825.9	2693	1783	888	1839	13461.9
2/2/2025	1730	2734	1351	2175	844	1223	10057
2/3/2025	1895	5713.9	1973	2187	922	2763	15453.9
2/4/2025	2172	5149	2312	3296	973.9	2511	16413.9
2/5/2025	1381	2080	1600.8	1418	485	1178	8142.8
2/6/2025	1729	2963	1595.9	1682	905	1929.9	10804.8
2/7/2025	2481.9	3513.9	2204.9	1782	751	1991	12724.7
2/8/2025	1763	4977.8	2920	1446	483.9	2271.9	13862.6
2/9/2025	1345	3256.9	977	1397.9	600	1500	9076.8
2/10/2025	2592.7	9352	1902	3030	1387	2728	20991.7
2/11/2025	2053	6183	1835	2771	1009	2609	16460
2/12/2025	1628	3116.8	1328	2287.9	593.9	1000	9954.6
2/13/2025	1761	2736.8	1460.9	1298.9	786	1368	9411.6
2/14/2025	1635	4573.8	2339.9	2586.8	821	1806	13762.5
2/15/2025	1577	2821.9	1817	1492.9	629	2161.9	10499.7
2/16/2025	1384.9	3022.8	1349	2695.8	797	1828	11077.5
2/17/2025	2040	5180.9	2233	2745	1351	3401	16950.9
2/18/2025	1656	5282	1937	3019	1459	1950	15303
2/19/2025	2142	1833	1197	778	434	605	6989
2/20/2025	1911	3015.9	846	1996.8	457	599	8825.7
2/21/2025	1954	3731.9	2080	2645	591	1509	12510.9
2/22/2025	1175	4756.9	1713	1801.9	1567	1446.9	12460.7
2/23/2025	1638	3429	1588.8	1129.9	1106	1407	10298.7
2/24/2025	1535	3524	1757.7	1612.9	1081	2170	11680.6
2/25/2025	2629	4078.8	1971	1885	1062	2373.8	13999.6
2/26/2025	1859	3330	2170.9	2029.8	919.9	1948	12257.6
2/27/2025	2308.9	3325.8	2151	2163	805	1542	12295.7
2/28/2025	1290	4035.9	2412.9	3301	640	1445.9	13125.7
3/1/2025	754	2299	753	914	589	799	6108
3/2/2025	540.9	2156	995.9	474	654	697	5517.8
3/3/2025	561	2538	847	1012	747	1202	6907
3/4/2025	1231	1838	962	1011	515	702	6259
3/5/2025	1162	2042.8	994	1113	569.9	827	6708.7
3/6/2025	1353	2384.9	1141	1395	404	1076	7753.9
3/7/2025	1787	2623	1459	921	439	1396.8	8625.8
3/8/2025	2007.9	2508	1369	1476.9	579	1324	9264.8
3/9/2025	1224	2363	1150.9	1024	562	1212	7535.9
3/10/2025	1135	2624.9	1409	1201	471	887	7727.9
3/11/2025	1298.9	2340.8	1088	1342.9	712	1358.9	8141.5
3/12/2025	887	2182	1116	1100	976	850	7111
3/13/2025	989	2454	1180	1156	401.9	1093	7273.9
3/14/2025	1005	2978.9	1742	1005	793	1221.8	8745.7
3/15/2025	1445	3246	1663	866	991	1027	9238
3/16/2025	1568	2380	1497	1188	645	1211.9	8489.9
3/17/2025	1267	1733	902	1183	443	1123	6651
3/18/2025	814	3212.9	1209	1598	354	1256	8443.9
3/19/2025	1206	1647.9	1892	1203.8	557	1475	7981.7
3/20/2025	1330	2876.9	945	1249.8	699	1633	8733.7
3/21/2025	1199	3716.8	1584	1647.9	742	1357.9	10247.6
3/22/2025	1703	2556.9	856	1301.9	776.9	1729.9	8924.6
3/23/2025	1347	2214.9	1236	1020	663	1336.9	7817.8
3/24/2025	1269	3100.9	1517	1082	761	1030	8759.9
3/25/2025	1768	2631	1513	1314	437	1434	9097
3/26/2025	1756	2111	1559.9	898	971	1258	8553.9
3/27/2025	1903	2649	1739	1429	1063	1628	10411
3/28/2025	1575	3737.8	1993	1701.9	550	1398	10955.7
3/29/2025	1719	5034	1713	2592	754	2184	13996
3/30/2025	2413.9	5554.9	3767	3191	1594.9	2223	18744.7
3/31/2025	1856	6045.9	2827.9	3195.9	1519	2321	17765.7
4/1/2025	2059	4877.15	2128.9	2820.8	909	1286	14080.85
4/2/2025	1618	2944.9	1092	1512.8	745	1440	9352.7
4/3/2025	1321.8	2491	1660.9	1260.9	948	1077	8759.6
4/4/2025	1945	3929	2218.9	2534.9	859	885	12371.8
4/5/2025	2258	3508	1736.9	1572.9	1317	1833	12225.8
4/6/2025	2016.9	3932.9	1981.9	1731	1098	2401	13161.7
4/7/2025	2988.9	5638	3136	2993	1333	3161	19249.9
4/8/2025	2439	5468	3113.9	3188	1497	3292.5	18998.4
4/9/2025	2169.9	3140	794	1210.9	1465	1310	10089.8
4/10/2025	2804.9	2791	2352	1334	508	1027	10816.9
4/11/2025	1457	3711	1861	2565	1055	2030.8	12679.8
4/12/2025	2533.9	3285	1947.9	1313	1117	1556	11752.8
4/13/2025	1288	3117	973	1309.9	633	1409	8729.9
4/14/2025	2236	3608.5	1395	2404.8	1265	2444.9	13354.2
4/15/2025	2097	3926	2317.8	2517	1164.9	2827	14849.7
4/16/2025	1684	2865	1549.8	1410.7	587	2069.9	10166.4
4/17/2025	2184	2269	955	1353	732	1623	9116
4/18/2025	1309	3252	1241	1410	909	1960	10081
4/19/2025	2308.9	2938	1708.9	1725.9	590	2036	11307.7
4/20/2025	1778	2550.9	1672	1105	785	1631	9521.9
4/21/2025	2596	5537	2244	2501	1701	2197	16776
4/22/2025	2969.9	4321	2240	3157	1307	2835	16829.9
4/23/2025	1660.9	2095	1875	1186	657	1729	9202.9
4/24/2025	1400	2236	1326	1506	563	1229	8260
4/25/2025	1787	3272	2161.4	1931	1006	1668.9	11826.3
4/26/2025	1150	3734.8	2168	985	670	2086	10793.8
4/27/2025	1927	2903.8	1246	1526.8	746	1355	9704.6
4/28/2025	2375	5249	2396	1871	1263	1952	15106
4/29/2025	3299.9	4515	1939	2791	811	2983	16338.9
4/30/2025	1758.9	2519	1352.8	2066.9	912.9	1646	10256.5
5/1/2025	1074	3996	1779	2013	412	1815	11089
5/2/2025	1400	3532.9	1774	2326	606	1785.8	11424.7
5/3/2025	1238.9	3626.8	1588	2179.9	838	1875	11346.6
5/4/2025	1090	3779	1514	1526.9	861	1267	10037.9
5/5/2025	1534	5807	2234	2827	1255	2674.9	16331.9
5/6/2025	1468	5692.8	2674	2425	774	1771.9	14805.7
5/7/2025	1400	3989	1401	1364	509	1455.9	10118.9
5/8/2025	869	2548	1247	887	466	1517.9	7534.9
5/9/2025	1149	3195	2200	1967	391	2414	11316
5/10/2025	1572	3824	1505.9	1728	805	1666.9	11101.8
5/11/2025	1128	3073.9	1192	1072.8	593	1568.9	8628.6
5/12/2025	1412	3098	1795.9	1721	791	2673.9	11491.8
5/13/2025	1228	4404	2350	2287	841	2537	13647
5/14/2025	737	2278	1644.8	1300.9	423	793	7176.7
5/15/2025	925.8	3168	1764.8	1953.9	481.9	1267	9561.4
5/16/2025	797	3950	1637	2001.9	343	2924	11652.9
5/17/2025	1491	3925	2624.9	1498	1125	2979	13642.9
5/18/2025	1001	4243	1638.9	1458	705	2387	11432.9
5/19/2025	2593.9	5761	2743	2613	1380	2463.9	17554.8
5/20/2025	1970	6108	1975	2869	1344	2425	16691
5/21/2025	1017	2202	1241	1592.8	308	1011	7371.8
5/22/2025	1164	2377.9	1079.9	1241.9	431.9	978	7273.6
5/23/2025	956	3560	1496	1138	640	1587	9377
5/24/2025	689	3868.7	1502.9	2058	562	1520	10200.6
5/25/2025	975.9	3131	1707	951	786	1507.9	9058.8
5/26/2025	590	2555	1491	1159.9	671	1062	7528.9
5/27/2025	900	3614	1284	2237	272.9	1924	10231.9
5/28/2025	1125.9	3604	1501.8	1122	393	1541.8	9288.5
5/29/2025	969	3081.9	1384	1452	468	2058.9	9413.8
5/30/2025	982	4941.9	2478	1879	626	1261.9	12168.8
5/31/2025	1541	4129.7	2160.8	1451	528	1987.9	11798.4
6/1/2025	1415.9	3234.9	1767	1357.9	746	1278	9799.7
6/2/2025	3747	7081	2603.9	3063	1232	2578	20304.9
6/3/2025	3225	5261	2695	3045	1158	3538.9	18922.9
6/4/2025	1013	3362.9	1733	1886.9	701	1561	10257.8
6/5/2025	1851	2788.9	1824	2778.9	391	1679	11312.8
6/6/2025	1527.9	5314.9	2878.9	2927.8	1748	2487	16884.5
6/7/2025	1100	4406.9	3055	1524	765	1924.9	12775.8
6/8/2025	999	3239.9	1286	1849.9	684	1364	9422.8
6/9/2025	1531.9	2860	1164	1267	512	1547	8881.9
6/10/2025	969	3153.9	1607	1965	374	1517.9	9586.8
6/11/2025	962.9	2197	1149	1818	711	1470	8307.9
6/12/2025	804	3112	2178	1406.9	346.9	1231	9078.8
6/13/2025	932	2991.8	2406.8	1260.9	410	2198.9	10200.4
6/14/2025	1022.9	5232	1622	2023	648	2268.8	12816.7
6/15/2025	1020	3033.9	1153.9	1403.8	615	1300.9	8527.5
6/16/2025	2170	5549.9	2962	3144	1369	2792	17986.9
6/17/2025	2691	5099.8	2693	3049	760	3439	17731.8
6/18/2025	1231	2349	1935.9	1341.9	428	1682.8	8968.6
6/19/2025	795	2650	1211	1617	707.9	1599	8579.9
6/20/2025	1039	3612	1623	2610	209	1565	10658
6/21/2025	754	3040	2407.9	1857	684	2456	11198.9
6/22/2025	1149	2515.9	1221	1324	983	2165.7	9358.6
6/23/2025	1244	2895.8	1583	1217	559	1749	9247.8
6/24/2025	890	2368.9	2231	1142.9	847.9	922	8402.7
6/25/2025	866	2871	1131	536	474	1203	7081
6/26/2025	1583	3281.9	1968	1941	491	1787.8	11052.7
6/27/2025	1489	3520.9	1752.8	1531	677.9	1257.9	10229.5
6/28/2025	1693.9	3579	1744.9	1716.9	598	1559	10891.7
6/29/2025	963.8	2502.9	1503	1508	630	1422	8529.7
6/30/2025	756	3121	1768.9	1932	544	1065	9186.9
7/1/2025	1551	3164.7	1512	1839	1675	1735	11476.7
7/2/2025	1090	3276	1655	1472	901	1414	9808
7/3/2025	661	2601	1937	1650	1008	1825.9	9682.9
7/4/2025	1544	3869	1781.9	1919	351	1653	11117.9
7/5/2025	1215	3164.9	1205	1815.8	566	1730	9696.7
7/6/2025	835	2800.9	1319.9	1516	401	1358	8230.8
7/7/2025	2191	5118.9	2411	2440	1052	2490	15702.9
7/8/2025	2262	6098	2735	3438	1127	3022.9	18682.9
7/9/2025	1441.9	1719	1504	1160	717	1295	7836.9
7/10/2025	1005	1940.8	1319	738	525	2541	8068.8
7/11/2025	955	2617	1873.9	2923	853	1172	10393.9
7/12/2025	1180.9	3744.8	1724.9	1115	717	1402	9884.6
7/13/2025	1180.9	2798	927.8	1321	527	2100	8854.7
7/14/2025	2191	5996	2555	2536	878	3007	17163
7/15/2025	2347	5352	2767	3039	1362	2924	17791
7/16/2025	1053	2163	1705.9	960	277	1288	7446.9
7/17/2025	811	2719.9	1185.9	738	252.9	992	6699.7
7/18/2025	981	2371	1016.9	805.7	402	1366	6942.6
7/19/2025	1543	2882.9	1044	1022	625	1477	8593.9
7/20/2025	1076	2123	1544	1015	460	1271	7489
7/21/2025	2527	5302	2459	2390	900	2069	15647
7/22/2025	1778	5524	2311	2488.9	1403	3086	16590.9
7/23/2025	932	2300	1192	1110.9	353	834	6721.9
7/24/2025	652	1976	1998	1190	640	1633	8089
7/25/2025	1213	2762.9	1143	1459	1345	1256	9178.9
7/26/2025	980	3732.7	1254.8	1101	1013	1426	9507.5
7/27/2025	1264	2991.9	1438	1581	673	1329	9276.9
7/28/2025	2132	6855	2016	2023	1226	2661	16913
7/29/2025	2566	6586	2414.9	2701	1480.9	2457	18205.8
7/30/2025	1443	2119	564	1182	579	1389	7276
7/31/2025	2025	2535	1102	2312	395	956	9325
8/1/2025	1218	2776	1604	1849.9	305	2134	9886.9
8/2/2025	1299	2626	1119.8	1345	1072	2035.9	9497.7
8/3/2025	850.9	2930	2119	1025	642	1410	8976.9
8/4/2025	3297	3664	1357	1361.9	624	1432	11735.9
8/5/2025	1683.8	2977.8	1286	1434	365.9	1117	8864.5
8/6/2025	1633	3076.9	533	1218	533	924	7917.9
8/7/2025	1581	1980	1593	1056	557	1169	7936
8/8/2025	1292	2757.9	1723.7	1466	909	2850.9	10999.5
8/9/2025	1160	3080	1657.9	1348	612	985	8842.9
8/10/2025	770	3323.9	1414	1300	528	1813	9148.9
8/11/2025	3120	6229.9	2057	2646	1698	2902	18652.9
8/12/2025	2819	5595	2435	1781	1691	2771	17092
8/13/2025	1048	2512.9	1057	1328	382	1188.9	7516.8
8/14/2025	719	3196	1164	709.9	456	1361	7605.9
8/15/2025	1154	3050	1135	1371	272	1091	8073
8/16/2025	875	2765	2138	1009.9	463	1261	8511.9
8/17/2025	2158	2860.9	1650.8	980	964.9	1405	10019.6
8/18/2025	3169	5396	2857	2157	1926	3491	18996
8/19/2025	1962	5876	2646	3254	1406	3608	18752
8/20/2025	1041	2836	1642	1077	325	1338	8259
8/21/2025	1086	1960	1291	1463	430	1042	7272
8/22/2025	836	3662	2196	1463	288	2024.9	10469.9
8/23/2025	1085	4016	2310.8	1632	641	3017	12701.8
8/24/2025	1133	2606	1047	992	531	1324	7633
8/25/2025	1129	3074	1280	767	795	1813	8858
8/26/2025	1482	2403	1374.9	941	555	1326	8081.9
8/27/2025	4334	2337	812	1305	509	1389	10686
8/28/2025	923	3664.9	1776	1244.9	423	1771	9802.8
8/29/2025	1617	3382	2505	2133	679	2202	12518
8/30/2025	1719	4213	2174.5	1398	1145	1908	12557.5
8/31/2025	1102	2356	1083	1304.9	748	1231	7824.9
9/1/2025	3312	5980	3228	3111	2031	2696	20358
9/2/2025	1623	5976	2931	3059	1907	3404.9	18900.9
9/3/2025	1651.9	2810	1497	2093	514	1688	10253.9
9/4/2025	1715	4375.8	1662	2147.9	613	2201	12714.7
9/5/2025	1227	4917.9	1727	2073	725	1764	12433.9
9/6/2025	938	3277	2218	1584	812	2496	11325
9/7/2025	1056	2404	1482	1788.8	400	1683	8813.8
9/8/2025	2868	3992	1980	1949	1241	2469	14499
9/9/2025	1298	4685	2600	1850	997	2733	14163
9/10/2025	1006	2238.9	934	1617	224	1533	7552.9
9/11/2025	1353	4132	1513.9	1937	304	1366	10605.9
9/12/2025	1479	3988	2584	2082	566	2351	13050
9/13/2025	1861	3234	1807.9	1317	720	2024	10963.9
9/14/2025	1620	2143	1731	1215	551	1917	9177
9/15/2025	2221	5748	2026	1730	1291	3383	16399
9/16/2025	1859	5189	1925	2024	1146	2894	15037
9/17/2025	716	2084	1926.9	1028	523	945	7222.9
9/18/2025	1118	2656	1512	1511.9	647	1282	8726.9
9/19/2025	1348	2540	2426	1418	365	1915	10012
9/20/2025	1016	2053	2571.9	1557.9	923	1564.9	9686.7
9/21/2025	999.9	2910	1727.9	739	951	1842.9	9170.7
9/22/2025	2382	3576	2316	1560	1191	2845	13870
9/23/2025	1982	4198	2073	2024	1037	3294	14608
9/24/2025	104	58	42	44	0	52	300
Grand Total	420048.64	946103.57	472052.85	465960.18	210759.41	473290.11	2988214.76`;

    // --- Sample data building ---
    const branches = ['Barsha', 'Hamdan', 'Khalidiyah', 'Muroor', 'Satwa', 'Shabiya'];

    // Initial sales data structure
    let salesData = [];

    // Function to integrate provided delivery sales data
    function integrateProvidedData(dataString) {
      const lines = dataString.trim().split('\n');
      // Skip header and last line (Grand Total)
      const dataLines = lines.slice(1, -1);
      
      // Branch names in the header (after the first column)
      const branchHeaders = lines[0].split('\t').slice(1, -1); // skip first (Date) and last (Grand Total)
      
      dataLines.forEach(line => {
        const parts = line.split('\t');
        const dateStr = parts[0];
        // Convert date: "1/1/2025" -> "2025-01-01"
        const [month, day, year] = dateStr.split('/');
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        
        // For each branch, update the corresponding value
        branchHeaders.forEach((header, index) => {
          const value = parseFloat(parts[index+1]); // because parts[0] is date, then branches
          const mappedBranch = branchMapping[header];
          
          // Find the matching row in salesData
          const matchingRow = salesData.find(row => 
            row.date === formattedDate && row.outlet === mappedBranch
          );
          
          if (matchingRow) {
            matchingRow.deliverySales = value;
          }
        });
      });
    }

    // Generate sample data for all months from January to September 2025
    function generateSampleData() {
      // Clear existing data
      salesData = [];
      
      // Generate data for each month
      const months = [
        { month: '2025-01', days: 31 },
        { month: '2025-02', days: 28 },
        { month: '2025-03', days: 31 },
        { month: '2025-04', days: 30 },
        { month: '2025-05', days: 31 },
        { month: '2025-06', days: 30 },
        { month: '2025-07', days: 31 },
        { month: '2025-08', days: 31 },
        { month: '2025-09', days: 24 }
      ];
      
      months.forEach(({ month, days }) => {
        for (let day = 1; day <= days; day++) {
          const date = `${month}-${String(day).padStart(2, '0')}`;
          
          branches.forEach(branch => {
            // Generate random but realistic data
            const baseOrders = Math.floor(Math.random() * 50) + 30; // 30-80 orders per day
            const baseSales = baseOrders * (Math.random() * 30 + 40); // 40-70 AED per order
            const deliveryRatio = Math.random() * 0.5 + 0.3; // 30-80% delivery
            const deliveryOrders = Math.floor(baseOrders * deliveryRatio);
            const deliverySales = baseSales * deliveryRatio;
            
            salesData.push({
              date,
              outlet: branch,
              count: baseOrders,
              total: parseFloat(baseSales.toFixed(2)),
              deliveryOrders,
              deliverySales: parseFloat(deliverySales.toFixed(2))
            });
          });
        }
      });
    }

    // Generate initial sample data
    generateSampleData();

    // Integrate provided delivery sales data
    integrateProvidedData(providedDataString);

    // restore from localStorage if exists (user edits persist)
    const saved = localStorage.getItem('salesData');
    if (saved) {
      try {
        const savedData = JSON.parse(saved);
        // Update salesData with saved data, preserving provided delivery sales
        savedData.forEach(savedRow => {
          const existingRow = salesData.find(row => 
            row.date === savedRow.date && row.outlet === savedRow.outlet
          );
          
          if (existingRow) {
            // Update all fields except deliverySales (which comes from provided data)
            existingRow.count = savedRow.count;
            existingRow.total = savedRow.total;
            existingRow.deliveryOrders = savedRow.deliveryOrders;
            // deliverySales remains from provided data
          }
        });
      } catch (e) {
        console.error('Error loading saved data:', e);
      }
    }

    // DataTable reference
    let dataTable;

    // Chart instances
    let barChart, lineChart, pieChart, heatmapChart;

    // --- Utilities ---
    function formatAED(v){ return Number(v).toLocaleString('en-AE', { maximumFractionDigits:1, minimumFractionDigits: 1 }) + ' AED'; }
    function formatNumber(v){ return Number(v).toLocaleString('en-AE'); }
    function lastUpdatedText(){ document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-GB'); }
    
    // Notification system
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Loading state management
    function showLoading() {
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    // Data validation
    function validateRow(row) {
      // Check required fields
      if (!row.date || !row.outlet || isNaN(row.count) || isNaN(row.total) || isNaN(row.deliveryOrders) || isNaN(row.deliverySales)) {
        return false;
      }
      // Check date format (YYYY-MM-DD)
      if (!/^\d{4}-\d{2}-\d{2}$/.test(row.date)) {
        return false;
      }
      // Check non-negative numbers
      if (row.count < 0 || row.total < 0 || row.deliveryOrders < 0 || row.deliverySales < 0) {
        return false;
      }
      return true;
    }
    
    // Dark mode toggle
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
      updateChartsTheme();
    }
    
    // Update charts theme
    function updateChartsTheme() {
      const isDark = document.body.classList.contains('dark');
      const textColor = isDark ? '#e2e8f0' : '#0b1220';
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      
      if (barChart) {
        barChart.options.scales.x.ticks.color = textColor;
        barChart.options.scales.y.ticks.color = textColor;
        barChart.options.scales.x.grid.color = gridColor;
        barChart.options.scales.y.grid.color = gridColor;
        barChart.update();
      }
      
      if (lineChart) {
        lineChart.options.scales.x.ticks.color = textColor;
        lineChart.options.scales.y.ticks.color = textColor;
        lineChart.options.scales.x.grid.color = gridColor;
        lineChart.options.scales.y.grid.color = gridColor;
        lineChart.update();
      }
      
      if (pieChart) {
        pieChart.options.plugins.legend.labels.color = textColor;
        pieChart.update();
      }
      
      if (heatmapChart) {
        heatmapChart.options.scales.x.ticks.color = textColor;
        heatmapChart.options.scales.y.ticks.color = textColor;
        heatmapChart.options.scales.x.grid.color = gridColor;
        heatmapChart.options.scales.y.grid.color = gridColor;
        heatmapChart.update();
      }
    }

    // --- KPI calculations ---
    function calculateKPIs(filtered){
      const totalSales = filtered.reduce((s,r)=>s+(r.total||0),0);
      const totalOrders = filtered.reduce((s,r)=>s+(r.count||0),0);
      const deliverySales = filtered.reduce((s,r)=>s+(r.deliverySales||0),0);
      const deliveryOrders = filtered.reduce((s,r)=>s+(r.deliveryOrders||0),0);
      const aov = totalOrders ? totalSales/totalOrders : 0;

      // top branch
      const byBranch = {};
      filtered.forEach(r => { byBranch[r.outlet] = (byBranch[r.outlet]||0) + (r.total||0); });
      const topBranch = Object.entries(byBranch).sort((a,b)=>b[1]-a[1])[0] || ['—',0];

      // peak day
      const byDate = {};
      filtered.forEach(r=>{ byDate[r.date] = (byDate[r.date]||0) + (r.total||0); });
      const peak = Object.entries(byDate).sort((a,b)=>b[1]-a[1])[0] || ['—',0];

      return {
        totalSales, totalOrders, deliverySales, deliveryOrders, aov,
        topBranch: topBranch[0], topBranchSales: topBranch[1],
        peakDate: peak[0], peakValue: peak[1]
      };
    }

    // --- Render branch cards ---
    function renderBranchCards(selectedMonth, selectedBranches = ['all']){
      const container = document.getElementById('branches');
      const filtered = selectedMonth === 'all' ? salesData : salesData.filter(d => d.date && d.date.startsWith(selectedMonth));
      const metrics = branches.map(branch => {
        const rows = filtered.filter(d => selectedBranches.includes('all') || selectedBranches.includes(branch));
        const totalOrders = rows.reduce((s,r)=>s+(r.count||0),0);
        const totalSales = rows.reduce((s,r)=>s+(r.total||0),0);
        const delOrders = rows.reduce((s,r)=>s+(r.deliveryOrders||0),0);
        const delSales = rows.reduce((s,r)=>s+(r.deliverySales||0),0);
        const avg = totalOrders ? (totalSales/totalOrders).toFixed(1) : 0;
        return { branch, totalOrders, totalSales, delOrders, delSales, avg };
      });

      container.innerHTML = metrics.map(m=>`
        <div class="branch-card card p-4 expandable" onclick="toggleBranch(this)">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-semibold text-lg" style="color:var(--brand-red)">${m.branch}</h4>
              <div class="small text-gray-500">${formatNumber(m.totalOrders)} Orders · ${formatAED(m.totalSales)}</div>
            </div>
            <div class="text-right">
              <div class="small">Delivery</div>
              <div class="font-semibold">${formatNumber(m.delOrders)} · ${formatAED(m.delSales)}</div>
              <div class="small mt-1">Avg ${m.avg} AED</div>
            </div>
          </div>
          <div class="details mt-3 small text-gray-600">
            Peak Day & analysis placeholder — add notes here for this branch.
          </div>
        </div>
      `).join('');
    }

    function toggleBranch(el){
      el.classList.toggle('expanded');
    }

    // --- Charts update ---
    function updateCharts(selectedMonth, selectedBranches = ['all'], startDate = null, endDate = null){
      showLoading();
      
      // Filter data based on all criteria
      let filtered = selectedMonth === 'all' ? salesData : salesData.filter(d => d.date && d.date.startsWith(selectedMonth));
      
      if (selectedBranches && !selectedBranches.includes('all')) {
        filtered = filtered.filter(d => selectedBranches.includes(d.outlet));
      }
      
      if (startDate && endDate) {
        filtered = filtered.filter(d => d.date >= startDate && d.date <= endDate);
      }
      
      // totals per branch
      const branchTotals = branches.map(b => filtered.filter(r=>r.outlet===b).reduce((s,r)=>s+(r.total||0),0));
      const branchOrders = branches.map(b => filtered.filter(r=>r.outlet===b).reduce((s,r)=>s+(r.count||0),0));

      // daily labels: find unique sorted days in filtered set
      const dates = Array.from(new Set(filtered.map(r=>r.date))).sort();
      const dailyTotals = dates.map(dt => filtered.filter(r=>r.date===dt).reduce((s,r)=>s+(r.total||0),0));
      const dailyDelivery = dates.map(dt => filtered.filter(r=>r.date===dt).reduce((s,r)=>s+(r.deliverySales||0),0));

      // BAR
      if (barChart) barChart.destroy();
      const barCtx = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: branches,
          datasets: [{
            label: `Sales (${selectedMonth === 'all' ? 'Jan–Sep' : selectedMonth})`,
            data: branchTotals,
            backgroundColor: branches.map(() => 'rgba(215,38,61,0.85)'),
            borderColor: branches.map(() => 'rgba(215,38,61,1)'),
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { display: false }, title: { display: true, text: 'Total Sales by Branch' }, datalabels: { display: false } },
          scales: { 
            y: { 
              beginAtZero:true, 
              title: { display:true, text: 'Sales (AED)' },
              ticks: { color: document.body.classList.contains('dark') ? '#e2e8f0' : '#0b1220' },
              grid: { color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
            },
            x: {
              ticks: { color: document.body.classList.contains('dark') ? '#e2e8f0' : '#0b1220' },
              grid: { color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
            }
          }
        }
      });

      // LINE (daily sales)
      if (lineChart) lineChart.destroy();
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Daily Sales',
            data: dailyTotals,
            borderColor: 'rgba(242,183,5,1)',
            backgroundColor: 'rgba(242,183,5,0.12)',
            fill: true,
            tension: 0.3,
            pointRadius: 2
          }]
        },
        options: {
          plugins: { legend: { display: false }, title: { display: true, text: 'Daily Sales Trend' } },
          scales: { 
            x: { 
              ticks: { 
                autoSkip: true, 
                maxTicksLimit: 10,
                color: document.body.classList.contains('dark') ? '#e2e8f0' : '#0b1220'
              },
              grid: { color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
            }, 
            y: { 
              beginAtZero:true, 
              title: { display:true, text: 'Sales (AED)' },
              ticks: { color: document.body.classList.contains('dark') ? '#e2e8f0' : '#0b1220' },
              grid: { color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
            } 
          }
        }
      });

      // PIE (distribution)
      if (pieChart) pieChart.destroy();
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: branches,
          datasets: [{
            data: branchTotals,
            backgroundColor: ['#d7263d','#f29a2e','#7c3a9b','#ef476f','#66a61e','#f2b705'],
            borderColor: '#fff',
            borderWidth: 1
          }]
        },
        options: {
          plugins: { 
            title: { display: true, text: 'Sales Distribution (by Branch)', color: document.body.classList.contains('dark') ? '#e2e8f0' : '#0b1220' },
            legend: { labels: { color: document.body.classList.contains('dark') ? '#e2e8f0' : '#0b1220' } },
            datalabels: { 
              formatter: (v,ctx)=> { 
                const sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); 
                return sum? ((v/sum)*100).toFixed(1)+'%':''; 
              } 
            } 
          }
        }
      });

      // HEATMAP
      renderHeatmap(filtered, dates);
      
      // Update KPI cards
      const k = calculateKPIs(filtered);
      document.getElementById('kpiSales').textContent = formatAED(k.totalSales);
      document.getElementById('kpiOrders').textContent = formatNumber(k.totalOrders);
      document.getElementById('kpiAOV').textContent = formatAED(k.aov);
      const deliveryShare = k.totalSales ? ((k.deliverySales / k.totalSales) * 100).toFixed(1) : 0;
      document.getElementById('kpiDeliveryShare').textContent = deliveryShare + ' %';
      document.getElementById('kpiDeliveryOrders').textContent = formatNumber(k.deliveryOrders);
      document.getElementById('kpiTopBranch').textContent = k.topBranch;
      document.getElementById('kpiPeakDay').textContent = k.peakDate !== '—' ? new Date(k.peakDate).toLocaleDateString('en-GB') + ' · ' + formatAED(k.peakValue) : '—';

      // simple growth delta placeholder: compares with previous month in data (if exists)
      const prevMonth = (selectedMonth === '2025-09') ? '2025-08' : 
                       (selectedMonth === '2025-08') ? '2025-07' : 
                       (selectedMonth === '2025-07') ? '2025-06' : 
                       (selectedMonth === '2025-06') ? '2025-05' : 
                       (selectedMonth === '2025-05') ? '2025-04' : 
                       (selectedMonth === '2025-04') ? '2025-03' : 
                       (selectedMonth === '2025-03') ? '2025-02' : 
                       (selectedMonth === '2025-02') ? '2025-01' : null;
      
      if (prevMonth) {
        const current = k.totalSales;
        const prev = salesData.filter(d=>d.date && d.date.startsWith(prevMonth)).reduce((s,r)=>s+(r.total||0),0);
        const pct = prev ? (((current - prev)/prev)*100).toFixed(1) : '0.0';
        const el = document.getElementById('kpiSalesDelta');
        el.textContent = (pct > 0 ? '+' : '') + pct + '%';
        el.className = pct >= 0 ? 'small badge-up' : 'small badge-down';
      } else {
        document.getElementById('kpiSalesDelta').textContent = '—';
      }
      
      hideLoading();
    }
    
    // Render heatmap using custom implementation
    function renderHeatmap(filtered, dates) {
      const container = document.getElementById('heatmapContainer');
      container.innerHTML = '';
      
      // Find max value for normalization
      let maxValue = 0;
      dates.forEach(date => {
        branches.forEach(branch => {
          const value = filtered.find(r => r.date === date && r.outlet === branch)?.deliverySales || 0;
          maxValue = Math.max(maxValue, value);
        });
      });
      
      // Create grid
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 gap-1';
      grid.style.gridTemplateColumns = `repeat(${dates.length}, 1fr)`;
      
      // Create header row (dates)
      const headerRow = document.createElement('div');
      headerRow.className = 'grid grid-cols-1 gap-1';
      headerRow.style.gridTemplateColumns = `repeat(${dates.length}, 1fr)`;
      
      dates.forEach(date => {
        const cell = document.createElement('div');
        cell.className = 'text-xs text-center p-1';
        cell.textContent = new Date(date).getDate();
        headerRow.appendChild(cell);
      });
      grid.appendChild(headerRow);
      
      // Create data rows
      branches.forEach(branch => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 gap-1';
        row.style.gridTemplateColumns = `repeat(${dates.length}, 1fr)`;
        
        dates.forEach(date => {
          const value = filtered.find(r => r.date === date && r.outlet === branch)?.deliverySales || 0;
          const intensity = maxValue > 0 ? value / maxValue : 0;
          const opacity = 0.2 + (intensity * 0.8); // Scale from 0.2 to 1.0
          
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell text-xs p-1 text-center border border-gray-200 dark:border-gray-700';
          cell.style.backgroundColor = `rgba(242, 183, 5, ${opacity})`;
          cell.title = `${branch} - ${date}: ${formatAED(value)}`;
          cell.textContent = value > 0 ? formatNumber(value) : '';
          row.appendChild(cell);
        });
        
        grid.appendChild(row);
      });
      
      container.appendChild(grid);
    }

    // --- DataTable init ---
    function initTable(){
      dataTable = $('#dataTable').DataTable({
        data: salesData,
        columns: [
          { data: 'date', render: d => d ? new Date(d).toLocaleDateString('en-GB') : '' },
          { data: 'outlet' },
          { data: 'count' },
          { data: 'total', render: d => d ? Number(d).toLocaleString('en-AE', { minimumFractionDigits:1 }) + ' AED' : '' },
          { data: 'deliveryOrders' },
          { data: 'deliverySales', render: d => d ? Number(d).toLocaleString('en-AE', { minimumFractionDigits:1 }) + ' AED' : '' },
          { data: null, orderable:false, render: (data, type, row, meta) => `<div class="flex gap-2"><button onclick="editRow(${meta.row})" class="px-2 py-1 bg-yellow-400 rounded text-sm">Edit</button><button onclick="deleteRow(${meta.row})" class="px-2 py-1 bg-red-500 rounded text-sm text-white">Delete</button></div>` }
        ],
        pageLength: 8,
        order: [[0,'desc']],
        responsive: true
      });
    }

    // --- Table row edit/delete ---
    function editRow(idx){
      const row = salesData[idx];
      const input = prompt('Edit row (Date,Outlet,Orders,Sales,DeliveryOrders,DeliverySales):', `${row.date},${row.outlet},${row.count},${row.total},${row.deliveryOrders},${row.deliverySales}`);
      if (!input) return;
      try {
        const parts = input.split(',');
        if (parts.length < 6) { throw new Error('Incorrect format'); }
        const newRow = {
          date: parts[0].trim(), outlet: parts[1].trim(),
          count: parseInt(parts[2]), total: parseFloat(parts[3]),
          deliveryOrders: parseInt(parts[4]), deliverySales: parseFloat(parts[5])
        };
        
        if (!validateRow(newRow)) {
          throw new Error('Invalid data format');
        }
        
        salesData[idx] = newRow;
        persistAndRefresh();
        showNotification('Row updated successfully', 'success');
      } catch(e){
        showNotification(`Error: ${e.message}`, 'error');
      }
    }
    function deleteRow(idx){
      if (!confirm('Delete this row?')) return;
      salesData.splice(idx,1);
      persistAndRefresh();
      showNotification('Row deleted successfully', 'success');
    }

    // --- Persist & refresh UI ---
    function persistAndRefresh(){
      try {
        localStorage.setItem('salesData', JSON.stringify(salesData));
        
        if (dataTable) {
          dataTable.clear().rows.add(salesData).draw();
        } else {
          console.error('DataTable not initialized');
        }
        
        const month = document.getElementById('monthFilterTop').value;
        const selectedBranches = Array.from(document.getElementById('branchFilter').selectedOptions).map(opt => opt.value);
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        renderBranchCards(month, selectedBranches);
        updateCharts(month, selectedBranches, startDate, endDate);
        lastUpdatedText();
      } catch (e) {
        showNotification(`Error refreshing data: ${e.message}`, 'error');
      }
    }

    // --- Quick input update ---
    document.getElementById('btnUpdate').addEventListener('click', () => {
      const raw = document.getElementById('dataInput').value.trim();
      if (!raw) { 
        showNotification('Add rows first', 'error'); 
        return; 
      }
      
      try {
        const rows = raw.split('\n').map(r => r.trim()).filter(Boolean);
        const newSalesData = [];
        let hasError = false;
        
        for (const row of rows) {
          const parts = row.split(',');
          if (parts.length < 6) {
            showNotification(`Row has insufficient columns: ${row}`, 'error');
            hasError = true;
            continue;
          }
          
          const newRow = {
            date: parts[0].trim(),
            outlet: parts[1].trim(),
            count: parseInt(parts[2]) || 0,
            total: parseFloat(parts[3]) || 0,
            deliveryOrders: parseInt(parts[4]) || 0,
            deliverySales: parseFloat(parts[5]) || 0
          };
          
          if (!validateRow(newRow)) {
            showNotification(`Invalid row data: ${row}`, 'error');
            hasError = true;
            continue;
          }
          
          newSalesData.push(newRow);
        }
        
        if (hasError) {
          showNotification('Some rows had errors and were not added', 'error');
          return;
        }
        
        // Add new data to existing data
        salesData = salesData.concat(newSalesData);
        document.getElementById('dataInput').value = '';
        persistAndRefresh();
        showNotification('Data added successfully', 'success');
      } catch (e) {
        showNotification(`Error: ${e.message}`, 'error');
      }
    });
    
    document.getElementById('btnClearInput').addEventListener('click', () => {
      document.getElementById('dataInput').value = '';
      showNotification('Input cleared', 'info');
    });

    // month filter top
    document.getElementById('monthFilterTop').addEventListener('change', (e) => {
      const m = e.target.value;
      const selectedBranches = Array.from(document.getElementById('branchFilter').selectedOptions).map(opt => opt.value);
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      renderBranchCards(m, selectedBranches);
      updateCharts(m, selectedBranches, startDate, endDate);
      
      // also filter datatable via custom search if needed
      $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
        const rowDate = salesData[dataIndex].date;
        return m === 'all' || (rowDate && rowDate.startsWith(m));
      });
      dataTable.draw();
    });

    // Export functions
    document.getElementById('btnExportCSV').addEventListener('click', () => {
      showLoading();
      try {
        const header = ['Date,Outlet,Orders,Sales,DeliveryOrders,DeliverySales'];
        const rows = salesData.map(r => `${r.date},${r.outlet},${r.count},${r.total},${r.deliveryOrders},${r.deliverySales}`);
        const csv = header.concat(rows).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'crispy_sales_export.csv'; a.click(); URL.revokeObjectURL(url);
        showNotification('CSV exported successfully', 'success');
      } catch(e) {
        showNotification(`Error exporting CSV: ${e.message}`, 'error');
      } finally {
        hideLoading();
      }
    });

    document.getElementById('btnExportPDF').addEventListener('click', () => {
      showLoading();
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(20);
        doc.text('Crispy Chicken Sales Report', 14, 15);
        
        // Add date
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleString('en-GB')}`, 14, 25);
        
        // Add table headers
        let y = 35;
        doc.setFontSize(10);
        doc.text('Date', 14, y);
        doc.text('Outlet', 40, y);
        doc.text('Orders', 70, y);
        doc.text('Sales', 100, y);
        doc.text('Del Orders', 130, y);
        doc.text('Del Sales', 160, y);
        
        // Add data rows
        y += 10;
        salesData.forEach(row => {
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          
          doc.text(row.date, 14, y);
          doc.text(row.outlet, 40, y);
          doc.text(row.count.toString(), 70, y);
          doc.text(row.total.toFixed(2), 100, y);
          doc.text(row.deliveryOrders.toString(), 130, y);
          doc.text(row.deliverySales.toFixed(2), 160, y);
          y += 7;
        });
        
        doc.save('crispy_sales_report.pdf');
        showNotification('PDF exported successfully', 'success');
      } catch(e) {
        showNotification(`Error exporting PDF: ${e.message}`, 'error');
      } finally {
        hideLoading();
      }
    });

    document.getElementById('btnExportExcel').addEventListener('click', () => {
      showLoading();
      try {
        const XLSX = window.XLSX;
        const ws = XLSX.utils.json_to_sheet(salesData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sales Data');
        XLSX.writeFile(wb, 'crispy_sales_report.xlsx');
        showNotification('Excel exported successfully', 'success');
      } catch(e) {
        showNotification(`Error exporting Excel: ${e.message}`, 'error');
      } finally {
        hideLoading();
      }
    });

    // Reset to initial (clears localStorage)
    document.getElementById('btnReset').addEventListener('click', () => {
      if (!confirm('Reset data to sample dataset? This will clear local edits.')) return;
      localStorage.removeItem('salesData');
      location.reload();
    });

    // Apply chart filters
    document.getElementById('applyFilters').addEventListener('click', () => {
      const month = document.getElementById('monthFilterTop').value;
      const selectedBranches = Array.from(document.getElementById('branchFilter').selectedOptions).map(opt => opt.value);
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      renderBranchCards(month, selectedBranches);
      updateCharts(month, selectedBranches, startDate, endDate);
      showNotification('Filters applied', 'success');
    });

    // Dark mode toggle
    document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

    // On first load
    document.addEventListener('DOMContentLoaded', () => {
      // Check for saved dark mode preference
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
      }
      
      try {
        initTable();
        
        if (!dataTable) {
          console.error('Failed to initialize DataTable');
          showNotification('Error initializing data table', 'error');
          return;
        }
        
        const month = document.getElementById('monthFilterTop').value;
        const selectedBranches = Array.from(document.getElementById('branchFilter').selectedOptions).map(opt => opt.value);
        renderBranchCards(month, selectedBranches);
        updateCharts(month, selectedBranches);
        lastUpdatedText();
      } catch (e) {
        console.error('Error during initialization:', e);
        showNotification('Error initializing dashboard', 'error');
      }
    });

    // small helper for global functions used in DataTable (edit/delete)
    window.editRow = editRow;
    window.deleteRow = deleteRow;
    window.toggleBranch = toggleBranch;
  </script>
</body>
</html>
