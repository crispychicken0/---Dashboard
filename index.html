<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù… - Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Tahoma, sans-serif; margin: 20px; background: #f5f6fa; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
    .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
    .section { margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 8px; }
    .section-title { font-size: 1.2em; color: #34495e; margin-bottom: 15px; }
    .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .card { background: #ffffff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .card span { font-size: 1.5em; color: #e74c3c; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #ecf0f1; color: #2c3e50; }
    canvas { margin: 30px auto; max-width: 100%; }
    button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; background: #3498db; color: white; font-size: 14px; margin: 5px; }
    button:hover { background: #2980b9; }
    input[type="file"], input[type="date"], input[type="text"], input[type="number"] { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; width: 200px; }
    .error { color: #e74c3c; margin: 10px 0; }
    .manual-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; padding: 15px; background: #f9f9f9; border-radius: 8px; }
    .tooltip { position: relative; display: inline-block; }
    .tooltip .tooltiptext { visibility: hidden; width: 120px; background: #2c3e50; color: white; text-align: center; border-radius: 5px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; right: 50%; transform: translateX(50%); }
    .tooltip:hover .tooltiptext { visibility: visible; }
    @media (max-width: 600px) {
      input[type="file"], input[type="date"], input[type="text"], input[type="number"] { width: 100%; }
      .manual-input { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù… - Dashboard</h1>
  <div class="container">
    <div class="section">
      <div class="section-title">ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
      <div class="tooltip">
        <label for="ordersFile">Ù…Ù„Ù Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Orders):</label>
        <span class="tooltiptext">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±</span>
      </div>
      <input type="file" id="ordersFile" accept=".xlsx,.xls,.csv">
      
      <div class="tooltip">
        <label for="payoutsFile">Ù…Ù„Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª (Payouts):</label>
        <span class="tooltiptext">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª</span>
      </div>
      <input type="file" id="payoutsFile" accept=".xlsx,.xls,.csv">
      
      <div class="tooltip">
        <label for="refundsFile">Ù…Ù„Ù Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª (Refunds/Adjustments):</label>
        <span class="tooltiptext">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª</span>
      </div>
      <input type="file" id="refundsFile" accept=".xlsx,.xls,.csv">
      
      <div id="errorMessage" class="error"></div>
    </div>

    <div class="section manual-input">
      <div class="section-title">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…Ø·Ø§Ø¹Ù…</div>
      <div class="tooltip">
        <label for="merchantId">MERCHANT_ID:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø·Ø¹Ù… (Ù…Ø«Ù„ 1050334)</span>
        <input type="text" id="merchantId" placeholder="Ø£Ø¯Ø®Ù„ MERCHANT_ID">
      </div>
      <div class="tooltip">
        <label for="merchantName">MERCHANT_NAME:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… (Ù…Ø«Ù„ Crispy Chicken)</span>
        <input type="text" id="merchantName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…">
      </div>
      <div class="tooltip">
        <label for="merchantArea">MERCHANT_AREA:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø«Ù„ Al Danah)</span>
        <input type="text" id="merchantArea" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
      </div>
      <div class="tooltip">
        <label for="orderCountInput">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø·Ø¹Ù…</span>
        <input type="number" id="orderCountInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±">
      </div>
      <div class="tooltip">
        <label for="revenueInput">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø±Ù‡Ù…):</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¨Ø§Ù„Ø¯Ø±Ù‡Ù…</span>
        <input type="number" id="revenueInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª">
      </div>
      <button onclick="addManualMerchant()">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ù…Ø·Ø¹Ù…</button>
    </div>

    <div class="section">
      <div class="section-title">ğŸ” ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©</div>
      <input type="date" id="startDate" value="2025-09-01">
      <span>Ø¥Ù„Ù‰</span>
      <input type="date" id="endDate" value="2025-09-07">
      <button onclick="applyDateFilter()">ØªØµÙÙŠØ©</button>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“ˆ Ù…Ù„Ø®Øµ Ø§Ù„ÙØªØ±Ø© (1-7 Ø³Ø¨ØªÙ…Ø¨Ø± 2025)</div>
      <div class="summary">
        <div class="card">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±<br><span id="orderCount">0</span></div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª<br><span id="totalSales">0</span> AED</div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª<br><span id="totalDiscount">0</span> AED</div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª<br><span id="totalCommission">0</span> AED</div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª<br><span id="totalRefund">0</span> AED</div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª<br><span id="totalPayouts">0</span> AED</div>
        <div class="card">ğŸ’° ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­<br><span id="netProfit">0</span> AED</div>
        <div class="card">ğŸ“ˆ Ù†Ø³Ø¨Ø© ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­<br><span id="netProfitRate">0</span>%</div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</div>
      <input type="text" id="merchantsSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('merchantsTable', this.value)">
      <table id="merchantsTable">
        <thead>
          <tr>
            <th>MERCHANT_ID</th>
            <th>MERCHANT_NAME</th>
            <th>MERCHANT_AREA</th>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</th>
            <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø±Ù‡Ù…)</th>
            <th>Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª (Ø¯Ø±Ù‡Ù…)</th>
            <th>Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§ÙÙŠØ© (Ø¯Ø±Ù‡Ù…)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“‘ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
      <input type="text" id="orderSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('ordersTable', this.value)">
      <table id="ordersTable">
        <thead>
          <tr>
            <th>REFERENCE_ID</th>
            <th>TRANSACTION_DATE</th>
            <th>MERCHANT_NAME</th>
            <th>FOOD_GROSS_BASKET_AMOUNT</th>
            <th>PARTNER_FUNDED_PROMO_DISCOUNT</th>
            <th>BILLING_PLATFORM_FEE</th>
            <th>TOTAL_PAYOUT_AMOUNT</th>
            <th>STATUS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <div class="section-title">ğŸ’µ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©</div>
      <input type="text" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('payoutsTable', this.value)">
      <table id="payoutsTable">
        <thead>
          <tr>
            <th>Billable ID</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Net Payout Amount</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <div class="section-title">âš ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª / Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª</div>
      <input type="text" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('refundsTable', this.value)">
      <table id="refundsTable">
        <thead>
          <tr>
            <th>REFERENCE_ID</th>
            <th>TRANSACTION_DATE</th>
            <th>DESCRIPTION</th>
            <th>TOTAL_AMOUNT</th>
            <th>CATEGORY</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“Š Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
      <canvas id="chart" height="140"></canvas>
    </div>

    <div style="text-align:center;">
      <button onclick="exportExcel()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>
      <button onclick="exportPDF()">â¬‡ï¸ ØªØµØ¯ÙŠØ± PDF</button>
    </div>
  </div>

  <script>
    let orders = [], payouts = [], refunds = [], merchants = [];
    let filteredOrders = [], filteredPayouts = [], filteredRefunds = [], filteredMerchants = [];
    let chartInstance = null;

    // Predefined data for period (1-7 Sep 2025)
    const predefinedMerchants = [
      { MERCHANT_ID: "1050334", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "Al Barsha 1", orderCount: 161, revenue: 8050, refunds: -250.60, payouts: 15788.37 },
      { MERCHANT_ID: "1057118", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "Al Danah", orderCount: 177, revenue: 8850, refunds: -160.27, payouts: 17291.33 },
      { MERCHANT_ID: "1057120", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "Al Markaziyah", orderCount: 134, revenue: 6700, refunds: -195.25, payouts: 13094.65 },
      { MERCHANT_ID: "1057122", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "Al Rawdah", orderCount: 101, revenue: 5050, refunds: -100.40, payouts: 9844.31 },
      { MERCHANT_ID: "1057123", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "Mohammed Bin Zayed City", orderCount: 126, revenue: 6300, refunds: -1030.22, payouts: 12318.12 },
      { MERCHANT_ID: "1061662", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "Al Satwa", orderCount: 130, revenue: 6500, refunds: -143.97, payouts: 12724.81 },
      { MERCHANT_ID: "1066777", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "Al Danah", orderCount: 173, revenue: 8650, refunds: -879.46, payouts: 16916.51 },
      { MERCHANT_ID: "1072566", MERCHANT_NAME: "Crispy Chicken", MERCHANT_AREA: "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", orderCount: 0, revenue: 0, refunds: 0, payouts: -72.71 }
    ];

    // Initialize with predefined data
    merchants = [...predefinedMerchants];
    filteredMerchants = [...merchants];
    renderAll();

    document.getElementById('ordersFile').addEventListener('change', (e) => handleFile(e, 'orders'));
    document.getElementById('payoutsFile').addEventListener('change', (e) => handleFile(e, 'payouts'));
    document.getElementById('refundsFile').addEventListener('change', (e) => handleFile(e, 'refunds'));

    function handleFile(e, type) {
      const file = e.target.files[0];
      if (!file) {
        document.getElementById('errorMessage').textContent = `ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµØ§Ù„Ø­ Ù„Ù€ ${type} (Excel Ø£Ùˆ CSV ÙÙ‚Ø·).`;
        return;
      }
      if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
        document.getElementById('errorMessage').textContent = `Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù€ ${type}. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel Ø£Ùˆ CSV.`;
        return;
      }
      document.getElementById('errorMessage').textContent = '';
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          if (file.name.endsWith('.csv')) {
            Papa.parse(evt.target.result, {
              header: true,
              skipEmptyLines: true,
              complete: function(results) {
                let sheetData = results.data.map(row => ({
                  ...row,
                  'Start Date': row['Start Date'] ? new Date(row['Start Date']).toISOString().split('T')[0] : '',
                  'End Date': row['End Date'] ? new Date(row['End Date']).toISOString().split('T')[0] : '',
                  'TRANSACTION_DATE': row['TRANSACTION_DATE'] ? new Date(row['TRANSACTION_DATE']).toISOString().split('T')[0] : ''
                }));
                if (type === 'orders') {
                  orders = sheetData;
                  filteredOrders = [...orders];
                } else if (type === 'payouts') {
                  payouts = sheetData;
                  filteredPayouts = [...payouts];
                } else if (type === 'refunds') {
                  refunds = sheetData;
                  filteredRefunds = [...refunds];
                }
                updateMerchants();
                renderAll();
              },
              error: function(err) {
                document.getElementById('errorMessage').textContent = `Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù ${type}: ${err.message}`;
              }
            });
            reader.readAsText(file); // Use readAsText for CSV files
          } else {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array', dateNF: 'yyyy-mm-dd' });
            let sheetData = workbook.SheetNames[0] ? XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' }) : [];
            sheetData = sheetData.map(row => ({
              ...row,
              'TRANSACTION_DATE': row['TRANSACTION_DATE'] ? new Date(row['TRANSACTION_DATE']).toISOString().split('T')[0] : '',
              'Start Date': row['Start Date'] ? new Date(row['Start Date']).toISOString().split('T')[0] : '',
              'End Date': row['End Date'] ? new Date(row['End Date']).toISOString().split('T')[0] : ''
            }));
            if (type === 'orders') {
              orders = sheetData;
              filteredOrders = [...orders];
            } else if (type === 'payouts') {
              payouts = sheetData;
              filteredPayouts = [...payouts];
            } else if (type === 'refunds') {
              refunds = sheetData;
              filteredRefunds = [...refunds];
            }
            updateMerchants();
            renderAll();
          }
        } catch (err) {
          document.getElementById('errorMessage').textContent = `Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù ${type}: ${err.message}`;
        }
      };
      reader.onerror = function() {
        document.getElementById('errorMessage').textContent = `Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ${type}. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ§Ù„Ø­ ÙˆØºÙŠØ± ØªØ§Ù„Ù.`;
      };
      reader.readAsArrayBuffer(file); // Default to readAsArrayBuffer for Excel
      if (file.name.endsWith('.csv')) {
        reader.readAsText(file); // Override to readAsText for CSV
      }
    }

    function addManualMerchant() {
      const merchantId = document.getElementById('merchantId').value;
      const merchantName = document.getElementById('merchantName').value;
      const merchantArea = document.getElementById('merchantArea').value;
      const orderCount = Number(document.getElementById('orderCountInput').value) || 0;
      const revenue = Number(document.getElementById('revenueInput').value) || 0;

      if (!merchantId || !merchantName) {
        document.getElementById('errorMessage').textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ MERCHANT_ID Ùˆ MERCHANT_NAME.';
        return;
      }

      const existingIndex = merchants.findIndex(m => m.MERCHANT_ID === merchantId);
      if (existingIndex >= 0) {
        merchants[existingIndex] = {
          ...merchants[existingIndex],
          MERCHANT_NAME: merchantName,
          MERCHANT_AREA: merchantArea,
          orderCount: orderCount,
          revenue: revenue
        };
      } else {
        merchants.push({
          MERCHANT_ID: merchantId,
          MERCHANT_NAME: merchantName,
          MERCHANT_AREA: merchantArea,
          orderCount: orderCount,
          revenue: revenue,
          refunds: 0,
          payouts: 0
        });
      }

      filteredMerchants = [...merchants];
      renderMerchants();
      calculateSummary();
      renderChart();
      document.getElementById('merchantId').value = '';
      document.getElementById('merchantName').value = '';
      document.getElementById('merchantArea').value = '';
      document.getElementById('orderCountInput').value = '';
      document.getElementById('revenueInput').value = '';
      document.getElementById('errorMessage').textContent = '';
    }

    function updateMerchants() {
      const merchantMap = new Map();

      // Initialize with predefined data
      predefinedMerchants.forEach(m => {
        merchantMap.set(m.MERCHANT_ID, { ...m });
      });

      // Update with orders data (if available)
      orders.forEach(row => {
        if (row.MERCHANT_ID) {
          if (!merchantMap.has(row.MERCHANT_ID)) {
            merchantMap.set(row.MERCHANT_ID, {
              MERCHANT_ID: row.MERCHANT_ID,
              MERCHANT_NAME: row.MERCHANT_NAME || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
              MERCHANT_AREA: row.MERCHANT_AREA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              orderCount: 0,
              revenue: 0,
              refunds: 0,
              payouts: 0
            });
          }
          merchantMap.get(row.MERCHANT_ID).orderCount += 1;
          merchantMap.get(row.MERCHANT_ID).revenue += Number(row.FOOD_GROSS_BASKET_AMOUNT) || 0;
        }
      });

      // Update with refunds data
      refunds.forEach(row => {
        if (row.MERCHANT_ID) {
          if (!merchantMap.has(row.MERCHANT_ID)) {
            merchantMap.set(row.MERCHANT_ID, {
              MERCHANT_ID: row.MERCHANT_ID,
              MERCHANT_NAME: row.MERCHANT_NAME || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
              MERCHANT_AREA: row.MERCHANT_AREA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              orderCount: 0,
              revenue: 0,
              refunds: 0,
              payouts: 0
            });
          }
          merchantMap.get(row.MERCHANT_ID).refunds += Number(row.TOTAL_AMOUNT) || 0;
        }
      });

      // Update with payouts data
      payouts.forEach(row => {
        const merchantId = row['Billable ID'];
        if (merchantId) {
          if (!merchantMap.has(merchantId)) {
            merchantMap.set(merchantId, {
              MERCHANT_ID: merchantId,
              MERCHANT_NAME: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
              MERCHANT_AREA: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              orderCount: 0,
              revenue: 0,
              refunds: 0,
              payouts: 0
            });
          }
          merchantMap.get(merchantId).payouts += Number(row['Net Payout Amount']) || 0;
        }
      });

      merchants = Array.from(merchantMap.values());
      filteredMerchants = [...merchants];
      renderMerchants();
    }

    function renderAll(){
      renderTable();
      renderPayouts();
      renderRefunds();
      renderMerchants();
      calculateSummary();
      renderChart();
    }

    function applyDateFilter(){
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      filteredOrders = orders.filter(row => {
        const d = new Date(row.TRANSACTION_DATE);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredPayouts = payouts.filter(row => {
        const d = new Date(row['Start Date']);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredRefunds = refunds.filter(row => {
        const d = new Date(row.TRANSACTION_DATE);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredMerchants = merchants.filter(m => {
        const hasOrders = filteredOrders.some(o => o.MERCHANT_ID === m.MERCHANT_ID);
        const hasPayouts = filteredPayouts.some(p => p['Billable ID'] === m.MERCHANT_ID);
        const hasRefunds = filteredRefunds.some(r => r.MERCHANT_ID === m.MERCHANT_ID);
        return hasOrders || hasPayouts || hasRefunds || (m.orderCount > 0 || m.revenue > 0 || m.refunds !== 0 || m.payouts !== 0);
      });
      renderAll();
    }

    function filterTable(tableId, query){
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
      });
    }

    function renderTable(){
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      filteredOrders.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.REFERENCE_ID || ''}</td>
          <td>${row.TRANSACTION_DATE || ''}</td>
          <td>${row.MERCHANT_NAME || ''}</td>
          <td>${Number(row.FOOD_GROSS_BASKET_AMOUNT || 0).toFixed(2)}</td>
          <td>${Number(row.PARTNER_FUNDED_PROMO_DISCOUNT || 0).toFixed(2)}</td>
          <td>${Number(row.BILLING_PLATFORM_FEE || 0).toFixed(2)}</td>
          <td>${Number(row.TOTAL_PAYOUT_AMOUNT || 0).toFixed(2)}</td>
          <td>${row.STATUS || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderPayouts(){
      const tbody = document.querySelector('#payoutsTable tbody');
      tbody.innerHTML = '';
      filteredPayouts.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row['Billable ID'] || ''}</td>
          <td>${row['Start Date'] || ''}</td>
          <td>${row['End Date'] || ''}</td>
          <td>${Number(row['Net Payout Amount'] || 0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderRefunds(){
      const tbody = document.querySelector('#refundsTable tbody');
      tbody.innerHTML = '';
      filteredRefunds.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.REFERENCE_ID || ''}</td>
          <td>${row.TRANSACTION_DATE || ''}</td>
          <td>${row.DESCRIPTION || ''}</td>
          <td>${Number(row.TOTAL_AMOUNT || 0).toFixed(2)}</td>
          <td>${row.CATEGORY || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderMerchants(){
      const tbody = document.querySelector('#merchantsTable tbody');
      tbody.innerHTML = '';
      filteredMerchants.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.MERCHANT_ID || ''}</td>
          <td>${row.MERCHANT_NAME || ''}</td>
          <td>${row.MERCHANT_AREA || ''}</td>
          <td>${row.orderCount || 0}</td>
          <td>${Number(row.revenue || 0).toFixed(2)}</td>
          <td>${Number(row.refunds || 0).toFixed(2)}</td>
          <td>${Number(row.payouts || 0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function calculateSummary(){
      let totalSales = 0, totalDiscount = 0, totalCommission = 0, totalRefund = 0, totalPayouts = 0, totalOrders = 0;

      filteredOrders.forEach(row => {
        totalSales += Number(row.FOOD_GROSS_BASKET_AMOUNT) || 0;
        totalDiscount += Math.abs(Number(row.PARTNER_FUNDED_PROMO_DISCOUNT) || 0);
        totalCommission += Math.abs(Number(row.BILLING_PLATFORM_FEE) || 0) + 
                           Math.abs(Number(row.BILLING_PLATFORM_FEE_TAX) || 0) + 
                           Math.abs(Number(row.BILLING_PAYMENT_GATEWAY_FEE) || 0) + 
                           Math.abs(Number(row.BILLING_PAYMENT_GATEWAY_FEE_TAX) || 0);
        totalOrders += 1;
      });

      filteredPayouts.forEach(row => totalPayouts += Number(row['Net Payout Amount']) || 0);
      filteredRefunds.forEach(row => totalRefund += Math.abs(Number(row.TOTAL_AMOUNT) || 0));

      // Use predefined data if no orders file is uploaded
      if (filteredOrders.length === 0) {
        totalOrders = filteredMerchants.reduce((sum, m) => sum + (m.orderCount || 0), 0);
        totalSales = filteredMerchants.reduce((sum, m) => sum + (m.revenue || 0), 0);
        totalDiscount = totalSales * 0.1; // Assume 10% discounts
        totalCommission = totalSales * 0.15; // Assume 15% commissions
      }

      const netProfit = totalSales - totalDiscount - totalCommission - totalRefund;
      const netProfitRate = totalSales ? ((netProfit / totalSales) * 100).toFixed(2) : 0;

      document.getElementById('orderCount').textContent = totalOrders;
      document.getElementById('totalSales').textContent = totalSales.toFixed(2);
      document.getElementById('totalDiscount').textContent = totalDiscount.toFixed(2);
      document.getElementById('totalCommission').textContent = totalCommission.toFixed(2);
      document.getElementById('totalRefund').textContent = totalRefund.toFixed(2);
      document.getElementById('totalPayouts').textContent = totalPayouts.toFixed(2);
      document.getElementById('netProfit').textContent = netProfit.toFixed(2);
      document.getElementById('netProfitRate').textContent = netProfitRate;
    }

    function renderChart(){
      const ctx = document.getElementById('chart').getContext('2d');
      if (chartInstance) {
        chartInstance.destroy();
      }
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª', 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª', 'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª', 'Ø§Ù„Ø¯ÙØ¹Ø§Øª', 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­'],
          datasets: [{
            label: 'AED',
            data: [
              parseFloat(document.getElementById('totalSales').textContent) || 0,
              parseFloat(document.getElementById('totalDiscount').textContent) || 0,
              parseFloat(document.getElementById('totalCommission').textContent) || 0,
              parseFloat(document.getElementById('totalRefund').textContent) || 0,
              parseFloat(document.getElementById('totalPayouts').textContent) || 0,
              parseFloat(document.getElementById('netProfit').textContent) || 0
            ],
            backgroundColor: ['#27ae60', '#e67e22', '#c0392b', '#8e44ad', '#16a085', '#2980b9']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function exportExcel(){
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(filteredOrders);
      const ws2 = XLSX.utils.json_to_sheet(filteredPayouts);
      const ws3 = XLSX.utils.json_to_sheet(filteredRefunds);
      const ws4 = XLSX.utils.json_to_sheet(filteredMerchants);
      XLSX.utils.book_append_sheet(wb, ws1, 'Orders');
      XLSX.utils.book_append_sheet(wb, ws2, 'Payouts');
      XLSX.utils.book_append_sheet(wb, ws3, 'Refunds');
      XLSX.utils.book_append_sheet(wb, ws4, 'Merchants');
      XLSX.writeFile(wb, 'restaurant_report.xlsx');
    }

    function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù… (1-7 Ø³Ø¨ØªÙ…Ø¨Ø± 2025)", 10, 15);
      doc.text("Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±: " + document.getElementById('orderCount').textContent, 10, 30);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: " + document.getElementById('totalSales').textContent + " AED", 10, 40);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: " + document.getElementById('totalDiscount').textContent + " AED", 10, 50);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª: " + document.getElementById('totalCommission').textContent + " AED", 10, 60);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª: " + document.getElementById('totalRefund').textContent + " AED", 10, 70);
      doc.text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª: " + document.getElementById('totalPayouts').textContent + " AED", 10, 80);
      doc.text("ğŸ’° ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: " + document.getElementById('netProfit').textContent + " AED", 10, 90);
      doc.text("ğŸ“ˆ Ù†Ø³Ø¨Ø© ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: " + document.getElementById('netProfitRate').textContent + "%", 10, 100);
      doc.save('restaurant_report.pdf');
    }
  </script>
</body>
</html>
