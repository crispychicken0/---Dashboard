<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù… - ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Tahoma, sans-serif; margin: 20px; background: #f5f6fa; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
    .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
    .section { margin-bottom: 30px; padding: 15px; background: #fafafa; border-radius: 8px; }
    .section-title { font-size: 1.2em; color: #34495e; margin-bottom: 15px; }
    .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .card { background: #ffffff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .card span { font-size: 1.5em; }
    .card.negative span { color: #e74c3c; }
    .card.positive span { color: #27ae60; }
    .alert { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .alert ul { margin: 5px 0; padding-right: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #ecf0f1; color: #2c3e50; }
    .highlight { background: #fff3cd; }
    .delete-btn { background: #e74c3c; padding: 5px 10px; font-size: 12px; }
    .delete-btn:hover { background: #c0392b; }
    canvas { margin: 30px auto; max-width: 100%; }
    button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; background: #3498db; color: white; font-size: 14px; margin: 5px; }
    button:hover { background: #2980b9; }
    input[type="file"], input[type="date"], input[type="text"], input[type="number"] { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; width: 200px; }
    .error { color: #e74c3c; margin: 10px 0; }
    .manual-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; padding: 15px; background: #f9f9f9; border-radius: 8px; }
    .tooltip { position: relative; display: inline-block; }
    .tooltip .tooltiptext { visibility: hidden; width: 140px; background: #2c3e50; color: white; text-align: center; border-radius: 5px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; right: 50%; transform: translateX(50%); }
    .tooltip:hover .tooltiptext { visibility: visible; }
    @media (max-width: 600px) {
      input[type="file"], input[type="date"], input[type="text"], input[type="number"] { width: 100%; }
      .manual-input { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¹Ù… - ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹</h1>
  <div class="container">
    <div class="section">
      <div class="section-title">ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</div>
      <div class="tooltip">
        <label for="ordersFile">Ù…Ù„Ù Ø§Ù„Ø£ÙˆØ§Ù…Ø±:</label>
        <span class="tooltiptext">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø± (ÙŠØªØ·Ù„Ø¨ Ø£Ø¹Ù…Ø¯Ø©: MERCHANT_ID, MERCHANT_NAME, MERCHANT_AREA, FOOD_GROSS_BASKET_AMOUNT)</span>
      </div>
      <input type="file" id="ordersFile" accept=".xlsx,.xls,.csv">
      
      <div class="tooltip">
        <label for="payoutsFile">Ù…Ù„Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª:</label>
        <span class="tooltiptext">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª (ÙŠØªØ·Ù„Ø¨ Ø£Ø¹Ù…Ø¯Ø©: Billable ID, Net Payout Amount)</span>
      </div>
      <input type="file" id="payoutsFile" accept=".xlsx,.xls,.csv">
      
      <div class="tooltip">
        <label for="refundsFile">Ù…Ù„Ù Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª:</label>
        <span class="tooltiptext">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª (ÙŠØªØ·Ù„Ø¨ Ø£Ø¹Ù…Ø¯Ø©: MERCHANT_ID, TOTAL_AMOUNT)</span>
      </div>
      <input type="file" id="refundsFile" accept=".xlsx,.xls,.csv">
      
      <div id="errorMessage" class="error"></div>
      <button onclick="resetData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <div class="section manual-input">
      <div class="section-title">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ Ù„ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯</div>
      <div class="tooltip">
        <label for="merchantId">MERCHANT_ID:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø·Ø¹Ù… (Ù…Ø«Ù„ 1050334)</span>
        <input type="text" id="merchantId" placeholder="Ø£Ø¯Ø®Ù„ MERCHANT_ID">
      </div>
      <div class="tooltip">
        <label for="merchantName">MERCHANT_NAME:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… (Ù…Ø«Ù„ Crispy Chicken)</span>
        <input type="text" id="merchantName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…">
      </div>
      <div class="tooltip">
        <label for="merchantArea">MERCHANT_AREA:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø«Ù„ BARSHA)</span>
        <input type="text" id="merchantArea" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
      </div>
      <div class="tooltip">
        <label for="orderCountInput">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ø±Ù‚Ù… ØµØ­ÙŠØ­ ØºÙŠØ± Ø³Ø§Ù„Ø¨)</span>
        <input type="number" id="orderCountInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±" min="0">
      </div>
      <div class="tooltip">
        <label for="revenueInput">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø±Ù‡Ù…):</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¨Ø§Ù„Ø¯Ø±Ù‡Ù… (Ø±Ù‚Ù… ØºÙŠØ± Ø³Ø§Ù„Ø¨)</span>
        <input type="number" id="revenueInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª" min="0" step="any">
      </div>
      <div class="tooltip">
        <label for="refundsInput">Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª (Ø¯Ø±Ù‡Ù…):</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª Ø¨Ø§Ù„Ø¯Ø±Ù‡Ù… (Ù‚ÙŠÙ…Ø© Ø³Ø§Ù„Ø¨Ø© Ø£Ùˆ ØµÙØ±)</span>
        <input type="number" id="refundsInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª" step="any">
      </div>
      <div class="tooltip">
        <label for="payoutsInput">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§ÙÙŠØ© (Ø¯Ø±Ù‡Ù…):</label>
        <span class="tooltiptext">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§ÙÙŠØ© Ø¨Ø§Ù„Ø¯Ø±Ù‡Ù…</span>
        <input type="number" id="payoutsInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª" step="any">
      </div>
      <button onclick="addManualMerchant()">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« ÙØ±Ø¹</button>
    </div>

    <div class="section">
      <div class="section-title">ğŸ” ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©</div>
      <input type="date" id="startDate" value="2025-09-01">
      <span>Ø¥Ù„Ù‰</span>
      <input type="date" id="endDate" value="2025-09-07">
      <button onclick="applyDateFilter()">ØªØµÙÙŠØ©</button>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“ˆ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
      <div class="summary">
        <div class="card">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±<br><span id="orderCount">0</span></div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª<br><span id="totalSales">0</span> AED</div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª<br><span id="totalDiscount">0</span> AED</div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª<br><span id="totalCommission">0</span> AED</div>
        <div class="card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª<br><span id="totalRefund">0</span> AED</div>
        <div class="card" id="payoutsCard">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª<br><span id="totalPayouts">0</span> AED</div>
        <div class="card">ğŸ’° ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­<br><span id="netProfit">0</span> AED</div>
        <div class="card">ğŸ“ˆ Ù†Ø³Ø¨Ø© ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­<br><span id="netProfitRate">0</span>%</div>
      </div>
      <div id="alerts" class="alert"></div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹</div>
      <input type="text" id="merchantsSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('merchantsTable', this.value)">
      <table id="merchantsTable">
        <thead>
          <tr>
            <th>MERCHANT_ID</th>
            <th>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th>
            <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</th>
            <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø±Ù‡Ù…)</th>
            <th>Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª (Ø¯Ø±Ù‡Ù…)</th>
            <th>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª</th>
            <th>Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§ÙÙŠØ© (Ø¯Ø±Ù‡Ù…)</th>
            <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¯Ø±Ù‡Ù…)</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
      <input type="text" id="payoutsSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterTable('payoutsTable', this.value)">
      <table id="payoutsTable">
        <thead>
          <tr>
            <th>Billable ID</th>
            <th>Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„ØµØ§ÙÙŠØ© (Ø¯Ø±Ù‡Ù…)</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“Š Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
      <canvas id="summaryChart" height="140"></canvas>
    </div>

    <div class="section">
      <div class="section-title">ğŸ“Š Ù…Ø®Ø·Ø· Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙØ±ÙˆØ¹</div>
      <canvas id="branchesChart" height="140"></canvas>
    </div>

    <div style="text-align:center;">
      <button onclick="exportExcel()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>
      <button onclick="exportPDF()">â¬‡ï¸ ØªØµØ¯ÙŠØ± PDF</button>
    </div>
  </div>

  <script>
    let orders = [], payouts = [], refunds = [], merchants = [];
    let filteredOrders = [], filteredPayouts = [], filteredRefunds = [], filteredMerchants = [];
    let summaryChartInstance = null, branchesChartInstance = null;
    const DISCOUNT_RATE = 0.1; // 10% discount rate
    const COMMISSION_RATE = 0.15; // 15% commission rate

    // Predefined payouts data
    const predefinedPayouts = [
      { 'Billable ID': '1050334', 'Net Payout Amount': 15788.37, 'Start Date': '2025-09-01', 'End Date': '2025-09-07' },
      { 'Billable ID': '1057118', 'Net Payout Amount': 17291.33, 'Start Date': '2025-09-01', 'End Date': '2025-09-07' },
      { 'Billable ID': '1057120', 'Net Payout Amount': 13094.65, 'Start Date': '2025-09-01', 'End Date': '2025-09-07' },
      { 'Billable ID': '1057122', 'Net Payout Amount': 9844.31, 'Start Date': '2025-09-01', 'End Date': '2025-09-07' },
      { 'Billable ID': '1057123', 'Net Payout Amount': 12318.12, 'Start Date': '2025-09-01', 'End Date': '2025-09-07' },
      { 'Billable ID': '1061662', 'Net Payout Amount': 12724.81, 'Start Date': '2025-09-01', 'End Date': '2025-09-07' },
      { 'Billable ID': '1066777', 'Net Payout Amount': 16916.51, 'Start Date': '2025-09-01', 'End Date': '2025-09-07' }
    ];

    // Predefined merchants data
    const predefinedMerchants = [
      { MERCHANT_ID: '1066777', MERCHANT_NAME: 'Crispy Chicken', MERCHANT_AREA: 'Al Danah', orderCount: 653, revenue: 27084.00, refunds: -542.60, payouts: 16916.51 },
      { MERCHANT_ID: '1061662', MERCHANT_NAME: 'Crispy Chicken', MERCHANT_AREA: 'Al Satwa', orderCount: 438, revenue: 18088.00, refunds: -112.00, payouts: 12724.81 },
      { MERCHANT_ID: '1057123', MERCHANT_NAME: 'Crispy Chicken', MERCHANT_AREA: 'Mohammed Bin Zayed City', orderCount: 442, revenue: 18218.00, refunds: -219.00, payouts: 12318.12 },
      { MERCHANT_ID: '1057118', MERCHANT_NAME: 'Crispy Chicken', MERCHANT_AREA: 'Al Danah', orderCount: 592, revenue: 24992.00, refunds: -330.07, payouts: 17291.33 },
      { MERCHANT_ID: '1057122', MERCHANT_NAME: 'Crispy Chicken', MERCHANT_AREA: 'Al Rawdah', orderCount: 334, revenue: 13998.00, refunds: -67.00, payouts: 9844.31 },
      { MERCHANT_ID: '1057120', MERCHANT_NAME: 'Crispy Chicken', MERCHANT_AREA: 'Al Markaziyah', orderCount: 440, revenue: 19281.00, refunds: -315.80, payouts: 13094.65 },
      { MERCHANT_ID: '1050334', MERCHANT_NAME: 'Crispy Chicken', MERCHANT_AREA: 'Al Barsha 1', orderCount: 542, revenue: 22928.00, refunds: -453.70, payouts: 15788.37 }
    ];

    // Initialize with predefined data
    merchants = [...predefinedMerchants];
    payouts = [...predefinedPayouts];
    filteredMerchants = [...merchants];
    filteredPayouts = [...payouts];
    renderAll();

    document.getElementById('ordersFile').addEventListener('change', (e) => handleFile(e, 'orders'));
    document.getElementById('payoutsFile').addEventListener('change', (e) => handleFile(e, 'payouts'));
    document.getElementById('refundsFile').addEventListener('change', (e) => handleFile(e, 'refunds'));

    function handleFile(e, type) {
      const file = e.target.files[0];
      if (!file) {
        document.getElementById('errorMessage').textContent = `ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµØ§Ù„Ø­ Ù„Ù€ ${type} (Excel Ø£Ùˆ CSV ÙÙ‚Ø·).`;
        return;
      }
      if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
        document.getElementById('errorMessage').textContent = `Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù€ ${type}. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel Ø£Ùˆ CSV.`;
        return;
      }
      document.getElementById('errorMessage').textContent = '';
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          if (file.name.endsWith('.csv')) {
            Papa.parse(evt.target.result, {
              header: true,
              skipEmptyLines: true,
              complete: function(results) {
                const normalizedData = normalizeColumnNames(results.data);
                if (type === 'orders') {
                  const requiredColumns = ['MERCHANT_ID', 'FOOD_GROSS_BASKET_AMOUNT'];
                  if (!requiredColumns.every(col => normalizedData[0] && normalizedData[0].hasOwnProperty(col))) {
                    document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙŠÙØªÙ‚Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©: ${requiredColumns.join(', ')}`;
                    return;
                  }
                  const merchantIds = normalizedData.map(row => row.MERCHANT_ID).filter(id => id);
                  const uniqueIds = new Set(merchantIds);
                  if (uniqueIds.size < merchantIds.length) {
                    document.getElementById('errorMessage').textContent = `ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªÙƒØ±Ø§Ø± ÙÙŠ MERCHANT_ID ÙÙŠ Ù…Ù„Ù ${type}. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`;
                  }
                } else if (type === 'payouts') {
                  const requiredColumns = ['Billable ID', 'Net Payout Amount'];
                  if (!requiredColumns.every(col => normalizedData[0] && normalizedData[0].hasOwnProperty(col))) {
                    document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙŠÙØªÙ‚Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©: ${requiredColumns.join(', ')}`;
                    return;
                  }
                  const invalidPayouts = normalizedData.filter(row => isNaN(Number(row['Net Payout Amount'])));
                  if (invalidPayouts.length > 0) {
                    document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© ÙÙŠ Net Payout Amount.`;
                    return;
                  }
                } else if (type === 'refunds') {
                  const requiredColumns = ['MERCHANT_ID', 'TOTAL_AMOUNT'];
                  if (!requiredColumns.every(col => normalizedData[0] && normalizedData[0].hasOwnProperty(col))) {
                    document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª ÙŠÙØªÙ‚Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©: ${requiredColumns.join(', ')}`;
                    return;
                  }
                }
                let sheetData = normalizedData.map(row => ({
                  ...row,
                  'Start Date': row['Start Date'] ? new Date(row['Start Date']).toISOString().split('T')[0] : '',
                  'End Date': row['End Date'] ? new Date(row['End Date']).toISOString().split('T')[0] : '',
                  'TRANSACTION_DATE': row['TRANSACTION_DATE'] ? new Date(row['TRANSACTION_DATE']).toISOString().split('T')[0] : ''
                }));
                if (type === 'orders') {
                  orders = sheetData;
                  filteredOrders = [...orders];
                } else if (type === 'payouts') {
                  payouts = sheetData;
                  filteredPayouts = [...payouts];
                } else if (type === 'refunds') {
                  refunds = sheetData;
                  filteredRefunds = [...refunds];
                }
                updateMerchants();
                renderAll();
              },
              error: function(err) {
                document.getElementById('errorMessage').textContent = `Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù ${type}: ${err.message}. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©.`;
              }
            });
            reader.readAsText(file);
          } else {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array', dateNF: 'yyyy-mm-dd' });
            let sheetData = workbook.SheetNames[0] ? XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' }) : [];
            const normalizedData = normalizeColumnNames(sheetData);
            if (type === 'orders') {
              const requiredColumns = ['MERCHANT_ID', 'FOOD_GROSS_BASKET_AMOUNT'];
              if (!requiredColumns.every(col => normalizedData[0] && normalizedData[0].hasOwnProperty(col))) {
                document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙŠÙØªÙ‚Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©: ${requiredColumns.join(', ')}`;
                return;
              }
              const merchantIds = normalizedData.map(row => row.MERCHANT_ID).filter(id => id);
              const uniqueIds = new Set(merchantIds);
              if (uniqueIds.size < merchantIds.length) {
                document.getElementById('errorMessage').textContent = `ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªÙƒØ±Ø§Ø± ÙÙŠ MERCHANT_ID ÙÙŠ Ù…Ù„Ù ${type}. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`;
              }
            } else if (type === 'payouts') {
              const requiredColumns = ['Billable ID', 'Net Payout Amount'];
              if (!requiredColumns.every(col => normalizedData[0] && normalizedData[0].hasOwnProperty(col))) {
                document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙŠÙØªÙ‚Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©: ${requiredColumns.join(', ')}`;
                return;
              }
              const invalidPayouts = normalizedData.filter(row => isNaN(Number(row['Net Payout Amount'])));
              if (invalidPayouts.length > 0) {
                document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© ÙÙŠ Net Payout Amount.`;
                return;
              }
            } else if (type === 'refunds') {
              const requiredColumns = ['MERCHANT_ID', 'TOTAL_AMOUNT'];
              if (!requiredColumns.every(col => normalizedData[0] && normalizedData[0].hasOwnProperty(col))) {
                document.getElementById('errorMessage').textContent = `Ù…Ù„Ù Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª ÙŠÙØªÙ‚Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©: ${requiredColumns.join(', ')}`;
                return;
              }
            }
            sheetData = normalizedData.map(row => ({
              ...row,
              'TRANSACTION_DATE': row['TRANSACTION_DATE'] ? new Date(row['TRANSACTION_DATE']).toISOString().split('T')[0] : '',
              'Start Date': row['Start Date'] ? new Date(row['Start Date']).toISOString().split('T')[0] : '',
              'End Date': row['End Date'] ? new Date(row['End Date']).toISOString().split('T')[0] : ''
            }));
            if (type === 'orders') {
              orders = sheetData;
              filteredOrders = [...orders];
            } else if (type === 'payouts') {
              payouts = sheetData;
              filteredPayouts = [...payouts];
            } else if (type === 'refunds') {
              refunds = sheetData;
              filteredRefunds = [...refunds];
            }
            updateMerchants();
            renderAll();
          }
        } catch (err) {
          document.getElementById('errorMessage').textContent = `Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù ${type}: ${err.message}. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØºÙŠØ± ØªØ§Ù„Ù.`;
        }
      };
      reader.onerror = function() {
        document.getElementById('errorMessage').textContent = `Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ${type}. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ§Ù„Ø­ ÙˆØºÙŠØ± ØªØ§Ù„Ù.`;
      };
      reader.readAsArrayBuffer(file);
      if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
      }
    }

    function normalizeColumnNames(data) {
      return data.map(row => {
        const normalizedRow = {};
        for (const key in row) {
          const normalizedKey = key.trim().replace(/\s+/g, '_').toUpperCase();
          normalizedRow[normalizedKey] = row[key];
        }
        return normalizedRow;
      });
    }

    function addManualMerchant() {
      const merchantId = document.getElementById('merchantId').value.trim();
      const merchantName = document.getElementById('merchantName').value.trim();
      const merchantArea = document.getElementById('merchantArea').value.trim();
      const orderCount = Number(document.getElementById('orderCountInput').value) || 0;
      const revenue = Number(document.getElementById('revenueInput').value) || 0;
      const refunds = Number(document.getElementById('refundsInput').value) || 0;
      const payouts = Number(document.getElementById('payoutsInput').value) || 0;

      if (!merchantId || !merchantName) {
        document.getElementById('errorMessage').textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ MERCHANT_ID Ùˆ MERCHANT_NAME.';
        return;
      }
      if (orderCount < 0) {
        document.getElementById('errorMessage').textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØºÙŠØ± Ø³Ø§Ù„Ø¨.';
        return;
      }
      if (revenue < 0) {
        document.getElementById('errorMessage').textContent = 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØºÙŠØ± Ø³Ø§Ù„Ø¨Ø©.';
        return;
      }
      if (refunds > 0) {
        document.getElementById('errorMessage').textContent = 'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‚ÙŠÙ…Ø© Ø³Ø§Ù„Ø¨Ø© Ø£Ùˆ ØµÙØ±.';
        return;
      }

      const existingIndex = merchants.findIndex(m => m.MERCHANT_ID === merchantId);
      if (existingIndex >= 0) {
        merchants[existingIndex] = {
          ...merchants[existingIndex],
          MERCHANT_NAME: merchantName,
          MERCHANT_AREA: merchantArea,
          orderCount: orderCount,
          revenue: revenue,
          refunds: refunds,
          payouts: payouts
        };
      } else {
        merchants.push({
          MERCHANT_ID: merchantId,
          MERCHANT_NAME: merchantName,
          MERCHANT_AREA: merchantArea,
          orderCount: orderCount,
          revenue: revenue,
          refunds: refunds,
          payouts: payouts
        });
      }

      filteredMerchants = [...merchants];
      renderMerchants();
      calculateSummary();
      renderCharts();
      renderPayoutsTable();
      document.getElementById('merchantId').value = '';
      document.getElementById('merchantName').value = '';
      document.getElementById('merchantArea').value = '';
      document.getElementById('orderCountInput').value = '';
      document.getElementById('revenueInput').value = '';
      document.getElementById('refundsInput').value = '';
      document.getElementById('payoutsInput').value = '';
      document.getElementById('errorMessage').textContent = '';
    }

    function deleteMerchant(merchantId) {
      merchants = merchants.filter(m => m.MERCHANT_ID !== merchantId);
      filteredMerchants = [...merchants];
      renderMerchants();
      calculateSummary();
      renderCharts();
      renderPayoutsTable();
    }

    function resetData() {
      orders = [];
      payouts = [...predefinedPayouts];
      refunds = [];
      merchants = [...predefinedMerchants];
      filteredOrders = [];
      filteredPayouts = [...payouts];
      filteredRefunds = [];
      filteredMerchants = [...merchants];
      document.getElementById('ordersFile').value = '';
      document.getElementById('payoutsFile').value = '';
      document.getElementById('refundsFile').value = '';
      document.getElementById('merchantId').value = '';
      document.getElementById('merchantName').value = '';
      document.getElementById('merchantArea').value = '';
      document.getElementById('orderCountInput').value = '';
      document.getElementById('revenueInput').value = '';
      document.getElementById('refundsInput').value = '';
      document.getElementById('payoutsInput').value = '';
      document.getElementById('errorMessage').textContent = 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.';
      renderAll();
    }

    function updateMerchants() {
      const merchantMap = new Map();

      // Initialize with predefined merchants
      predefinedMerchants.forEach(row => {
        merchantMap.set(row.MERCHANT_ID, {
          MERCHANT_ID: row.MERCHANT_ID,
          MERCHANT_NAME: row.MERCHANT_NAME,
          MERCHANT_AREA: row.MERCHANT_AREA,
          orderCount: row.orderCount || 0,
          revenue: row.revenue || 0,
          refunds: row.refunds || 0,
          payouts: row.payouts || 0
        });
      });

      // Update with orders data (if available)
      orders.forEach(row => {
        if (row.MERCHANT_ID) {
          if (!merchantMap.has(row.MERCHANT_ID)) {
            merchantMap.set(row.MERCHANT_ID, {
              MERCHANT_ID: row.MERCHANT_ID,
              MERCHANT_NAME: row.MERCHANT_NAME || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
              MERCHANT_AREA: row.MERCHANT_AREA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              orderCount: 0,
              revenue: 0,
              refunds: 0,
              payouts: 0
            });
          }
          merchantMap.get(row.MERCHANT_ID).orderCount += 1;
          merchantMap.get(row.MERCHANT_ID).revenue += Number(row.FOOD_GROSS_BASKET_AMOUNT) || 0;
        }
      });

      // Update with refunds data
      refunds.forEach(row => {
        if (row.MERCHANT_ID) {
          if (!merchantMap.has(row.MERCHANT_ID)) {
            merchantMap.set(row.MERCHANT_ID, {
              MERCHANT_ID: row.MERCHANT_ID,
              MERCHANT_NAME: row.MERCHANT_NAME || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
              MERCHANT_AREA: row.MERCHANT_AREA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              orderCount: 0,
              revenue: 0,
              refunds: 0,
              payouts: 0
            });
          }
          merchantMap.get(row.MERCHANT_ID).refunds += Number(row.TOTAL_AMOUNT) || 0;
        }
      });

      // Update with payouts data
      payouts.forEach(row => {
        const merchantId = row['Billable ID'];
        if (merchantId) {
          if (!merchantMap.has(merchantId)) {
            merchantMap.set(merchantId, {
              MERCHANT_ID: merchantId,
              MERCHANT_NAME: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
              MERCHANT_AREA: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              orderCount: 0,
              revenue: 0,
              refunds: 0,
              payouts: 0
            });
          }
          merchantMap.get(merchantId).payouts += Number(row['Net Payout Amount']) || 0;
        }
      });

      merchants = Array.from(merchantMap.values());
      filteredMerchants = [...merchants];
      renderMerchants();
      renderPayoutsTable();
    }

    function renderAll() {
      renderMerchants();
      calculateSummary();
      renderCharts();
      renderPayoutsTable();
    }

    function applyDateFilter() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      if (start && end && new Date(start) > new Date(end)) {
        document.getElementById('errorMessage').textContent = 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.';
        return;
      }
      filteredOrders = orders.filter(row => {
        const d = new Date(row.TRANSACTION_DATE);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredPayouts = payouts.filter(row => {
        const d = new Date(row['Start Date']);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredRefunds = refunds.filter(row => {
        const d = new Date(row.TRANSACTION_DATE);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
      filteredMerchants = merchants.filter(m => {
        const hasOrders = filteredOrders.some(o => o.MERCHANT_ID === m.MERCHANT_ID);
        const hasPayouts = filteredPayouts.some(p => p['Billable ID'] === m.MERCHANT_ID);
        const hasRefunds = filteredRefunds.some(r => r.MERCHANT_ID === m.MERCHANT_ID);
        return hasOrders || hasPayouts || hasRefunds || (m.orderCount > 0 || m.revenue > 0 || m.refunds !== 0 || m.payouts !== 0);
      });
      renderAll();
    }

    function filterTable(tableId, query) {
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
      });
    }

    function renderMerchants() {
      const tbody = document.querySelector('#merchantsTable tbody');
      tbody.innerHTML = ''; // Clear table to prevent duplicates
      filteredMerchants.forEach(row => {
        const discount = row.revenue * DISCOUNT_RATE;
        const commission = row.revenue * COMMISSION_RATE;
        const netProfit = row.revenue - discount - commission - Math.abs(row.refunds);
        const refundRatio = row.revenue ? (Math.abs(row.refunds) / row.revenue * 100).toFixed(2) : 0;
        const isHighRefund = refundRatio > 5;
        const isNegativePayout = row.payouts < 0;
        const tr = document.createElement('tr');
        tr.className = isHighRefund || isNegativePayout ? 'highlight' : '';
        tr.innerHTML = `
          <td>${row.MERCHANT_ID || ''}</td>
          <td>${row.MERCHANT_NAME || ''}</td>
          <td>${row.MERCHANT_AREA || ''}</td>
          <td>${row.orderCount || 0}</td>
          <td>${Number(row.revenue || 0).toFixed(2)}</td>
          <td>${Number(row.refunds || 0).toFixed(2)}</td>
          <td>${refundRatio}%</td>
          <td>${Number(row.payouts || 0).toFixed(2)}</td>
          <td>${netProfit.toFixed(2)}</td>
          <td><button class="delete-btn" onclick="deleteMerchant('${row.MERCHANT_ID}')">Ø­Ø°Ù</button></td>`;
        tbody.appendChild(tr);
      });
      // Display alerts for high refunds or negative payouts
      const alerts = [];
      filteredMerchants.forEach(m => {
        const refundRatio = m.revenue ? (Math.abs(m.refunds) / m.revenue * 100).toFixed(2) : 0;
        if (refundRatio > 5) {
          alerts.push(`Ø§Ù„ÙØ±Ø¹ ${m.MERCHANT_AREA} (${m.MERCHANT_ID}): Ù†Ø³Ø¨Ø© ØªØ¹ÙˆÙŠØ¶Ø§Øª Ø¹Ø§Ù„ÙŠØ© (${refundRatio}%)`);
        }
        if (m.payouts < 0) {
          alerts.push(`Ø§Ù„ÙØ±Ø¹ ${m.MERCHANT_AREA} (${m.MERCHANT_ID}): Ø¯ÙØ¹Ø© ØµØ§ÙÙŠØ© Ø³Ù„Ø¨ÙŠØ© (${m.payouts.toFixed(2)} Ø¯Ø±Ù‡Ù…)`);
        }
      });
      const totalPayouts = parseFloat(document.getElementById('totalPayouts').textContent) || 0;
      if (totalPayouts < 0) {
        alerts.push(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø³Ù„Ø¨ÙŠ (${totalPayouts.toFixed(2)} Ø¯Ø±Ù‡Ù…)`);
      }
      document.getElementById('alerts').innerHTML = alerts.length > 0 ? `<ul>${alerts.map(a => `<li>${a}</li>`).join('')}</ul>` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª.';
    }

    function renderPayoutsTable() {
      const tbody = document.querySelector('#payoutsTable tbody');
      tbody.innerHTML = ''; // Clear table to prevent duplicates
      filteredPayouts.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row['Billable ID'] || ''}</td>
          <td>${Number(row['Net Payout Amount'] || 0).toFixed(2)}</td>
          <td>${row['Start Date'] || ''}</td>
          <td>${row['End Date'] || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function calculateSummary() {
      let totalSales = 0, totalDiscount = 0, totalCommission = 0, totalRefund = 0, totalPayouts = 0, totalOrders = 0;

      filteredOrders.forEach(row => {
        totalSales += Number(row.FOOD_GROSS_BASKET_AMOUNT) || 0;
        totalDiscount += Math.abs(Number(row.PARTNER_FUNDED_PROMO_DISCOUNT) || 0);
        totalCommission += Math.abs(Number(row.BILLING_PLATFORM_FEE) || 0) +
                           Math.abs(Number(row.BILLING_PLATFORM_FEE_TAX) || 0) +
                           Math.abs(Number(row.BILLING_PAYMENT_GATEWAY_FEE) || 0) +
                           Math.abs(Number(row.BILLING_PAYMENT_GATEWAY_FEE_TAX) || 0);
        totalOrders += 1;
      });

      filteredPayouts.forEach(row => totalPayouts += Number(row['Net Payout Amount']) || 0);
      filteredRefunds.forEach(row => totalRefund += Math.abs(Number(row.TOTAL_AMOUNT) || 0));

      // Use merchant data if no orders file is uploaded
      if (filteredOrders.length === 0) {
        totalOrders = filteredMerchants.reduce((sum, m) => sum + (m.orderCount || 0), 0);
        totalSales = filteredMerchants.reduce((sum, m) => sum + (m.revenue || 0), 0);
        totalDiscount = totalSales * DISCOUNT_RATE;
        totalCommission = totalSales * COMMISSION_RATE;
        totalRefund = filteredMerchants.reduce((sum, m) => sum + Math.abs(m.refunds || 0), 0);
        totalPayouts = filteredMerchants.reduce((sum, m) => sum + (m.payouts || 0), 0);
      }

      const netProfit = totalSales - totalDiscount - totalCommission - totalRefund;
      const netProfitRate = totalSales ? ((netProfit / totalSales) * 100).toFixed(2) : 0;

      document.getElementById('orderCount').textContent = totalOrders;
      document.getElementById('totalSales').textContent = totalSales.toFixed(2);
      document.getElementById('totalDiscount').textContent = totalDiscount.toFixed(2);
      document.getElementById('totalCommission').textContent = totalCommission.toFixed(2);
      document.getElementById('totalRefund').textContent = totalRefund.toFixed(2);
      document.getElementById('totalPayouts').textContent = totalPayouts.toFixed(2);
      document.getElementById('netProfit').textContent = netProfit.toFixed(2);
      document.getElementById('netProfitRate').textContent = netProfitRate;

      // Conditional styling for totalPayouts
      const payoutsCard = document.getElementById('payoutsCard');
      payoutsCard.classList.remove('negative', 'positive');
      if (totalPayouts < 0) {
        payoutsCard.classList.add('negative');
      } else {
        payoutsCard.classList.add('positive');
      }
    }

    function renderCharts() {
      // Summary Chart
      const summaryCtx = document.getElementById('summaryChart').getContext('2d');
      if (summaryChartInstance) {
        summaryChartInstance.destroy();
      }
      summaryChartInstance = new Chart(summaryCtx, {
        type: 'bar',
        data: {
          labels: ['Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 'Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª', 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª', 'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª', 'Ø§Ù„Ø¯ÙØ¹Ø§Øª', 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­'],
          datasets: [{
            label: 'AED',
            data: [
              parseFloat(document.getElementById('totalSales').textContent) || 0,
              parseFloat(document.getElementById('totalDiscount').textContent) || 0,
              parseFloat(document.getElementById('totalCommission').textContent) || 0,
              parseFloat(document.getElementById('totalRefund').textContent) || 0,
              parseFloat(document.getElementById('totalPayouts').textContent) || 0,
              parseFloat(document.getElementById('netProfit').textContent) || 0
            ],
            backgroundColor: ['#27ae60', '#e67e22', '#c0392b', '#8e44ad', '#16a085', '#2980b9']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // Branches Comparison Chart
      const branchesCtx = document.getElementById('branchesChart').getContext('2d');
      if (branchesChartInstance) {
        branchesChartInstance.destroy();
      }
      branchesChartInstance = new Chart(branchesCtx, {
        type: 'bar',
        data: {
          labels: filteredMerchants.map(m => m.MERCHANT_AREA || m.MERCHANT_ID),
          datasets: [
            {
              label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø±Ù‡Ù…)',
              data: filteredMerchants.map(m => m.revenue || 0),
              backgroundColor: '#27ae60'
            },
            {
              label: 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¯Ø±Ù‡Ù…)',
              data: filteredMerchants.map(m => {
                const discount = (m.revenue || 0) * DISCOUNT_RATE;
                const commission = (m.revenue || 0) * COMMISSION_RATE;
                return (m.revenue || 0) - discount - commission - Math.abs(m.refunds || 0);
              }),
              backgroundColor: '#2980b9'
            },
            {
              label: 'Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§ÙÙŠØ© (Ø¯Ø±Ù‡Ù…)',
              data: filteredMerchants.map(m => m.payouts || 0),
              backgroundColor: '#16a085'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function exportExcel() {
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(filteredMerchants.map(m => {
        const discount = (m.revenue || 0) * DISCOUNT_RATE;
        const commission = (m.revenue || 0) * COMMISSION_RATE;
        const netProfit = (m.revenue || 0) - discount - commission - Math.abs(m.refunds || 0);
        return {
          MERCHANT_ID: m.MERCHANT_ID,
          MERCHANT_NAME: m.MERCHANT_NAME,
          MERCHANT_AREA: m.MERCHANT_AREA,
          'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±': m.orderCount,
          'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø±Ù‡Ù…)': m.revenue,
          'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª (Ø¯Ø±Ù‡Ù…)': m.refunds,
          'Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª': m.revenue ? (Math.abs(m.refunds) / m.revenue * 100).toFixed(2) + '%' : '0%',
          'Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØµØ§ÙÙŠØ© (Ø¯Ø±Ù‡Ù…)': m.payouts,
          'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¯Ø±Ù‡Ù…)': netProfit.toFixed(2)
        };
      }));
      const ws2 = XLSX.utils.json_to_sheet(filteredPayouts.map(p => ({
        'Billable ID': p['Billable ID'],
        'Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„ØµØ§ÙÙŠØ© (Ø¯Ø±Ù‡Ù…)': Number(p['Net Payout Amount'] || 0).toFixed(2),
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': p['Start Date'],
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': p['End Date']
      })));
      const today = new Date().toISOString().split('T')[0];
      XLSX.utils.book_append_sheet(wb, ws1, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹');
      XLSX.utils.book_append_sheet(wb, ws2, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª');
      XLSX.writeFile(wb, `restaurant_revenue_report_${today}.xlsx`);
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      const today = new Date().toISOString().split('T')[0];
      doc.text(`ØªÙ‚Ø±ÙŠØ± Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù… (${today})`, 10, 15);
      doc.setFontSize(12);
      doc.text(`Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±: ${document.getElementById('orderCount').textContent}`, 10, 30);
      doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${document.getElementById('totalSales').textContent} AED`, 10, 40);
      doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: ${document.getElementById('totalDiscount').textContent} AED`, 10, 50);
      doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª: ${document.getElementById('totalCommission').textContent} AED`, 10, 60);
      doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª: ${document.getElementById('totalRefund').textContent} AED`, 10, 70);
      doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª: ${document.getElementById('totalPayouts').textContent} AED`, 10, 80);
      doc.text(`ğŸ’° ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${document.getElementById('netProfit').textContent} AED`, 10, 90);
      doc.text(`ğŸ“ˆ Ù†Ø³Ø¨Ø© ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${document.getElementById('netProfitRate').textContent}%`, 10, 100);
      doc.text('ØªÙ†Ø¨ÙŠÙ‡Ø§Øª:', 10, 110);
      const alertsText = document.getElementById('alerts').textContent;
      doc.text(alertsText, 10, 120, { maxWidth: 190 });

      // Add branches table
      doc.addPage();
      doc.setFontSize(14);
      doc.text('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹', 10, 15);
      let y = 25;
      doc.setFontSize(10);
      const branchHeaders = ['MERCHANT_ID', 'Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹', 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±', 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 'Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª', 'Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª', 'Ø§Ù„Ø¯ÙØ¹Ø§Øª', 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­'];
      branchHeaders.forEach((header, i) => {
        doc.text(header, 10 + i * 22, y);
      });
      y += 10;
      filteredMerchants.forEach(m => {
        const discount = (m.revenue || 0) * DISCOUNT_RATE;
        const commission = (m.revenue || 0) * COMMISSION_RATE;
        const netProfit = (m.revenue || 0) - discount - commission - Math.abs(m.refunds || 0);
        const row = [
          m.MERCHANT_ID || '',
          m.MERCHANT_NAME || '',
          m.MERCHANT_AREA || '',
          m.orderCount || 0,
          Number(m.revenue || 0).toFixed(2),
          Number(m.refunds || 0).toFixed(2),
          m.revenue ? (Math.abs(m.refunds) / m.revenue * 100).toFixed(2) + '%' : '0%',
          Number(m.payouts || 0).toFixed(2),
          netProfit.toFixed(2)
        ];
        row.forEach((cell, i) => {
          doc.text(cell.toString(), 10 + i * 22, y);
        });
        y += 10;
        if (y > 280) {
          doc.addPage();
          y = 25;
        }
      });

      // Add payouts table
      doc.addPage();
      doc.setFontSize(14);
      doc.text('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª', 10, 15);
      y = 25;
      doc.setFontSize(10);
      const payoutHeaders = ['Billable ID', 'Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„ØµØ§ÙÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'];
      payoutHeaders.forEach((header, i) => {
        doc.text(header, 10 + i * 50, y);
      });
      y += 10;
      filteredPayouts.forEach(p => {
        const row = [
          p['Billable ID'] || '',
          Number(p['Net Payout Amount'] || 0).toFixed(2),
          p['Start Date'] || '',
          p['End Date'] || ''
        ];
        row.forEach((cell, i) => {
          doc.text(cell.toString(), 10 + i * 50, y);
        });
        y += 10;
        if (y > 280) {
          doc.addPage();
          y = 25;
        }
      });

      doc.save(`restaurant_revenue_report_${today}.pdf`);
    }
  </script>
</body>
</html>
