<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crispy Chicken – Executive Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #fafafa; font-family: 'Arial', sans-serif; }
    .kpi-card { background: white; border-radius: 1rem; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .branch-card { background: #fff8f5; border-radius: 1rem; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .notes-panel textarea { width: 100%; min-height: 60px; border: 1px solid #ddd; border-radius: 0.5rem; padding: 0.5rem; font-size: 0.9rem; }
    .btn { background: #e63946; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; }
    .btn:hover { background: #c92c3c; }
  </style>
</head>
<body>
  <div id="dashboard" class="p-6 space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold text-red-700">🍗 Crispy Chicken – Executive Dashboard</h1>
      <div class="flex space-x-3">
        <input id="dateRange" type="text" placeholder="Select date range" class="border rounded p-2" />
        <button id="exportPDF" class="btn">📑 Export PDF</button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-4 gap-4">
      <div class="kpi-card"><h2 class="text-lg font-semibold">Total Sales</h2><p id="kpiSales" class="text-2xl font-bold text-red-600">-</p></div>
      <div class="kpi-card"><h2 class="text-lg font-semibold">Total Orders</h2><p id="kpiOrders" class="text-2xl font-bold text-red-600">-</p></div>
      <div class="kpi-card"><h2 class="text-lg font-semibold">Delivery %</h2><p id="kpiDelivery" class="text-2xl font-bold text-red-600">-</p></div>
      <div class="kpi-card"><h2 class="text-lg font-semibold">Top Branch</h2><p id="kpiBranch" class="text-2xl font-bold text-red-600">-</p></div>
    </div>

    <!-- Branch Cards -->
    <div id="branchCards" class="grid grid-cols-2 gap-4"></div>

    <!-- Charts -->
    <div class="grid grid-cols-2 gap-6">
      <canvas id="barChart"></canvas>
      <canvas id="lineChart"></canvas>
      <canvas id="pieChart"></canvas>
      <canvas id="heatmapChart"></canvas>
    </div>

    <!-- Raw Data Table -->
    <div>
      <h2 class="text-xl font-bold mb-2">Raw Data</h2>
      <table id="dataTable" class="w-full border text-sm">
        <thead class="bg-red-600 text-white">
          <tr><th>Date</th><th>Branch</th><th>Sales</th><th>Orders</th><th>Delivery</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="addSampleData()" class="btn mt-3">➕ Add Sample Data</button>
    </div>
  </div>

<script>
  // --- Sample Dataset ---
  let salesData = [
    {date:"2025-09-01", branch:"Dubai", sales:1200, orders:100, delivery:60},
    {date:"2025-09-02", branch:"Abu Dhabi", sales:800, orders:70, delivery:40},
    {date:"2025-09-03", branch:"Sharjah", sales:600, orders:50, delivery:20}
  ];

  // --- Init Date Picker ---
  flatpickr("#dateRange", {
    mode:"range", dateFormat:"Y-m-d",
    onClose: (dates) => updateDashboard(dates)
  });

  // --- Export PDF ---
  document.getElementById("exportPDF").addEventListener("click", () => {
    const element = document.getElementById("dashboard");
    const opt = { margin:0.5, filename:"CrispyChicken_Report.pdf", image:{type:"jpeg",quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:"in",format:"letter",orientation:"landscape"} };
    html2pdf().from(element).set(opt).save();
  });

  // --- Branch Notes Persistence ---
  function loadNotes() {
    document.querySelectorAll('.notes-panel textarea').forEach((area, i) => {
      area.value = localStorage.getItem(`branchNotes${i}`) || "";
      area.addEventListener('input', () => localStorage.setItem(`branchNotes${i}`, area.value));
    });
  }

  // --- Dashboard Update ---
  function updateDashboard(dates=null) {
    let filtered = [...salesData];
    if (dates && dates.length === 2) {
      let [start,end] = dates;
      filtered = salesData.filter(r => {
        let d = new Date(r.date);
        return d >= start && d <= end;
      });
    }

    // KPIs
    let totalSales = filtered.reduce((a,b)=>a+b.sales,0);
    let totalOrders = filtered.reduce((a,b)=>a+b.orders,0);
    let deliveryOrders = filtered.reduce((a,b)=>a+b.delivery,0);
    let deliveryPct = totalOrders? ((deliveryOrders/totalOrders)*100).toFixed(1):0;
    let topBranch = Object.entries(filtered.reduce((acc,r)=>{acc[r.branch]=(acc[r.branch]||0)+r.sales; return acc;},{}))
      .sort((a,b)=>b[1]-a[1])[0];
    document.getElementById("kpiSales").textContent = "AED "+totalSales.toLocaleString();
    document.getElementById("kpiOrders").textContent = totalOrders;
    document.getElementById("kpiDelivery").textContent = deliveryPct+"%";
    document.getElementById("kpiBranch").textContent = topBranch? topBranch[0]:"-";

    // Branch Cards
    let branches = [...new Set(filtered.map(r=>r.branch))];
    let container = document.getElementById("branchCards");
    container.innerHTML = "";
    branches.forEach((br,i)=>{
      let sales = filtered.filter(r=>r.branch===br).reduce((a,b)=>a+b.sales,0);
      let orders = filtered.filter(r=>r.branch===br).reduce((a,b)=>a+b.orders,0);
      container.innerHTML += `
        <div class="branch-card">
          <h3 class="font-bold text-lg mb-1">🏪 ${br}</h3>
          <p>💰 Sales: AED ${sales}</p>
          <p>📦 Orders: ${orders}</p>
          <div class="notes-panel mt-2">
            <textarea placeholder="Manager notes for ${br}..."></textarea>
          </div>
        </div>`;
    });
    loadNotes();

    // Table
    let tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    filtered.forEach(r=>{
      tbody.innerHTML += `<tr class="border-b"><td>${r.date}</td><td>${r.branch}</td><td>${r.sales}</td><td>${r.orders}</td><td>${r.delivery}</td></tr>`;
    });

    // Charts
    renderCharts(filtered);
  }

  // --- Add Data ---
  function addSampleData() {
    let newRecord = {date:"2025-09-05", branch:"Dubai", sales:900, orders:80, delivery:45};
    salesData.push(newRecord);
    const picker = document.querySelector("#dateRange")._flatpickr;
    let dates = picker && picker.selectedDates;
    updateDashboard(dates && dates.length===2? dates:null);
  }

  // --- Charts ---
  let charts={};
  function renderCharts(data) {
    let ctxs = {bar:"barChart", line:"lineChart", pie:"pieChart", heat:"heatmapChart"};
    Object.values(ctxs).forEach(id=>{ if(charts[id]) charts[id].destroy(); });
    // Bar
    charts.barChart = new Chart(document.getElementById("barChart"), {
      type:"bar",
      data:{ labels:[...new Set(data.map(r=>r.branch))], datasets:[{ label:"Sales", data:Object.values(data.reduce((a,r)=>{a[r.branch]=(a[r.branch]||0)+r.sales;return a;},{})), backgroundColor:"#e63946"}] }
    });
    // Line
    charts.lineChart = new Chart(document.getElementById("lineChart"), {
      type:"line",
      data:{ labels:data.map(r=>r.date), datasets:[{ label:"Sales", data:data.map(r=>r.sales), borderColor:"#f4a261", fill:false }] }
    });
    // Pie
    charts.pieChart = new Chart(document.getElementById("pieChart"), {
      type:"pie",
      data:{ labels:[...new Set(data.map(r=>r.branch))], datasets:[{ data:Object.values(data.reduce((a,r)=>{a[r.branch]=(a[r.branch]||0)+r.sales;return a;},{})), backgroundColor:["#e63946","#f4a261","#2a9d8f"]}] }
    });
    // Heatmap (fake as stacked bar for simplicity)
    charts.heatmapChart = new Chart(document.getElementById("heatmapChart"), {
      type:"bar",
      data:{ labels:data.map(r=>r.date), datasets:[{ label:"Delivery", data:data.map(r=>r.delivery), backgroundColor:"#264653"}] }
    });
  }

  // Init
  updateDashboard();
</script>
</body>
</html>
